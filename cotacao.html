<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerar Cotações • LICITAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --p:#0b1e39;
  --p2:#102742;
  --bg:#eef2f7;
  --card:#ffffff;
  --border:#d6d9e0;
  --radius:14px;
  --shadow:0 6px 16px rgba(0,0,0,.08);
}

*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:var(--bg);padding:25px}

h1{font-size:28px;font-weight:800;color:var(--p)}

.header-sub{
  color:#555;
  margin-bottom:20px;
}

input{
  padding:12px;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:14px;
  width:100%;
}

.btn{
  padding:12px 22px;
  border-radius:12px;
  border:none;
  font-weight:600;
  cursor:pointer;
  background:var(--p);
  color:white;
}
.btn:hover{background:var(--p2)}

.cards{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:20px;
}

.card{
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  border:1px solid var(--border);
  padding:18px;
  cursor:pointer;
  transition:.2s;
}
.card:hover{transform:translateY(-4px)}

.card-title{font-weight:700;color:var(--p)}
.card-info{font-size:13px;margin-top:6px}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  justify-content:center;
  align-items:flex-start;
  padding-top:30px;
  z-index:999;
}

.modal-box{
  background:white;
  width:95%;
  max-width:1200px;
  border-radius:16px;
  padding:25px;
  max-height:85vh;
  overflow:auto;
}

.modal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

.btn-close{
  font-size:28px;
  cursor:pointer;
  color:#555;
}
.btn-close:hover{color:var(--p)}

.item-card{
  display:grid;
  grid-template-columns:40px 1fr;
  gap:15px;
  padding:14px;
  border-bottom:1px solid #eee;
}

.item-card:hover{background:#f7f9fc}

.item-title{
  font-weight:700;
  margin-bottom:4px;
}

.item-desc{
  font-size:14px;
  color:#333;
}

.item-meta{
  font-size:12px;
  color:#555;
  margin-top:6px;
}

#overlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.85);
  display:none;
  justify-content:center;
  align-items:center;
  font-size:22px;
  font-weight:700;
  color:var(--p);
  z-index:2000;
}
</style>
</head>

<body>

<h1>Gerar Cotações</h1>
<div class="header-sub">Selecione uma licitação para enviar aos fornecedores</div>

<input id="buscaLic" placeholder="Pesquisar licitação..." oninput="filtrarLic()">

<div class="cards" id="listaLic"></div>

<!-- MODAL ITENS -->
<div class="modal" id="modalItens">
  <div class="modal-box">
    <div class="modal-header">
      <div>
        <h2 id="tituloLic"></h2>
        <div class="header-sub" id="empresaLic"></div>
      </div>
      <div class="btn-close" onclick="fecharItens()">×</div>
    </div>

    <input id="buscaItem" placeholder="Pesquisar item..." oninput="filtrarItens()">

    <div id="listaItens"></div>

    <div style="margin-top:20px;text-align:right">
      <button class="btn" onclick="abrirFornecedores()">Selecionar Fornecedores</button>
    </div>
  </div>
</div>

<div id="overlay">Processando...</div>

<script>
const sb = supabase.createClient(
  "https://mblvyircwsaxaslklzky.supabase.co",
  "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x"
);

let licCache=[], itemCache=[];
let licSelecionada=null;
let itensMarcados=new Set();

async function carregarLic(){
  const {data,error} = await sb
    .from("licitacoes")
    .select("id,codigo,modo,empresa_id,empresas(nome)")
    .order("id",{ascending:false});

  if(error) return alert(error.message);
  licCache=data||[];
  renderLic(licCache);
}

function renderLic(arr){
  listaLic.innerHTML="";
  arr.forEach(l=>{
    listaLic.innerHTML+=`
      <div class="card" onclick="abrirItens(${l.id},'${l.codigo}','${l.empresas?.nome ?? ""}')">
        <div class="card-title">${l.codigo}</div>
        <div class="card-info">${l.modo}</div>
        <div class="card-info"><b>${l.empresas?.nome ?? ""}</b></div>
      </div>`;
  });
}

function filtrarLic(){
  let t=buscaLic.value.toLowerCase();
  renderLic(
    licCache.filter(l =>
      l.codigo.toLowerCase().includes(t) ||
      (l.empresas?.nome || "").toLowerCase().includes(t)
    )
  );
}

async function abrirItens(id,cod,empresa){
  licSelecionada=id;
  itensMarcados.clear();

  tituloLic.innerText=`Licitação ${cod}`;
  empresaLic.innerText=`Empresa Licitante: ${empresa}`;

  modalItens.style.display="flex";

  const {data,error} = await sb
    .from("licitacoes_itens")
    .select("id,item_tr,especificacao,quant_min,quant_max,valor_unit")
    .eq("licitacao_id",id)
    .order("ordem");

  if(error) return alert(error.message);
  itemCache=data||[];
  renderItens(itemCache);
}

function renderItens(arr){
  listaItens.innerHTML="";
  arr.forEach(i=>{
    listaItens.innerHTML+=`
      <div class="item-card">
        <input type="checkbox" onchange="toggleItem(${i.id},this.checked)">
        <div>
          <div class="item-title">${i.item_tr}</div>
          <div class="item-desc">${i.especificacao}</div>
          <div class="item-meta">
            Min ${i.quant_min} |
            Máx ${i.quant_max ?? "-"} |
            Valor ${i.valor_unit ?? "-"}
          </div>
        </div>
      </div>`;
  });
}

function toggleItem(id,v){
  v ? itensMarcados.add(id) : itensMarcados.delete(id);
}

function filtrarItens(){
  let t=buscaItem.value.toLowerCase();
  renderItens(
    itemCache.filter(i =>
      i.item_tr.toLowerCase().includes(t) ||
      i.especificacao.toLowerCase().includes(t)
    )
  );
}

function fecharItens(){modalItens.style.display="none"}

carregarLic();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cotação • Fornecedor</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  font-family:Inter;
  background:#eef2f7;
  padding:30px;
}
.card{
  background:#fff;
  border-radius:14px;
  padding:20px;
  max-width:900px;
  margin:auto;
  box-shadow:0 6px 14px rgba(0,0,0,.1);
}
h2{color:#0b1e39}
input{
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
  width:100%;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}
th,td{
  padding:10px;
  border-bottom:1px solid #ddd;
}
button{
  padding:10px 18px;
  background:#0b1e39;
  color:#fff;
  border:none;
  border-radius:10px;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="card" id="loginBox">
  <h2>Login do Fornecedor</h2>
  <input id="cnpj" placeholder="CNPJ">
  <input id="senha" placeholder="Senha" type="password" style="margin-top:10px">
  <button onclick="login()" style="margin-top:15px">Entrar</button>
</div>

<div class="card" id="cotacaoBox" style="display:none">
  <h2>Licitações Disponíveis</h2>
  <select id="licitacoes" onchange="carregarItens()"></select>

  <table>
    <thead>
      <tr>
        <th>Produto</th>
        <th>Descrição</th>
        <th>Qtd Mín</th>
        <th>Valor Unit</th>
        <th>Ação</th>
      </tr>
    </thead>
    <tbody id="itens"></tbody>
  </table>
</div>

<script>
const sb = supabase.createClient(
  "https://mblvyircwsaxaslklzky.supabase.co",
  "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x"
);

let fornecedor = null;

async function login(){
  let cnpj = document.getElementById("cnpj").value;
  let senha = document.getElementById("senha").value;

  if(senha !== cnpj.substring(0,4)){
    return alert("Senha inválida");
  }

  let {data} = await sb.from("empresas")
    .select("*")
    .eq("cnpj", cnpj)
    .eq("tipo","FORNECEDOR")
    .single();

  if(!data) return alert("Fornecedor não encontrado");

  fornecedor = data;
  loginBox.style.display="none";
  cotacaoBox.style.display="block";

  carregarLicitacoes();
}

async function carregarLicitacoes(){
  let {data} = await sb.from("licitacoes")
    .select("id,codigo")
    .eq("status","EM ANDAMENTO");

  licitacoes.innerHTML = data.map(l =>
    `<option value="${l.id}">${l.codigo}</option>`
  ).join("");

  carregarItens();
}

async function carregarItens(){
  let lic = licitacoes.value;

  let {data} = await sb.from("licitacoes_itens")
    .select("id,item_tr,especificacao,quant_min")
    .eq("licitacao_id", lic);

  itens.innerHTML = data.map(i => `
    <tr>
      <td>${i.item_tr}</td>
      <td>${i.especificacao}</td>
      <td>${i.quant_min}</td>
      <td>
        <input type="number" id="v${i.id}" placeholder="0,00">
      </td>
      <td>
        <button onclick="salvar(${i.id})">Salvar</button>
      </td>
    </tr>
  `).join("");
}

async function salvar(itemId){
  let valor = document.getElementById("v"+itemId).value;
  if(!valor) return alert("Informe o valor");

  await sb.from("cotacoes")
    .upsert([{
      licitacao_id: licitacoes.value,
      item_id: itemId,
      fornecedor_id: fornecedor.id,
      valor_unit: valor
    }]);

  alert("Cotação salva!");
}
</script>

</body>
</html>

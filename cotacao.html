<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerar Cotações • LICITAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --p:#0b1e39;
  --p2:#102742;
  --bg:#eef2f7;
  --card:#fff;
  --border:#d6d9e0;
  --radius:12px;
}

*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:var(--bg);padding:20px}

h1{font-size:22px;color:var(--p);margin-bottom:10px}
.sub{font-size:13px;color:#555;margin-bottom:15px}

input{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid var(--border);
  font-size:13px;
}

.btn{
  padding:10px 16px;
  border-radius:8px;
  border:none;
  background:var(--p);
  color:white;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
}
.btn:hover{background:var(--p2)}

.grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:12px;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:10px;
  padding:12px;
  cursor:pointer;
}
.card:hover{background:#f8faff}

.card b{font-size:13px;color:var(--p)}
.card div{font-size:12px;color:#555;margin-top:3px}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  justify-content:center;
  align-items:flex-start;
  padding-top:25px;
  z-index:999;
}

.box{
  background:white;
  width:95%;
  max-width:1100px;
  border-radius:12px;
  padding:16px;
  max-height:85vh;
  overflow:auto;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.close{
  font-size:22px;
  cursor:pointer;
  color:#777;
}
.close:hover{color:#000}

.item{
  display:grid;
  grid-template-columns:24px 1fr;
  gap:10px;
  padding:10px 0;
  border-bottom:1px solid #eee;
}

.item b{font-size:13px}
.item small{font-size:12px;color:#555}

#overlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.85);
  display:none;
  justify-content:center;
  align-items:center;
  font-size:18px;
  font-weight:600;
  color:var(--p);
  z-index:2000;
}
</style>
</head>

<body>

<h1>Gerar Cotações</h1>
<div class="sub">Selecione a licitação e os itens para enviar aos fornecedores</div>

<input id="buscaLic" placeholder="Pesquisar licitação..." oninput="filtrarLic()">

<div class="grid" id="listaLic"></div>

<!-- MODAL ITENS -->
<div class="modal" id="modalItens">
  <div class="box">
    <div class="header">
      <div>
        <b id="tituloLic"></b><br>
        <small id="empresaLic"></small>
      </div>
      <div class="close" onclick="fecharItens()">×</div>
    </div>

    <input id="buscaItem" placeholder="Pesquisar item..." oninput="filtrarItens()" style="margin:10px 0">

    <div id="listaItens"></div>

    <div style="text-align:right;margin-top:10px">
      <button class="btn" onclick="abrirFornecedores()">Selecionar Fornecedores</button>
    </div>
  </div>
</div>

<!-- MODAL FORNECEDORES -->
<div class="modal" id="modalFor">
  <div class="box">
    <div class="header">
      <b>Selecionar Fornecedores</b>
      <div class="close" onclick="fecharFor()">×</div>
    </div>

    <input id="buscaFor" placeholder="Pesquisar fornecedor..." oninput="filtrarFor()" style="margin:10px 0">

    <div id="listaFor"></div>

    <div style="text-align:right;margin-top:12px">
      <button class="btn" onclick="confirmarEnvio()">Confirmar Envio</button>
    </div>
  </div>
</div>

<div id="overlay">Processando...</div>

<script>
const sb = supabase.createClient(
  "https://mblvyircwsaxaslklzky.supabase.co",
  "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x"
);

let licCache=[], itemCache=[], forCache=[];
let licId=null;
let itensSel=new Set();
let forSel=new Set();

/* LICITAÇÕES */
async function carregarLic(){
  const {data} = await sb
    .from("licitacoes")
    .select("id,codigo,modo,empresas(nome)")
    .order("id",{ascending:false});
  licCache=data||[];
  renderLic(licCache);
}

function renderLic(arr){
  listaLic.innerHTML="";
  arr.forEach(l=>{
    listaLic.innerHTML+=`
      <div class="card" onclick="abrirItens(${l.id},'${l.codigo}','${l.empresas?.nome||""}')">
        <b>${l.codigo}</b>
        <div>${l.modo}</div>
        <div>${l.empresas?.nome||""}</div>
      </div>`;
  });
}

function filtrarLic(){
  let t=buscaLic.value.toLowerCase();
  renderLic(licCache.filter(l =>
    l.codigo.toLowerCase().includes(t) ||
    (l.empresas?.nome||"").toLowerCase().includes(t)
  ));
}

/* ITENS */
async function abrirItens(id,cod,emp){
  licId=id;
  itensSel.clear();
  tituloLic.innerText=`Licitação ${cod}`;
  empresaLic.innerText=emp;
  modalItens.style.display="flex";

  const {data} = await sb
    .from("licitacoes_itens")
    .select("id,item_tr,especificacao,quant_min,quant_max,valor_unit")
    .eq("licitacao_id",id);

  itemCache=data||[];
  renderItens(itemCache);
}

function renderItens(arr){
  listaItens.innerHTML="";
  arr.forEach(i=>{
    listaItens.innerHTML+=`
      <div class="item">
        <input type="checkbox" onchange="toggleItem(${i.id},this.checked)">
        <div>
          <b>${i.item_tr}</b><br>
          <small>${i.especificacao}</small><br>
          <small>Min ${i.quant_min} | Máx ${i.quant_max} | ${i.valor_unit}</small>
        </div>
      </div>`;
  });
}

function toggleItem(id,v){
  v ? itensSel.add(id) : itensSel.delete(id);
}

function filtrarItens(){
  let t=buscaItem.value.toLowerCase();
  renderItens(itemCache.filter(i =>
    i.item_tr.toLowerCase().includes(t) ||
    i.especificacao.toLowerCase().includes(t)
  ));
}

function fecharItens(){modalItens.style.display="none"}

/* FORNECEDORES */
async function abrirFornecedores(){
  modalFor.style.display="flex";
  listaFor.innerHTML="";
  forSel.clear();

  const {data} = await sb
    .from("empresas")
    .select("id,nome")
    .in("tipo",["fornecedor","ambas"]);

  forCache=data||[];
}

function filtrarFor(){
  let t=buscaFor.value.toLowerCase().trim();
  if(t.length<2){listaFor.innerHTML="";return;}

  listaFor.innerHTML="";
  forCache.filter(f=>f.nome.toLowerCase().includes(t))
    .forEach(f=>{
      listaFor.innerHTML+=`
        <div class="item">
          <input type="checkbox" onchange="toggleFor(${f.id},this.checked)">
          <div>${f.nome}</div>
        </div>`;
    });
}

function toggleFor(id,v){
  v ? forSel.add(id) : forSel.delete(id);
}

function fecharFor(){modalFor.style.display="none"}

/* ENVIO */
async function confirmarEnvio(){
  if(!itensSel.size || !forSel.size){
    alert("Selecione itens e fornecedores");
    return;
  }

  overlay.style.display="flex";

  try{
    for(let f of forSel){
      const {error} = await sb.from("cotacoes")
        .insert({licitacao_id:licId, fornecedor_id:f});

      if(error) throw error;
    }

    alert("Cotação enviada com sucesso!");
    fecharFor();
    fecharItens();
  }catch(e){
    alert("Erro:\n"+e.message);
  }

  overlay.style.display="none";
}

carregarLic();
</script>

</body>
</html>

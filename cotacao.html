<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Criar Cotações • Painel Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --p:#0b1e39;
  --bg:#eef2f7;
  --card:#fff;
  --border:#d6d9e0;
  --radius:14px;
  --shadow:0 6px 14px rgba(0,0,0,.08);
}

*{box-sizing:border-box;font-family:Inter}
body{background:var(--bg);padding:30px}

.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:20px;
  box-shadow:var(--shadow);
  margin-bottom:20px;
}

h2{color:var(--p);margin-bottom:10px}

table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  border-bottom:1px solid var(--border);
  font-size:14px;
}
th{background:#f3f6fb}

.btn{
  padding:10px 18px;
  background:var(--p);
  color:#fff;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
}
.btn-sec{background:#777}

.checkbox{
  width:18px;
  height:18px;
}
</style>
</head>

<body>

<div class="card">
  <h2>Selecionar Licitação</h2>
  <select id="licitacoes" onchange="carregarItens()"></select>
</div>

<div class="card">
  <h2>
    Itens para Cotação
    <input type="checkbox" id="checkAll" onclick="selecionarTodos()"> Selecionar todos
  </h2>

  <table>
    <thead>
      <tr>
        <th></th>
        <th>Item</th>
        <th>Descrição</th>
        <th>Qtd Mín</th>
      </tr>
    </thead>
    <tbody id="itens"></tbody>
  </table>
</div>

<div class="card">
  <h2>Selecionar Fornecedores</h2>
  <div id="fornecedores"></div>
</div>

<div class="card" style="text-align:right">
  <button class="btn-sec btn" onclick="location.reload()">Cancelar</button>
  <button class="btn" onclick="gerarCotacoes()">Gerar Cotações</button>
</div>

<script>
const sb = supabase.createClient(
  "https://mblvyircwsaxaslklzky.supabase.co",
  "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x"
);

let itensCache = [];
let fornecedoresCache = [];

/* =============================
   INIT
============================= */
carregarLicitacoes();
carregarFornecedores();

/* =============================
   LICITAÇÕES
============================= */
async function carregarLicitacoes(){
  let {data} = await sb.from("licitacoes")
    .select("id,codigo")
    .eq("status","EM ANDAMENTO");

  licitacoes.innerHTML = data.map(l =>
    `<option value="${l.id}">${l.codigo}</option>`
  ).join("");

  carregarItens();
}

/* =============================
   ITENS
============================= */
async function carregarItens(){
  let lic = licitacoes.value;

  let {data} = await sb.from("licitacoes_itens")
    .select("id,item_tr,especificacao,quant_min")
    .eq("licitacao_id", lic);

  itensCache = data;

  itens.innerHTML = data.map(i => `
    <tr>
      <td><input type="checkbox" class="chkItem" value="${i.id}"></td>
      <td>${i.item_tr}</td>
      <td>${i.especificacao}</td>
      <td>${i.quant_min}</td>
    </tr>
  `).join("");
}

/* =============================
   FORNECEDORES
============================= */
async function carregarFornecedores(){
  let {data} = await sb.from("empresas")
    .select("id,nome")
    .eq("tipo","FORNECEDOR");

  fornecedoresCache = data;

  fornecedores.innerHTML = data.map(f => `
    <div>
      <input type="checkbox" class="chkFornecedor" value="${f.id}">
      ${f.nome}
    </div>
  `).join("");
}

/* =============================
   SELECIONAR TODOS
============================= */
function selecionarTodos(){
  let v = checkAll.checked;
  document.querySelectorAll(".chkItem").forEach(c => c.checked = v);
}

/* =============================
   GERAR COTAÇÕES
============================= */
async function gerarCotacoes(){
  let itensSel = [...document.querySelectorAll(".chkItem:checked")].map(c => Number(c.value));
  let fornSel = [...document.querySelectorAll(".chkFornecedor:checked")].map(c => Number(c.value));

  if(itensSel.length === 0) return alert("Selecione ao menos um item");
  if(fornSel.length === 0) return alert("Selecione ao menos um fornecedor");

  let lic = Number(licitacoes.value);

  for(let fornecedor of fornSel){

    // 1️⃣ cria cotação (card)
    let {data:cot} = await sb.from("cotacoes")
      .insert([{ licitacao_id: lic, fornecedor_id: fornecedor }])
      .select()
      .single();

    // 2️⃣ cria itens da cotação
    let payload = itensSel.map(item => ({
      cotacao_id: cot.id,
      item_id: item
    }));

    await sb.from("cotacoes_itens").insert(payload);
  }

  alert("Cotações geradas com sucesso!");
  location.reload();
}
</script>

</body>
</html>

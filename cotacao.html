<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cotações • Painel Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --p:#0b1e39;
  --p2:#102742;
  --bg:#eef2f7;
  --card:#fff;
  --border:#d6d9e0;
  --radius:14px;
  --shadow:0 6px 16px rgba(0,0,0,.08);
}

*{margin:0;padding:0;box-sizing:border-box;font-family:Inter}

body{background:var(--bg);padding:25px}

h1{font-size:28px;font-weight:800;color:var(--p);margin-bottom:20px}

input{
  padding:12px;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:14px;
}

.btn{
  padding:12px 20px;
  border-radius:12px;
  border:none;
  font-weight:600;
  cursor:pointer;
  background:var(--p);
  color:white;
}

.btn:hover{background:var(--p2)}

.cards{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:20px;
}

.card{
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  border:1px solid var(--border);
  padding:18px;
  cursor:pointer;
  transition:.2s;
}

.card:hover{transform:translateY(-4px)}

.card-title{font-weight:700;color:var(--p)}
.card-info{font-size:13px;margin-top:6px}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  justify-content:center;
  align-items:flex-start;
  padding-top:30px;
  z-index:999;
}

.modal-box{
  background:white;
  width:90%;
  max-width:1200px;
  border-radius:16px;
  padding:25px;
  max-height:85vh;
  overflow:auto;
}

.modal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px;
}

.btn-close{
  font-size:28px;
  cursor:pointer;
  color:#555;
}

.btn-close:hover{color:var(--p)}

.list{
  margin-top:15px;
}

.item-row{
  display:flex;
  gap:10px;
  align-items:flex-start;
  padding:10px;
  border-bottom:1px solid #eee;
}

.item-row input{margin-top:6px}

small{color:#555}

#overlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.85);
  display:none;
  justify-content:center;
  align-items:center;
  font-size:22px;
  font-weight:700;
  color:var(--p);
  z-index:2000;
}
</style>
</head>

<body>

<h1>Gerar Cotações</h1>

<input id="buscaLic" placeholder="Pesquisar licitação..." oninput="filtrarLic()">

<div class="cards" id="listaLic"></div>

<!-- MODAL ITENS -->
<div class="modal" id="modalItens">
  <div class="modal-box">
    <div class="modal-header">
      <h2 id="tituloLic"></h2>
      <div class="btn-close" onclick="fecharItens()">×</div>
    </div>

    <input id="buscaItem" placeholder="Pesquisar item..." oninput="filtrarItens()">

    <div class="list" id="listaItens"></div>

    <div style="margin-top:20px;text-align:right">
      <button class="btn" onclick="abrirFornecedores()">Selecionar Fornecedores</button>
    </div>
  </div>
</div>

<!-- MODAL FORNECEDORES -->
<div class="modal" id="modalFor">
  <div class="modal-box">
    <div class="modal-header">
      <h2>Selecionar Fornecedores</h2>
      <div class="btn-close" onclick="fecharFor()">×</div>
    </div>

    <input id="buscaFor" placeholder="Pesquisar fornecedor..." oninput="filtrarFor()">

    <div class="list" id="listaFor"></div>

    <div id="resumo" style="margin-top:15px"></div>

    <div style="margin-top:20px;text-align:right">
      <button class="btn" onclick="confirmarEnvio()">Confirmar Envio</button>
    </div>
  </div>
</div>

<div id="overlay">Enviando cotação...</div>

<script>
const sb = supabase.createClient(
  "https://mblvyircwsaxaslklzky.supabase.co",
  "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x"
);

let licCache=[], itemCache=[], forCache=[];
let licSelecionada=null;
let itensMarcados=new Set();
let fornecedoresMarcados=new Set();

async function carregarLic(){
  const {data}=await sb.from("licitacoes")
    .select("id,codigo,modo,data_sessao")
    .order("id",{ascending:false});
  licCache=data||[];
  renderLic(data);
}

function renderLic(arr){
  listaLic.innerHTML="";
  arr.forEach(l=>{
    listaLic.innerHTML+=`
      <div class="card" onclick="abrirItens(${l.id},'${l.codigo}')">
        <div class="card-title">${l.codigo}</div>
        <div class="card-info">${l.modo}</div>
      </div>
    `;
  });
}

function filtrarLic(){
  let t=buscaLic.value.toLowerCase();
  renderLic(licCache.filter(l=>l.codigo.toLowerCase().includes(t)));
}

async function abrirItens(id,cod){
  licSelecionada=id;
  tituloLic.innerText=`Licitação ${cod}`;
  modalItens.style.display="flex";

  const {data}=await sb.from("licitacoes_itens")
    .select("id,item_tr,especificacao,quant_min,quant_max,valor_unit")
    .eq("licitacao_id",id)
    .order("ordem");

  itemCache=data||[];
  renderItens(itemCache);
}

function renderItens(arr){
  listaItens.innerHTML="";
  arr.forEach(i=>{
    listaItens.innerHTML+=`
      <div class="item-row">
        <input type="checkbox" ${itensMarcados.has(i.id)?"checked":""}
          onchange="toggleItem(${i.id},this.checked)">
        <div>
          <b>${i.item_tr}</b><br>
          ${i.especificacao}<br>
          <small>Min: ${i.quant_min} | Máx: ${i.quant_max||"-"} | Valor: ${i.valor_unit||"-"}</small>
        </div>
      </div>
    `;
  });
}

function toggleItem(id,v){
  v?itensMarcados.add(id):itensMarcados.delete(id);
}

function filtrarItens(){
  let t=buscaItem.value.toLowerCase();
  renderItens(itemCache.filter(i=>
    i.item_tr.toLowerCase().includes(t)||
    i.especificacao.toLowerCase().includes(t)
  ));
}

async function abrirFornecedores(){
  modalFor.style.display="flex";

  const {data}=await sb.from("empresas")
    .select("id,nome,tipo")
    .in("tipo",["fornecedor","ambas"])
    .order("nome");

  forCache=data||[];
  renderFor(forCache);
  atualizarResumo();
}

function renderFor(arr){
  listaFor.innerHTML="";
  arr.forEach(f=>{
    listaFor.innerHTML+=`
      <div class="item-row">
        <input type="checkbox"
          ${fornecedoresMarcados.has(f.id)?"checked":""}
          onchange="toggleFor(${f.id},this.checked)">
        ${f.nome}
      </div>
    `;
  });
}

function toggleFor(id,v){
  v?fornecedoresMarcados.add(id):fornecedoresMarcados.delete(id);
  atualizarResumo();
}

function filtrarFor(){
  let t=buscaFor.value.toLowerCase();
  renderFor(forCache.filter(f=>f.nome.toLowerCase().includes(t)));
}

function atualizarResumo(){
  let itens=itemCache.filter(i=>itensMarcados.has(i.id));
  resumo.innerHTML=`
    <b>Itens:</b> ${itens.length}<br>
    <b>Fornecedores:</b> ${fornecedoresMarcados.size}
    <hr>
    ${itens.map(i=>`
      <div>
        <b>${i.item_tr}</b> - ${i.especificacao}<br>
        <small>Min ${i.quant_min} | Máx ${i.quant_max||"-"} | Valor ${i.valor_unit||"-"}</small>
      </div>
    `).join("")}
  `;
}

async function confirmarEnvio(){
  overlay.style.display="flex";
  try{
    for(let f of fornecedoresMarcados){
      const {data}=await sb.from("cotacoes")
        .insert([{licitacao_id:licSelecionada,fornecedor_id:f}])
        .select().single();

      await sb.from("cotacoes_itens")
        .insert([...itensMarcados].map(i=>({cotacao_id:data.id,item_id:i})));
    }
    overlay.style.display="none";
    alert("Cotações geradas!");
    location.reload();
  }catch(e){
    overlay.style.display="none";
    alert("Erro ao gerar cotação");
  }
}

function fecharItens(){modalItens.style.display="none"}
function fecharFor(){modalFor.style.display="none"}

carregarLic();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerar Cotações • LICITAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --p:#0b1e39;
  --bg:#eef2f7;
  --card:#fff;
  --border:#d6d9e0;
}

*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:var(--bg);padding:20px;font-size:13px}

h1{font-size:20px;margin-bottom:6px;color:var(--p)}
input{padding:8px;border-radius:6px;border:1px solid var(--border);width:100%}

.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:8px;
  padding:10px;
  cursor:pointer;
}
.card:hover{background:#f6f8fc}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  justify-content:center;
  align-items:flex-start;
  padding-top:20px;
  z-index:999;
}

.box{
  background:white;
  width:96%;
  max-width:1100px;
  border-radius:10px;
  max-height:88vh;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

.header{
  position:sticky;
  top:0;
  background:white;
  padding:10px;
  border-bottom:1px solid var(--border);
  z-index:10;
}

.body{padding:10px;overflow:auto}

.item{
  display:grid;
  grid-template-columns:22px 1fr;
  gap:8px;
  padding:6px 0;
  border-bottom:1px solid #eee;
  cursor:pointer;
}
.item:hover{background:#f5f7fb}

.btn{
  padding:8px 14px;
  border-radius:6px;
  border:none;
  background:var(--p);
  color:white;
  font-weight:600;
  cursor:pointer;
}

.close{
  position:absolute;
  right:12px;
  top:8px;
  cursor:pointer;
  font-size:18px;
}

#overlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.85);
  display:none;
  justify-content:center;
  align-items:center;
  font-size:16px;
  font-weight:600;
  color:var(--p);
  z-index:2000;
}
</style>
</head>

<body>

<h1>Gerar Cotações</h1>
<input id="buscaLic" placeholder="Pesquisar licitação..." oninput="filtrarLic()">

<div class="grid" id="listaLic"></div>

<!-- MODAL ITENS -->
<div class="modal" id="modalItens">
  <div class="box">
    <div class="header">
      <b id="tituloLic"></b><br>
      <small id="empresaLic"></small>
      <div class="close" onclick="fecharItens()">✕</div>
      <input id="buscaItem" placeholder="Pesquisar item..." oninput="filtrarItens()" style="margin-top:6px">
    </div>
    <div class="body" id="listaItens"></div>
    <div style="padding:10px;text-align:right">
      <button class="btn" onclick="abrirFor()">Selecionar Fornecedores</button>
    </div>
  </div>
</div>

<!-- MODAL FORNECEDORES -->
<div class="modal" id="modalFor">
  <div class="box">
    <div class="header">
      <b>Selecionar Fornecedores</b>
      <div class="close" onclick="fecharFor()">✕</div>
      <input id="buscaFor" placeholder="Pesquisar fornecedor..." oninput="filtrarFor()" style="margin-top:6px">
    </div>
    <div class="body" id="listaFor"></div>
    <div style="padding:10px;text-align:right">
      <button class="btn" onclick="confirmarEnvio()">Confirmar Envio</button>
    </div>
  </div>
</div>

<div id="overlay">Processando…</div>

<script>
const sb = supabase.createClient(
  "https://mblvyircwsaxaslklzky.supabase.co",
  "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x"
);

let licCache=[], itemCache=[], forCache=[];
let licId=null;
let itensSel=new Set(), forSel=new Set();

async function carregarLic(){
  const {data} = await sb
    .from("licitacoes")
    .select("id,codigo,empresas(nome)")
    .order("id",{ascending:false});
  licCache=data||[];
  renderLic(licCache);
}

function renderLic(arr){
  listaLic.innerHTML="";
  arr.forEach(l=>{
    listaLic.innerHTML+=`
      <div class="card" ondblclick="abrirItens(${l.id},'${l.codigo}','${l.empresas?.nome||""}')">
        <b>${l.codigo}</b><br>${l.empresas?.nome||""}
      </div>`;
  });
}

function filtrarLic(){
  let t=buscaLic.value.toLowerCase();
  renderLic(licCache.filter(l =>
    l.codigo.toLowerCase().includes(t) ||
    (l.empresas?.nome||"").toLowerCase().includes(t)
  ));
}

async function abrirItens(id,cod,emp){
  licId=id;
  itensSel.clear();
  tituloLic.innerText=`Licitação ${cod}`;
  empresaLic.innerText=`Empresa Licitante: ${emp}`;
  modalItens.style.display="flex";

  const {data} = await sb
    .from("licitacoes_itens")
    .select("id,item_tr,especificacao,quant_min,quant_max,valor_unit")
    .eq("licitacao_id",id);

  itemCache=data||[];
  renderItens(itemCache);
}

function renderItens(arr){
  listaItens.innerHTML="";
  arr.forEach(i=>{
    listaItens.innerHTML+=`
      <div class="item" ondblclick="toggleItem(${i.id})">
        <input type="checkbox" ${itensSel.has(i.id)?"checked":""}
          onclick="event.stopPropagation();toggleItem(${i.id})">
        <div>
          <b>${i.item_tr}</b><br>
          <small>${i.especificacao}</small><br>
          <small>Min ${i.quant_min} | Máx ${i.quant_max} | ${i.valor_unit}</small>
        </div>
      </div>`;
  });
}

function toggleItem(id){
  itensSel.has(id) ? itensSel.delete(id) : itensSel.add(id);
  renderItens(itemCache);
}

function filtrarItens(){
  let t=buscaItem.value.toLowerCase();
  renderItens(itemCache.filter(i =>
    i.item_tr.toLowerCase().includes(t) ||
    i.especificacao.toLowerCase().includes(t)
  ));
}

function fecharItens(){modalItens.style.display="none"}

async function abrirFor(){
  modalFor.style.display="flex";
  listaFor.innerHTML="";
  forSel.clear();

  const {data} = await sb
    .from("empresas")
    .select("id,nome")
    .in("tipo",["fornecedor","ambas"]);

  forCache=data||[];
}

function filtrarFor(){
  let t=buscaFor.value.toLowerCase();
  if(t.length<2){listaFor.innerHTML="";return;}

  listaFor.innerHTML="";
  forCache.filter(f=>f.nome.toLowerCase().includes(t))
    .forEach(f=>{
      listaFor.innerHTML+=`
        <div class="item" ondblclick="toggleFor(${f.id})">
          <input type="checkbox" ${forSel.has(f.id)?"checked":""}
            onclick="event.stopPropagation();toggleFor(${f.id})">
          <div>${f.nome}</div>
        </div>`;
    });
}

function toggleFor(id){
  forSel.has(id) ? forSel.delete(id) : forSel.add(id);
  filtrarFor();
}

function fecharFor(){modalFor.style.display="none"}

async function confirmarEnvio(){
  if(!itensSel.size || !forSel.size){
    alert("Selecione itens e fornecedores");
    return;
  }

  overlay.style.display="flex";

  try{
    for(let f of forSel){
      const {data:cot,error} = await sb.from("cotacoes")
        .insert({licitacao_id:licId,fornecedor_id:f})
        .select().single();
      if(error) throw error;

      for(let i of itensSel){
        const {error:e2} = await sb.from("cotacoes_itens")
          .insert({cotacao_id:cot.id,item_id:i});
        if(e2) throw e2;
      }
    }

    alert("Cotação enviada com sucesso");
    fecharFor();fecharItens();
  }catch(e){
    alert("Erro:\n"+e.message);
  }

  overlay.style.display="none";
}

carregarLic();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Licitações</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{--p:#0b1e39;--pl:#123869;--bg:#f5f7fa;--b:#d4d7df;--r:12px;--sh:0 4px 18px rgba(0,0,0,.08);}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Inter';}
body{background:var(--bg);padding:20px;}
h1{font-size:26px;font-weight:800;color:var(--p);margin-bottom:15px;}
.btn{padding:10px 18px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:.2s;}
.btn-primary{background:var(--p);color:#fff;}
.btn-primary:hover{background:var(--pl);}
.filtros{display:flex;gap:10px;margin:10px 0;}
.filtros input{border:1px solid var(--b);border-radius:8px;padding:8px;background:#fff;width:180px;}
.table-wrapper{background:#fff;border:1px solid var(--b);border-radius:var(--r);box-shadow:var(--sh);overflow:hidden;margin-top:10px;}
table{width:100%;border-collapse:collapse;font-size:14px;}
thead{background:#f0f3f8;position:sticky;top:0;z-index:5;}
th,td{padding:10px;border-bottom:1px solid var(--b);}
tbody tr:hover{background:#f4f7fc;cursor:pointer;}
.badge{padding:5px 10px;border-radius:8px;font-size:11px;font-weight:700;color:#fff;}
.st-PENDENTE{background:#ffbf00;}
.st-FUTURA{background:#3498ff;}
.st-EMANDAMENTO{background:#ff7e00;}
.st-FINALIZADA{background:#00b36b;}
.st-SUSPENSA{background:#d7263d;}
.status-select{padding:6px;border-radius:8px;border:1px solid var(--b);font-size:12px;background:#fff;}

#popup{position:fixed;inset:0;display:none;justify-content:center;align-items:flex-start;padding-top:20px;background:rgba(0,0,0,.45);z-index:200;}
#popupBox{background:white;width:95%;max-width:1200px;max-height:90vh;overflow:auto;border-radius:var(--r);padding:18px 20px;border:1px solid var(--b);box-shadow:var(--sh);}
.popup-close{font-size:26px;cursor:pointer;color:#555;padding:4px 10px;border-radius:8px;}
.popup-close:hover{background:#eee;color:#000;}

.table-popup th,.table-popup td{border-bottom:1px solid var(--b);padding:8px;}
.table-popup input,.table-popup select{width:100%;padding:6px;border-radius:6px;border:1px solid var(--b);font-size:13px;}

#overlay{position:fixed;inset:0;background:rgba(255,255,255,.85);display:none;justify-content:center;align-items:center;font-size:22px;color:var(--p);z-index:999;}

#modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);justify-content:center;align-items:flex-start;padding-top:25px;z-index:300;}
#modal>div{background:white;width:90%;max-width:900px;max-height:88vh;overflow:auto;border-radius:16px;padding:22px 26px;box-shadow:var(--sh);border:1px solid var(--b);}
#modal input,#modal select{width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--b);background:#fff;font-size:13.5px;}
#modal .fields-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px 16px;margin-bottom:10px;}

.autocomplete-list{display:none;position:absolute;top:60px;left:0;right:0;background:white;border:1px solid var(--b);border-radius:8px;box-shadow:var(--sh);max-height:180px;overflow-y:auto;z-index:9999;}
.autocomplete-item{padding:8px 10px;cursor:pointer;font-size:14px;border-bottom:1px solid #f2f2f2;}
.autocomplete-item:hover{background:#eef3ff;}

.loteCard{padding:12px;border:1px solid var(--b);border-radius:10px;margin-top:10px;background:white;}
.linhaItem{display:grid;grid-template-columns:1fr 2fr 1fr 1fr 1fr 1fr auto;gap:10px;margin:6px 0;}
.linhaItem input,.linhaItem select{height:32px !important;padding:6px 8px !important;border-radius:6px !important;border:1px solid var(--b);font-size:13px !important;}

.btn-remove-item{width:26px;height:26px;border-radius:50%;border:1px solid #ccc;background:#fafafa;color:#555;font-size:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s;}
.btn-remove-item:hover{background:#ffe5e5;border-color:#ff8a8a;color:#c40000;}

.btnAddItem{height:32px !important;padding:0 10px !important;border-radius:6px !important;background:var(--p) !important;color:#fff !important;font-size:13px !important;font-weight:600;display:flex;align-items:center;justify-content:center;}
</style>
</head>

<body>

<!-- MODAL CADASTRO -->
<div id="modal">
  <div>
    <h2 style="color:var(--p);margin-bottom:15px">Cadastrar Licitação</h2>

    <div class="fields-grid">
      <div style="position:relative;">
        <label>Empresa</label>
        <input id="pesquisaEmpresa" placeholder="Pesquisar empresa..." oninput="filtrarEmpresas()" autocomplete="off">
        <div id="listaEmpresas" class="autocomplete-list"></div>
        <input type="hidden" id="cadEmpresa">
      </div>

      <div><label>Código</label><input id="cadCodigo"></div>
      <div><label>Data</label><input type="date" id="cadData"></div>
      <div><label>Hora</label><input type="time" id="cadHora"></div>

      <div>
        <label>Modo</label>
        <select id="cadModo">
          <option value="">Selecione...</option>
          <option>Pregão Eletrônico</option><option>Pregão Presencial</option><option>Concorrência</option>
          <option>Tomada de Preços</option><option>Dispensa</option><option>Inexigibilidade</option>
          <option>Registro de Preços</option><option>Cotação</option>
        </select>
      </div>

      <div><label>Critério</label><input id="cadCriterio"></div>
      <div><label>Valor Total</label><input id="cadValor" disabled style="background:#eee"></div>
    </div>

    <h3 style="margin:10px 0;color:var(--p)">Lotes</h3>
    <div id="areaLotes"></div>
    <button class="btn btn-primary" onclick="addLote()" style="margin-top:10px;">+ Adicionar Lote</button>

    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px;">
      <button class="btn" onclick="fecharCadastro()">Cancelar</button>
      <button class="btn btn-primary" onclick="salvarLic()">Salvar Licitação</button>
    </div>
  </div>
</div>

<h1>Licitações</h1>
<button class="btn btn-primary" onclick="abrirCadastro()">+ Nova Licitação</button>

<div class="filtros">
  <input id="filtroPesquisa" placeholder="Pesquisar..." oninput="aplicarFiltros()">
  <input type="date" id="filtroDataDe" onchange="aplicarFiltros()">
  <input type="date" id="filtroDataAte" onchange="aplicarFiltros()">
</div>

<div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>Empresa</th><th>Código</th><th>Data</th><th>Modo</th><th>Critério</th><th>Valor</th><th>Status</th><th>Alterar</th>
      </tr>
    </thead>
    <tbody id="lista"></tbody>
  </table>
</div>

<!-- POPUP -->
<div id="popup">
  <div id="popupBox">

    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2 id="popupTitulo" style="color:var(--p)"></h2>
      <div style="display:flex;gap:10px;align-items:center;">
        <button class="btn btn-primary" id="btnEditarItens" onclick="ativarEdicaoItens()">Editar Itens</button>
        <div class="popup-close" onclick="fecharPopup()">×</div>
      </div>
    </div>

    <table class="table-popup">
      <thead>
        <tr>
          <th>Item TR</th><th>Descrição</th><th>Unidade</th><th>Qtd Máx</th><th>Qtd Min</th><th>Valor Unitário</th>
        </tr>
      </thead>
      <tbody id="popupItens"></tbody>
    </table>

    <div style="margin-top:20px;text-align:right;display:none" id="areaSalvarItens">
      <button class="btn btn-primary" onclick="salvarAlteracoesItens()">Salvar Alterações</button>
    </div>

  </div>
</div>

<div id="overlay">Salvando...</div>

<script>
const sb = supabase.createClient("https://mblvyircwsaxaslklzky.supabase.co","sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x");

let listaCache=[];let empresasCache=[];let popupItensData=[];

function maskMoney(v){return Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});}
function parseMoney(v){return parseFloat(v.replace(/[R$\s\.]/g,"").replace(",",".")||0);}

async function carregarEmpresas(){
  let{data}=await sb.from("empresas").select("id,nome").order("nome");
  empresasCache=data||[];
}

function filtrarEmpresas(){
  const txt=pesquisaEmpresa.value.toLowerCase();
  if(!txt){listaEmpresas.style.display="none";return;}
  const filtrado=empresasCache.filter(e=>e.nome.toLowerCase().includes(txt));
  if(filtrado.length===0){listaEmpresas.style.display="none";return;}
  listaEmpresas.innerHTML=filtrado.map(e=>`
    <div class="autocomplete-item"
    onclick="selecionarEmpresa('${e.id}','${e.nome.replace(/'/g,'\\\'')}')">${e.nome}</div>
  `).join("");
  listaEmpresas.style.display="block";
}

function selecionarEmpresa(id,nome){
  pesquisaEmpresa.value=nome;cadEmpresa.value=id;listaEmpresas.style.display="none";
}

document.addEventListener("click",e=>{
  if(!e.target.closest("#listaEmpresas")&&e.target!==pesquisaEmpresa){
    listaEmpresas.style.display="none";
  }
});

function abrirPopup(l){
  modoEdicao=false;
  areaSalvarItens.style.display="none";
  btnEditarItens.innerText="Editar Itens";

  popupTitulo.innerText=`${l.empresa.nome} • ${l.codigo} • ${l.modo} • ${l.data_sessao}`;
  carregarItensPopup(l.id);
  popup.style.display="flex";
}

function fecharPopup(){
  modoEdicao=false;
  areaSalvarItens.style.display="none";
  btnEditarItens.innerText="Editar Itens";
  popup.style.display="none";
}

async function carregarItensPopup(id){
  let{data}=await sb.from("licitacoes_itens").select("*").eq("licitacao_id",id);
  popupItensData=data||[];
  renderTabelaPopup(false);
}

function renderTabelaPopup(editavel){
  popupItens.innerHTML="";
  popupItensData.forEach((it,i)=>{
    popupItens.innerHTML+=`
      <tr>
        <td>${editavel?`<input value="${it.item_tr}" data-i="${i}" data-c="item_tr">`:it.item_tr}</td>
        <td>${editavel?`<input value="${it.especificacao}" data-i="${i}" data-c="especificacao">`:it.especificacao}</td>
        <td>${editavel?`
          <select data-i="${i}" data-c="unidade">
            <option ${it.unidade=="UN"?"selected":""}>UN</option>
            <option ${it.unidade=="KG"?"selected":""}>KG</option>
            <option ${it.unidade=="CX"?"selected":""}>CX</option>
            <option ${it.unidade=="PCT"?"selected":""}>PCT</option>
          </select>`:it.unidade}
        </td>
        <td>${editavel?`<input type="number" value="${it.quant_max}" data-i="${i}" data-c="quant_max">`:it.quant_max}</td>
        <td>${editavel?`<input type="number" value="${it.quant_min}" data-i="${i}" data-c="quant_min">`:it.quant_min}</td>
        <td>${editavel?`<input value="${maskMoney(it.valor_unit)}" data-i="${i}" data-c="valor_unit">`:maskMoney(it.valor_unit)}</td>
      </tr>
    `;
  });
}

async function mudarStatus(id,novo){
  await sb.from("licitacoes").update({status:novo}).eq("id",id);
  carregar();
}

function aplicarFiltros(){
  let txt=filtroPesquisa.value.toLowerCase();
  let de=filtroDataDe.value||null;
  let ate=filtroDataAte.value||null;

  let filtrado=listaCache.filter(l=>{
    let ok=true;
    if(txt){
      ok &=(
        (l.empresa.nome||"").toLowerCase().includes(txt)||
        (l.codigo||"").toLowerCase().includes(txt)||
        (l.modo||"").toLowerCase().includes(txt)||
        (l.criterio||"").toLowerCase().includes(txt)
      );
    }
    if(de) ok &=l.data_sessao>=de;
    if(ate) ok &=l.data_sessao<=ate;
    return ok;
  });

  renderTabelaPrincipal(filtrado);
}

async function carregar(){
  lista.innerHTML="<tr><td colspan='8'>Carregando...</td></tr>";
  let{data}=await sb.from("licitacoes").select(`
    id,codigo,data_sessao,hora_sessao,criterio,modo,valor,status,
    empresa:empresa_id ( nome )
  `).order("id",{ascending:false});
  listaCache=data||[];
  aplicarFiltros();
}

function renderTabelaPrincipal(arr){
  lista.innerHTML="";
  arr.forEach(l=>{
    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${l.empresa?.nome||""}</td>
      <td>${l.codigo}</td>
      <td>${l.data_sessao} ${l.hora_sessao}</td>
      <td>${l.modo}</td>
      <td>${l.criterio}</td>
      <td>${maskMoney(l.valor)}</td>
      <td><span class="badge st-${l.status.replace(/\s/g,"").toUpperCase()}">${l.status}</span></td>
      <td>
        <select class="status-select" onchange="mudarStatus(${l.id},this.value)">
          <option ${l.status=="PENDENTE"?"selected":""}>PENDENTE</option>
          <option ${l.status=="FUTURA"?"selected":""}>FUTURA</option>
          <option ${l.status=="EM ANDAMENTO"?"selected":""}>EM ANDAMENTO</option>
          <option ${l.status=="FINALIZADA"?"selected":""}>FINALIZADA</option>
          <option ${l.status=="SUSPENSA"?"selected":""}>SUSPENSA</option>
        </select>
      </td>
    `;
    tr.addEventListener("click",e=>{
      if(e.target.tagName.toLowerCase()=="select")return;
      abrirPopup(l);
    });
    lista.appendChild(tr);
  });
}

let cadLotes=[];

function abrirCadastro(){
  carregarEmpresas();
  cadLotes=[];
  areaLotes.innerHTML="";
  pesquisaEmpresa.value="";
  cadEmpresa.value="";
  cadCodigo.value="";
  cadData.value="";
  cadHora.value="";
  cadModo.value="";
  cadCriterio.value="";
  cadValor.value="R$ 0,00";
  modal.style.display="flex";
}

function fecharCadastro(){modal.style.display="none";}

function addLote(){
  let id=cadLotes.length;
  cadLotes.push({nome:"",itens:[]});
  areaLotes.innerHTML+=`
    <div class="loteCard" data-l="${id}">
      <input class="loteNome" placeholder="Nome do lote" style="width:100%;padding:8px;border:1px solid var(--b);border-radius:8px;margin-bottom:12px;">
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px;">
        <button class="btnAddItem" onclick="addItem(${id})">+ Item</button>
        <input type="file" onchange="uploadLote(${id},this)">
      </div>
      <div class="loteItens"></div>
    </div>
  `;
}

function addItem(l){
  let bloco=areaLotes.querySelector(`[data-l="${l}"] .loteItens`);
  bloco.innerHTML+=`
    <div class="linhaItem">
      <input placeholder="Item TR">
      <input placeholder="Descrição">
      <select><option>UN</option><option>KG</option><option>CX</option><option>PCT</option></select>
      <input type="number" placeholder="Máx">
      <input type="number" placeholder="Min">
      <input placeholder="0,00" oninput="atualizarValorTotal()">
      <div class="btn-remove-item" onclick="this.parentElement.remove();atualizarValorTotal();">×</div>
    </div>
  `;
}

function uploadLote(l,input){
  let f=input.files[0];let reader=new FileReader();
  reader.onload=e=>{
    let wb=XLSX.read(e.target.result,{type:"binary"});
    let bloco=areaLotes.querySelector(`[data-l="${l}"] .loteItens`);
    bloco.innerHTML="";
    wb.SheetNames.forEach(sh=>{
      let linhas=XLSX.utils.sheet_to_json(wb.Sheets[sh]);
      linhas.forEach(r=>{
        bloco.innerHTML+=`
          <div class="linhaItem">
            <input value="${r.item_tr||""}">
            <input value="${r.especificacao||""}">
            <select>
              <option ${r.unidade=="UN"?"selected":""}>UN</option>
              <option ${r.unidade=="KG"?"selected":""}>KG</option>
              <option ${r.unidade=="CX"?"selected":""}>CX</option>
              <option ${r.unidade=="PCT"?"selected":""}>PCT</option>
            </select>
            <input value="${r.quant_max||0}">
            <input value="${r.quant_min||0}">
            <input value="${r.valor_unit||0}" oninput="atualizarValorTotal()">
          </div>
        `;
      });
    });
    atualizarValorTotal();
  };
  reader.readAsBinaryString(f);
}

function atualizarValorTotal(){
  let total=0;
  document.querySelectorAll(".linhaItem").forEach(l=>{
    let max=parseInt(l.children[3].value||0);
    let val=parseMoney(l.children[5].value||"0");
    total+=max*val;
  });
  cadValor.value=maskMoney(total);
}

async function salvarLic(){
  overlay.style.display="flex";
  try{
    let empresa_id=cadEmpresa.value;
    let codigo=cadCodigo.value;
    let data_sessao=cadData.value;
    let hora_sessao=cadHora.value;
    let modo=cadModo.value;
    let criterio=cadCriterio.value;
    let valor=parseMoney(cadValor.value);
    let status="PENDENTE";

    let{data:lic,error}=await sb.from("licitacoes").insert([{
      empresa_id,codigo,data_sessao,hora_sessao,modo,criterio,valor,status
    }]).select().single();

    if(error)throw error;
    let lic_id=lic.id;

    let lotes=document.querySelectorAll(".loteCard");
    for(let lote of lotes){
      let nomeLote=lote.querySelector(".loteNome").value;
      if(!nomeLote.trim()){
        alert("Preencha o nome de todos os lotes!");overlay.style.display="none";return;
      }

      let{data:loteInsert,error:loteErr}=await sb.from("licitacoes_lotes")
        .insert([{licitacao_id:lic_id,nome:nomeLote}]).select().single();
      if(loteErr)throw loteErr;
      let lote_id=loteInsert.id;

      let itens=lote.querySelectorAll(".linhaItem");
      for(let item of itens){
        let inputs=item.querySelectorAll("input,select");
        let item_tr=inputs[0].value;
        let especificacao=inputs[1].value;
        let unidade=inputs[2].value;
        let quant_max=parseInt(inputs[3].value||0);
        let quant_min=parseInt(inputs[4].value||0);
        let valor_unit=parseMoney(inputs[5].value||"0");

        await sb.from("licitacoes_itens").insert([{
          licitacao_id:lic_id,lote_id,item_tr,especificacao,unidade,quant_max,quant_min,valor_unit
        }]);
      }
    }

    modal.style.display="none";
    carregar();
    alert("Licitação salva com sucesso!");

  }catch(e){
    console.error(e);
    alert("Erro ao salvar licitação!");
  }
  overlay.style.display="none";
}

let modoEdicao=false;

function ativarEdicaoItens(){
  modoEdicao=!modoEdicao;
  renderTabelaPopup(modoEdicao);
  areaSalvarItens.style.display=modoEdicao?"block":"none";
  btnEditarItens.innerText=modoEdicao?"Cancelar Edição":"Editar Itens";
}

async function salvarAlteracoesItens(){
  overlay.style.display="flex";
  try{
    for(let i=0;i<popupItensData.length;i++){
      let linha=popupItens.querySelectorAll("tr")[i];
      let cells=linha.querySelectorAll("input,select");
      let item=popupItensData[i];

      item.item_tr=cells[0].value;
      item.especificacao=cells[1].value;
      item.unidade=cells[2].value;
      item.quant_max=parseInt(cells[3].value||0);
      item.quant_min=parseInt(cells[4].value||0);
      item.valor_unit=parseMoney(cells[5].value||"0");

      await sb.from("licitacoes_itens").update({
        item_tr:item.item_tr,especificacao:item.especificacao,unidade:item.unidade,
        quant_max:item.quant_max,quant_min:item.quant_min,valor_unit:item.valor_unit
      }).eq("id",item.id);
    }

    alert("Itens atualizados com sucesso!");
    modoEdicao=false;
    renderTabelaPopup(false);
    areaSalvarItens.style.display="none";
    btnEditarItens.innerText="Editar Itens";

  }catch(e){
    console.error(e);
    alert("Erro ao salvar itens!");
  }
  overlay.style.display="none";
}

carregar();
</script>

</body>
</html>

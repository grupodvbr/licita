<!DOCTYPE html><html lang="pt-br"><head><meta charset="UTF-8">
<title>Licitações</title><meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--p:#0b1e39;--pl:#123869;--bg:#f5f7fa;--b:#d4d7df;--r:10px;--sh:0 4px 14px rgba(0,0,0,.08);}
body{margin:0;padding:20px;font-family:'Inter';background:var(--bg);}
h1{font-size:26px;font-weight:800;color:var(--p);margin-bottom:15px}
.btn{padding:8px 16px;border:0;border-radius:8px;font-weight:600;cursor:pointer}
.btn-primary{background:var(--p);color:#fff}.btn-primary:hover{background:var(--pl)}
.table-wrapper{background:#fff;border:1px solid var(--b);border-radius:var(--r);overflow:hidden;margin-top:10px}
table{width:100%;border-collapse:collapse;font-size:14px}
thead{background:#f0f3f8;position:sticky;top:0}
td,th{padding:10px;border-bottom:1px solid var(--b)}
#modal,#popup,#overlay{position:fixed;inset:0;display:none;justify-content:center;align-items:flex-start;padding-top:20px;z-index:200;background:rgba(0,0,0,.45)}
#overlay{background:rgba(255,255,255,.9);align-items:center;font-size:22px;color:var(--p)}
#modal>div,#popup>div{background:#fff;width:95%;max-width:1100px;max-height:90vh;overflow:auto;border-radius:var(--r);padding:20px;box-shadow:var(--sh);border:1px solid var(--b)}
.loteCard{padding:12px;border:1px solid var(--b);border-radius:10px;margin-top:10px;background:#fff}
.linhaItem{display:grid;grid-template-columns:1fr 2fr 1fr 1fr 1fr 1fr auto;gap:6px;margin:5px 0}
.linhaItem input,.linhaItem select{height:30px;padding:4px;border:1px solid var(--b);border-radius:6px;font-size:13px}
.btnRemove{width:24px;height:24px;border-radius:50%;background:#eee;display:flex;align-items:center;justify-content:center;cursor:pointer}
.btnRemove:hover{background:#ffdddd;color:#900}
.badge{padding:4px 8px;border-radius:6px;font-size:11px;font-weight:700;color:#fff}
.st-PENDENTE{background:#ffbf00}.st-FUTURA{background:#3498ff}.st-EMANDAMENTO{background:#ff7e00}.st-FINALIZADA{background:#00b36b}.st-SUSPENSA{background:#d7263d}
.autocomplete-list{position:absolute;top:60px;left:0;right:0;background:#fff;border:1px solid var(--b);border-radius:8px;display:none;max-height:180px;overflow:auto;z-index:999}
.autocomplete-item{padding:8px;cursor:pointer}.autocomplete-item:hover{background:#eef3ff}
</style></head><body>

<h1>Licitações</h1>
<button class="btn btn-primary" onclick="abrirCadastro()">+ Nova Licitação</button>

<div class="table-wrapper"><table><thead>
<tr><th>Empresa</th><th>Código</th><th>Data</th><th>Modo</th><th>Critério</th><th>Valor</th><th>Status</th><th>Alterar</th></tr>
</thead><tbody id="lista"></tbody></table></div>

<div id="modal"><div>
<h2 style="color:var(--p)">Cadastrar Licitação</h2>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
<div style="position:relative"><label>Empresa</label>
<input id="pesquisaEmpresa" placeholder="Pesquisar..." oninput="filtrarEmpresas()">
<div id="listaEmpresas" class="autocomplete-list"></div>
<input type="hidden" id="cadEmpresa"></div>
<div><label>Código</label><input id="cadCodigo"></div>
<div><label>Data</label><input type="date" id="cadData"></div>
<div><label>Hora</label><input type="time" id="cadHora"></div>
<div><label>Modo</label>
<select id="cadModo"><option value="">Selecione…</option><option>Pregão Eletrônico</option><option>Pregão Presencial</option><option>Concorrência</option><option>Tomada de Preços</option><option>Dispensa</option><option>Inexigibilidade</option><option>Registro de Preços</option><option>Cotação</option></select></div>
<div><label>Critério</label><input id="cadCriterio"></div>
<div><label>Valor Total</label><input id="cadValor" disabled></div>
</div>

<h3 style="color:var(--p)">Lotes</h3>
<div id="areaLotes"></div>
<button class="btn btn-primary" onclick="addLote()">+ Adicionar Lote</button>

<div style="margin-top:15px;text-align:right">
<button class="btn" onclick="fecharCadastro()">Cancelar</button>
<button class="btn btn-primary" onclick="salvarLic()">Salvar Licitação</button>
</div></div></div>

<div id="popup"><div>
<div style="display:flex;justify-content:space-between;align-items:center">
<h2 id="popupTitulo"></h2><div class="btnRemove" onclick="popup.style.display='none'">×</div></div>
<div id="popupConteudo"></div>
</div></div>

<div id="overlay">Salvando...</div>

<script>
const sb=supabase.createClient("https://mblvyircwsaxaslklzky.supabase.co","sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x");
let empresasCache=[],listaCache=[];

const M=(v)=>Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const P=(v)=>parseFloat(String(v).replace(/[R$\s\.]/g,"").replace(",",".")||0);

async function carregarEmpresas(){let{data}=await sb.from("empresas").select("id,nome").order("nome");empresasCache=data||[]}
function filtrarEmpresas(){let t=pesquisaEmpresa.value.toLowerCase();if(!t)return listaEmpresas.style.display="none";
let r=empresasCache.filter(e=>e.nome.toLowerCase().includes(t));listaEmpresas.innerHTML=r.map(e=>`<div class="autocomplete-item" onclick="selEmp('${e.id}','${e.nome}')">${e.nome}</div>`).join("");listaEmpresas.style.display=r.length?"block":"none"}
function selEmp(id,n){cadEmpresa.value=id;pesquisaEmpresa.value=n;listaEmpresas.style.display="none"}

async function carregar(){
let{data}=await sb.from("licitacoes").select(`id,codigo,data_sessao,hora_sessao,criterio,modo,valor,status,empresa:empresa_id(nome)`).order("id",{ascending:false});
listaCache=data||[];renderTable()}
function renderTable(){
lista.innerHTML="";
listaCache.forEach(l=>{
let tr=document.createElement("tr");
tr.innerHTML=`
<td>${l.empresa?.nome||""}</td><td>${l.codigo}</td><td>${l.data_sessao} ${l.hora_sessao}</td>
<td>${l.modo}</td><td>${l.criterio}</td><td>${M(l.valor)}</td>
<td><span class="badge st-${l.status.replace(/\s/g,"").toUpperCase()}">${l.status}</span></td>
<td><select onchange="mudarStatus(${l.id},this.value)">
<option${l.status=="PENDENTE"?" selected":""}>PENDENTE</option>
<option${l.status=="FUTURA"?" selected":""}>FUTURA</option>
<option${l.status=="EM ANDAMENTO"?" selected":""}>EM ANDAMENTO</option>
<option${l.status=="FINALIZADA"?" selected":""}>FINALIZADA</option>
<option${l.status=="SUSPENSA"?" selected":""}>SUSPENSA</option></select></td>`;
tr.onclick=e=>{if(e.target.tagName=="SELECT")return;abrirPopup(l.id)};
lista.appendChild(tr)})}

async function mudarStatus(id,s){await sb.from("licitacoes").update({status:s}).eq("id",id);carregar()}

async function abrirPopup(id){
popupConteudo.innerHTML="Carregando...";
popup.style.display="flex";
let{data:l}=await sb.from("licitacoes").select(`
id,codigo,data_sessao,modo,
empresa:empresa_id(nome),
lotes:licitacoes_lotes(id,nome,itens:licitacoes_itens(*))
`).eq("id",id).single();
popupTitulo.innerText=`${l.empresa.nome} • ${l.codigo} • ${l.modo} • ${l.data_sessao}`;
let html="";
l.lotes.forEach(L=>{
html+=`<h3>Lote: ${L.nome}</h3>
<table class="table-popup"><thead>
<tr><th>Item TR</th><th>Descrição</th><th>Unidade</th><th>Máx</th><th>Min</th><th>Valor</th></tr>
</thead><tbody>`;
L.itens.forEach(i=>{html+=`<tr><td>${i.item_tr}</td><td>${i.especificacao}</td><td>${i.unidade}</td>
<td>${i.quant_max}</td><td>${i.quant_min}</td><td>${M(i.valor_unit)}</td></tr>`});
html+="</tbody></table><br>"});
popupConteudo.innerHTML=html}

function abrirCadastro(){
areaLotes.innerHTML="";cadEmpresa.value="";cadCodigo.value="";cadData.value="";cadHora.value="";
cadModo.value="";cadCriterio.value="";cadValor.value="R$ 0,00";modal.style.display="flex";carregarEmpresas()}

function fecharCadastro(){modal.style.display="none"}

function addLote(){
let id=document.querySelectorAll(".loteCard").length;
areaLotes.innerHTML+=`
<div class="loteCard" data-l="${id}">
<input class="loteNome" placeholder="Nome do lote">
<div style="display:flex;gap:6px">
<button class="btn btn-primary" onclick="addItem(${id})">+ Item</button>
<input type="file" onchange="uploadLote(${id},this)">
</div>
<div class="loteItens"></div></div>`}

function addItem(l){
let b=document.querySelector(`[data-l="${l}"] .loteItens`);
b.innerHTML+=`
<div class="linhaItem">
<input placeholder="Item TR">
<input placeholder="Descrição">
<select><option>UN</option><option>KG</option><option>CX</option><option>PCT</option></select>
<input type="number"><input type="number">
<input placeholder="0,00" oninput="calcTotal()">
<div class="btnRemove" onclick="this.parentElement.remove();calcTotal()">×</div>
</div>`}

function uploadLote(l,input){
let f=input.files[0],r=new FileReader();
r.onload=e=>{
let wb=XLSX.read(e.target.result,{type:"binary"}),b=document.querySelector(`[data-l="${l}"] .loteItens`);
b.innerHTML="";
wb.SheetNames.forEach(sh=>{
XLSX.utils.sheet_to_json(wb.Sheets[sh]).forEach(r=>{
b.innerHTML+=`
<div class="linhaItem">
<input value="${r.item_tr||""}"><input value="${r.especificacao||""}">
<select><option${r.unidade=="UN"?" selected":""}>UN</option>
<option${r.unidade=="KG"?" selected":""}>KG</option>
<option${r.unidade=="CX"?" selected":""}>CX</option>
<option${r.unidade=="PCT"?" selected":""}>PCT</option></select>
<input value="${r.quant_max||0}"><input value="${r.quant_min||0}">
<input value="${r.valor_unit||0}" oninput="calcTotal()"></div>`})});calcTotal()}
r.readAsBinaryString(f)}

function calcTotal(){
let t=0;document.querySelectorAll(".linhaItem").forEach(l=>{
let q=parseInt(l.children[3].value||0);let v=P(l.children[5].value||0);t+=q*v});
cadValor.value=M(t)}

async function salvarLic(){
overlay.style.display="flex";
try{
let{data:lic,err}=await sb.from("licitacoes").insert([{
empresa_id:cadEmpresa.value,codigo:cadCodigo.value,data_sessao:cadData.value,
hora_sessao:cadHora.value,modo:cadModo.value,criterio:cadCriterio.value,
valor:P(cadValor.value),status:"PENDENTE"}]).select().single();
if(err)throw err;
let lic_id=lic.id;

for(let L of document.querySelectorAll(".loteCard")){
let nome=L.querySelector(".loteNome").value;
if(!nome.trim())throw"Nome do lote vazio";
let{data:lote}=await sb.from("licitacoes_lotes").insert([{licitacao_id:lic_id,nome}]).select().single();
for(let item of L.querySelectorAll(".linhaItem")){
let i=item.querySelectorAll("input,select");
await sb.from("licitacoes_itens").insert([{
licitacao_id:lic_id,lote_id:lote.id,item_tr:i[0].value,especificacao:i[1].value,
unidade:i[2].value,quant_max:parseInt(i[3].value||0),
quant_min:parseInt(i[4].value||0),valor_unit:P(i[5].value)}])}}
modal.style.display="none";carregar();alert("Licitação salva!")}
catch(e){console.error(e);alert("Erro ao salvar")}
overlay.style.display="none"}

carregar();
</script>
</body></html>

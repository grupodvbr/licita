<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Licitações</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
  --p:#0b1e39;
  --pl:#123869;
  --bg:#f5f7fa;
  --b:#d4d7df;
  --r:12px;
  --sh:0 3px 12px rgba(0,0,0,.08);
  --import:#e9f2ff;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:"Inter";}
body{background:var(--bg);padding:20px;}
h1{font-size:26px;font-weight:800;color:var(--p);margin-bottom:20px;}

.container-cards{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:15px;
}

.card{
  background:#fff;
  border:1px solid var(--b);
  border-radius:var(--r);
  padding:16px;
  box-shadow:var(--sh);
}

.card h3{margin:5px 0;font-size:16px;color:var(--p);}
.card small{color:#666;font-size:12px;}

.badge{
  padding:5px 8px;
  border-radius:6px;
  font-size:11px;
  font-weight:700;
  color:#fff;
  margin-top:5px;
  display:inline-block;
}

.st-PENDENTE{background:#ffbf00;}
.st-FUTURA{background:#3498ff;}
.st-EMANDAMENTO{background:#ff7e00;}
.st-FINALIZADA{background:#00b36b;}
.st-SUSPENSA{background:#d7263d;}

.status-select{
  margin-top:10px;
  width:100%;
  padding:6px;
  border-radius:6px;
  border:1px solid var(--b);
}

.filtros{
  background:white;
  border:1px solid var(--b);
  padding:12px;
  border-radius:var(--r);
  display:flex;
  gap:15px;
  margin-bottom:20px;
}

input,select{
  padding:8px;
  border-radius:8px;
  border:1px solid var(--b);
  background:#fafbfc;
}

.btn{
  padding:10px 16px;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}
.btn-primary{background:var(--p);color:white;}
.btn-primary:hover{background:var(--pl);}
.btn-clean{background:#eceff5;color:#333;}

#modal, #modalItens{
  position:fixed;
  inset:0;
  display:none;
  justify-content:center;
  align-items:flex-start;
  padding-top:20px;
  background:rgba(0,0,0,.45);
  z-index:9999;
}

#modalBox, #modalItensBox{
  background:white;
  width:95%;
  max-width:1200px;
  max-height:90vh;
  overflow:auto;
  border-radius:var(--r);
  padding:20px;
  border:1px solid var(--b);
}

.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}

.item-table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
.item-table th{
  background:#edf1f7;
  padding:8px;
  font-size:13px;
}
.item-table td{
  padding:8px;
  border-bottom:1px solid #eee;
  font-size:13px;
}

.edit-flag-box{
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:10px;
}
.edit-flag-box input{width:18px;height:18px;}

#overlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.85);
  display:none;
  justify-content:center;
  align-items:center;
  font-size:22px;
  font-weight:700;
  color:var(--p);
  z-index:99999;
}
</style>
</head>
<body>

<h1>Licitações</h1>

<div class="filtros">
  <div>
    <label>Busca global</label>
    <input id="f_busca" placeholder="Empresa ou código">
  </div>
  <div>
    <label>Data inicial</label>
    <input type="date" id="f_data_ini">
  </div>
  <div>
    <label>Data final</label>
    <input type="date" id="f_data_fim">
  </div>
  <div>
    <label>Status</label>
    <select id="f_status">
      <option value="">Ativas (padrão)</option>
      <option value="TODAS">Todas</option>
      <option value="PENDENTE">Pendente</option>
      <option value="FUTURA">Futura</option>
      <option value="EM ANDAMENTO">Em andamento</option>
      <option value="FINALIZADA">Finalizada</option>
      <option value="SUSPENSA">Suspensa</option>
    </select>
  </div>
  <button class="btn btn-primary" onclick="carregar()">Filtrar</button>
  <button class="btn btn-clean" onclick="limparFiltros()">Limpar</button>
  <button class="btn btn-primary" onclick="abrirModal()">+ Nova Licitação</button>
</div>

<div id="lista" class="container-cards"></div>

<!-- MODAL CADASTRAR -->
<div id="modal">
  <div id="modalBox">

<h2>Nova Licitação</h2>

<div class="grid">
  <div class="autocomplete-box">
    <label>Empresa</label>
    <input id="empresaBusca" placeholder="Buscar empresa...">
    <div id="empresaLista" class="lista-emp"></div>
  </div>

  <div><label>Código</label><input id="codigo"></div>
  <div><label>Data da Sessão</label><input type="date" id="data_sessao"></div>
  <div><label>Hora</label><input type="time" id="hora_sessao"></div>
  <div><label>Critério</label><input id="criterio"></div>
  <div>
    <label>Modo</label>
    <select id="modo">
      <option value="">Selecione</option>
      <option>Pregão Eletrônico</option>
      <option>Pregão Automático</option>
      <option>Pregão Presencial</option>
    </select>
  </div>

  <div>
    <label>Valor Total</label>
    <input id="valor" disabled>
  </div>

</div>

<h3 style="margin-top:20px">Itens</h3>

<div class="grid">
  <div><label>Item TR</label><input id="i_item"></div>
  <div><label>Descrição</label><input id="i_desc"></div>
  <div>
    <label>Unidade</label>
    <select id="i_unid">
      <option>UN</option><option>CX</option><option>PCT</option><option>KG</option>
    </select>
  </div>
  <div><label>Qtd Máx</label><input id="i_max"></div>
  <div><label>Qtd Mín</label><input id="i_min"></div>
  <div><label>Valor Unit</label><input id="i_valor" placeholder="0,00"></div>
</div>

<button class="btn btn-primary" style="margin-top:10px" onclick="addItem(false)">Adicionar Item</button>

<br><br>

<input type="file" id="fileUpload" onchange="importarArquivo()">

<div id="itensLista"></div>

<br>
<button class="btn btn-clean" onclick="fecharModal()">Cancelar</button>
<button class="btn btn-primary" onclick="salvarLicitacao()">Salvar</button>

  </div>
</div>

<!-- MODAL ITENS -->
<div id="modalItens">
  <div id="modalItensBox">
    <h2 id="tituloItens"></h2>

    <div class="edit-flag-box">
      <input type="checkbox" id="flagEdit">
      <label>Ativar modo edição</label>
    </div>

    <table class="item-table">
      <thead>
        <tr>
          <th>Item TR</th>
          <th>Descrição</th>
          <th>Unidade</th>
          <th>Máx</th>
          <th>Mín</th>
          <th>Unitário</th>
        </tr>
      </thead>
      <tbody id="tabelaItens"></tbody>
    </table>

    <br>
    <button class="btn btn-clean" onclick="fecharItens()">Fechar</button>
  </div>
</div>

<div id="overlay">Carregando...</div>

<script>
const sb = supabase.createClient(
  "https://mblvyircwsaxaslklzky.supabase.co",
  "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x"
);

let empresasCache=[];
let empresaSelecionada=null;
let itensTemp=[];
let itensDaLicitacao=[];

function maskMoney(v){return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});}
function parseMoney(v){return parseFloat(v.replace(/[R$\s\.]/g,"").replace(",",".")||0);}

async function carregarEmpresas(){
  let {data}=await sb.from("empresas").select("*");
  empresasCache=data.filter(e=>e.tipo!=="fornecedor");
}

empresaBusca.addEventListener("input",()=>{let t=empresaBusca.value.toLowerCase();empresaLista.innerHTML="";let f=empresasCache.filter(e=>e.nome.toLowerCase().includes(t));if(!f.length){empresaLista.style.display="none";return;}f.forEach(e=>{let d=document.createElement("div");d.innerText=e.nome;d.onclick=()=>{empresaBusca.value=e.nome;empresaSelecionada=e.id;empresaLista.style.display="none";};empresaLista.appendChild(d);});empresaLista.style.display="block";});

function abrirModal(){modal.style.display="flex";carregarEmpresas();itensTemp=[];renderItensTemp();valor.value="R$ 0,00";}
function fecharModal(){modal.style.display="none";}

function addItem(importado){
 let it={item_tr:i_item.value,especificacao:i_desc.value,unidade:i_unid.value,quant_max:parseFloat(i_max.value||0),quant_min:parseFloat(i_min.value||0),valor_unit:parseMoney(i_valor.value||"0"),importado};
 itensTemp.push(it);renderItensTemp();i_item.value=i_desc.value=i_max.value=i_min.value=i_valor.value="";
}

function renderItensTemp(){
 itensLista.innerHTML="";let total=0;
 itensTemp.forEach(it=>{total+=it.quant_min*it.valor_unit;itensLista.innerHTML+=`
 <div style='padding:10px;border:1px solid #ccc;border-radius:8px;margin-top:6px;background:${it.importado?'#e9f2ff':'white'}'>
 <b>${it.item_tr}</b> - ${it.especificacao}<br>
 ${it.unidade} | Min ${it.quant_min} | Max ${it.quant_max} | ${maskMoney(it.valor_unit)}
 </div>`;});
 valor.value=maskMoney(total);
}

function importarArquivo(){
 let f=fileUpload.files[0];let r=new FileReader();
 r.onload=e=>{
  let wb=XLSX.read(new Uint8Array(e.target.result),{type:"array"});
  let sheet=wb.Sheets[wb.SheetNames[0]];
  let json=XLSX.utils.sheet_to_json(sheet);
  json.forEach(x=>{itensTemp.push({item_tr:x.item_tr,especificacao:x.especificacao,unidade:x.unidade,quant_max:x.quant_max,quant_min:x.quant_min,valor_unit:parseFloat((x.valor_unit+"").replace(",",".")||0),importado:true});});
  renderItensTemp();
 };
 r.readAsArrayBuffer(f);
}

async function salvarLicitacao(){
 overlay.style.display="flex";
 let total=parseMoney(valor.value);
 let lic={empresa_id:empresaSelecionada,codigo:codigo.value,data_sessao:data_sessao.value,hora_sessao:hora_sessao.value,criterio:criterio.value,modo:modo.value,valor:total,status:"PENDENTE"};
 let {data,error}=await sb.from("licitacoes").insert(lic).select().single();
 if(error){alert(error.message);overlay.style.display="none";return;}
 for(let it of itensTemp){
   await sb.from("licitacoes_itens").insert({licitacao_id:data.id,empresa_id:data.empresa_id,item_tr:it.item_tr,especificacao:it.especificacao,unidade:it.unidade,quant_max:it.quant_max,quant_min:it.quant_min,valor_unit:it.valor_unit});
 }
 overlay.style.display="none";fecharModal();carregar();
}

function fecharItens(){modalItens.style.display="none";}

async function verItens(id,empresa,nomeEmpresa){
 modalItens.style.display="flex";
 tituloItens.innerText="Itens - "+nomeEmpresa+" ("+id+")";
 let {data}=await sb.from("licitacoes_itens").select("*").eq("licitacao_id",id);
 itensDaLicitacao=data;
 renderTabelaItens();
}

function renderTabelaItens(){
 tabelaItens.innerHTML="";
 itensDaLicitacao.forEach((it,i)=>{
  tabelaItens.innerHTML+=`
  <tr>
    <td>${flagEdit.checked?`<input value='${it.item_tr}' onchange='editarCampo(${i},"item_tr",this.value)'>`:`${it.item_tr}`}</td>
    <td>${flagEdit.checked?`<input value='${it.especificacao}' onchange='editarCampo(${i},"especificacao",this.value)'>`:`${it.especificacao}`}</td>
    <td>${flagEdit.checked?`<select onchange='editarCampo(${i},"unidade",this.value)'>
          <option ${it.unidade=="UN"?"selected":""}>UN</option>
          <option ${it.unidade=="CX"?"selected":""}>CX</option>
          <option ${it.unidade=="PCT"?"selected":""}>PCT</option>
          <option ${it.unidade=="KG"?"selected":""}>KG</option>
        </select>`
        :`${it.unidade}`}</td>
    <td>${flagEdit.checked?`<input value='${it.quant_max}' onchange='editarCampo(${i},"quant_max",this.value)'>`:`${it.quant_max}`}</td>
    <td>${flagEdit.checked?`<input value='${it.quant_min}' onchange='editarCampo(${i},"quant_min",this.value)'>`:`${it.quant_min}`}</td>
    <td>${flagEdit.checked?`<input value='${it.valor_unit}' onchange='editarCampo(${i},"valor_unit",this.value)'>`:`${maskMoney(it.valor_unit)}`}</td>
  </tr>
  `;
 });
}

async function editarCampo(i,campo,valor){
 let item=itensDaLicitacao[i];
 await sb.from("licitacoes_itens").update({[campo]:campo.includes("valor")?parseFloat(valor):valor}).eq("id",item.id);
}

function limparFiltros(){
 f_busca.value="";
 f_data_ini.value="";
 f_data_fim.value="";
 f_status.value="";
 carregar();
}

async function mudarStatus(id,status){await sb.from("licitacoes").update({status}).eq("id",id);carregar();}

async function carregar(){
 overlay.style.display="flex";

 let {data}=await sb.from("licitacoes")
 .select("*,empresas:empresa_id(nome)")
 .order("id",{ascending:false});

 overlay.style.display="none";
 lista.innerHTML="";

 if(!data.length){
   lista.innerHTML="<p>Nenhuma licitação encontrada.</p>";
   return;
 }

 let busca=f_busca.value.toLowerCase();
 let din=f_data_ini.value?new Date(f_data_ini.value):null;
 let dfim=f_data_fim.value?new Date(f_data_fim.value):null;
 let st=f_status.value;

 let filtrados=data.filter(l=>{

  if(!["FINALIZADA","SUSPENSA"].includes(l.status) || st==="TODAS");

  if(st==="" && ["FINALIZADA","SUSPENSA"].includes(l.status)) return false;

  if(st!=="" && st!=="TODAS" && l.status!==st) return false;

  if(busca && !(
    l.empresas?.nome.toLowerCase().includes(busca) ||
    (l.codigo||"").toLowerCase().includes(busca)
  )) return false;

  if(din){
    let d=new Date(l.data_sessao);
    if(d<din) return false;
  }

  if(dfim){
    let d=new Date(l.data_sessao);
    if(d>dfim) return false;
  }

  return true;
 });

 filtrados.forEach(l=>{
  lista.innerHTML+=`
  <div class="card">
    <small>${l.empresas?.nome||""}</small>
    <h3>${l.codigo}</h3>
    <small>${l.data_sessao} ${l.hora_sessao}</small><br>
    <small>${l.modo}</small><br>
    <small>${maskMoney(l.valor||0)}</small><br><br>

    <span class="badge st-${l.status.replace(/\s/g,"").toUpperCase()}">${l.status}</span>

    <select class="status-select" onchange="mudarStatus(${l.id},this.value)">
      <option ${l.status=="PENDENTE"?"selected":""}>PENDENTE</option>
      <option ${l.status=="FUTURA"?"selected":""}>FUTURA</option>
      <option ${l.status=="EM ANDAMENTO"?"selected":""}>EM ANDAMENTO</option>
      <option ${l.status=="FINALIZADA"?"selected":""}>FINALIZADA</option>
      <option ${l.status=="SUSPENSA"?"selected":""}>SUSPENSA</option>
    </select>

    <br><br>

    <button class="btn btn-primary" onclick="verItens(${l.id},${l.empresa_id},'${l.empresas?.nome||""}')">Ver Itens</button>
  </div>`;
 });

}
carregar();
</script>

</body>
</html>

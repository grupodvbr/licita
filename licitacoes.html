<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Licitações</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --p:#0b1e39;
  --p2:#123869;
  --bg:#f5f7fa;
  --b:#d4d7df;
  --r:12px;
  --sh:0 4px 18px rgba(0,0,0,.06);
  --gold:#FFB800;
}

*{margin:0;padding:0;box-sizing:border-box;font-family:'Inter';}

body{background:var(--bg);padding:20px;color:#1a1a1a;}

h1{font-size:26px;font-weight:700;margin-bottom:20px;}

button{cursor:pointer;border:none;border-radius:8px;padding:10px 18px;font-weight:600;}

.btn-primary{background:var(--p);color:white;}
.btn-primary:hover{background:var(--p2);}

.filtros{
  display:flex;
  gap:12px;
  margin-bottom:20px;
  flex-wrap:wrap;
}

.filtros input, .filtros select{
  padding:8px 10px;
  border:1px solid var(--b);
  border-radius:8px;
  background:white;
}

.grid-cards{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(260px,1fr));
  gap:14px;
}

.card{
  background:white;
  border:1px solid var(--b);
  border-radius:var(--r);
  padding:14px;
  box-shadow:var(--sh);
  transition:0.2s;
}

.card:hover{transform:scale(1.01);}

.card h3{margin:6px 0;font-size:20px;color:var(--p);}
.card small{color:#666;font-size:13px;}

.badge{
  display:inline-block;
  padding:6px 12px;
  color:white;
  border-radius:8px;
  font-size:11px;
  font-weight:700;
  margin-top:10px;
}

.st-PENDENTE{background:#ffb800;}
.st-FUTURA{background:#3498ff;}
.st-EM_ANDAMENTO{background:#ff7e00;}
.st-FINALIZADA{background:#00b36b;}
.st-SUSPENSA{background:#d7263d;}

.card-footer{
  margin-top:15px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.status-select{
  padding:6px;
  border-radius:8px;
  border:1px solid var(--b);
}

/* MODAL ITENS */
#modal-itens{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  justify-content:center;
  align-items:flex-start;
  padding-top:30px;
  z-index:999;
}

.modal-box{
  width:95%;
  max-width:900px;
  max-height:90vh;
  overflow:auto;
  background:white;
  border-radius:14px;
  padding:20px;
  border:1px solid var(--b);
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}

table th, table td{
  padding:8px;
  border-bottom:1px solid #e5e5e5;
  font-size:14px;
}

table th{
  background:#fafafa;
  text-align:left;
}

.editavel input{
  width:100%;
  padding:6px;
  border:1px solid var(--b);
  border-radius:6px;
}

.fechar{
  float:right;
  background:#d7263d;
  color:white;
  padding:6px 14px;
  border-radius:8px;
}

.total-box{
  margin-top:20px;
  font-size:18px;
  font-weight:700;
  color:var(--p);
}

</style>
</head>
<body>

<h1>Licitações</h1>

<button class="btn-primary" onclick="abrirNova()">+ Nova Licitação</button>

<div class="filtros">
  <input type="date" id="filtroInicio">
  <input type="date" id="filtroFim">
  
  <select id="filtroStatus">
    <option value="">Todos os Status</option>
    <option>PENDENTE</option>
    <option>FUTURA</option>
    <option>EM ANDAMENTO</option>
    <option>FINALIZADA</option>
    <option>SUSPENSA</option>
  </select>

  <input id="pesquisa" placeholder="Buscar por empresa..." style="flex:1">
</div>

<div id="lista" class="grid-cards"></div>

<!-- =========================  MODAL ITENS  ========================= -->

<div id="modal-itens">
  <div class="modal-box">

    <button class="fechar" onclick="fecharItens()">X</button>
    <h2 id="modalEmpresa" style="margin-bottom:10px;color:var(--p)"></h2>

    <label style="display:flex;align-items:center;gap:6px;margin-top:10px;">
      <input type="checkbox" id="habilitarEdicao"> Habilitar edição dos itens
    </label>

    <table id="tabelaItens">
      <thead>
        <tr>
          <th>TR</th>
          <th>Descrição</th>
          <th>Unid</th>
          <th>Máx</th>
          <th>Mín</th>
          <th>Valor</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="total-box" id="valorTotalItens">Total: R$ 0,00</div>

    <button class="btn-primary" onclick="salvarItens()">Salvar Alterações</button>

  </div>
</div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://mblvyircwsaxaslklzky.supabase.co",
  "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x"
);

let itensAtuais = [];
let licitacaoAtual = null;

/* MASK */
function money(n){return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});}
function parse(n){return parseFloat(n.replace(/[R$\s\.]/g,"").replace(",",".")) || 0;}

/* ================= CARREGAR LICITAÇÕES ================= */
async function carregar(){
  let {data, error} = await sb
    .from("licitacoes")
    .select(`
      id, codigo, data_sessao, hora_sessao, valor, status, modo,
      empresas:empresa_id(nome)
    `)
    .order("id", {ascending:false});

  if(error){ alert(error.message); return; }

  renderCards(data);
}

function renderCards(arr){
  lista.innerHTML="";

  arr.forEach(l => {

    lista.innerHTML += `
      <div class="card">

        <small>${l.empresas?.nome || "(Sem empresa)"}</small>

        <h3>${l.codigo}</h3>
        <small>Sessão: ${l.data_sessao} ${l.hora_sessao}</small><br>
        <small>Modo: ${l.modo}</small><br>
        <small>Valor: ${money(l.valor)}</small>

        <span class="badge st-${l.status.replace(" ","_")}">${l.status}</span>

        <div class="card-footer">
          <select class="status-select" onchange="atualizarStatus(${l.id}, this.value)">
            <option ${l.status=="PENDENTE"?"selected":""}>PENDENTE</option>
            <option ${l.status=="FUTURA"?"selected":""}>FUTURA</option>
            <option ${l.status=="EM ANDAMENTO"?"selected":""}>EM ANDAMENTO</option>
            <option ${l.status=="FINALIZADA"?"selected":""}>FINALIZADA</option>
            <option ${l.status=="SUSPENSA"?"selected":""}>SUSPENSA</option>
          </select>

          <button onclick="verItens(${l.id}, '${l.empresas?.nome}')">Ver Itens</button>
        </div>

      </div>
    `;
  });
}

/* ================= STATUS ================= */
async function atualizarStatus(id, st){
  await sb.from("licitacoes").update({status:st}).eq("id", id);
}

/* ================= MOSTRAR ITENS ================= */
async function verItens(id, empresa){
  licitacaoAtual = id;
  modalEmpresa.innerHTML = empresa;

  let {data, error} = await sb
    .from("licitacoes_itens")
    .select("*")
    .eq("licitacao_id", id);

  itensAtuais = data;

  montarTabela();
  modal-itens.style.display="flex";
}

function fecharItens(){
  modal-itens.style.display="none";
}

/* ================= TABELA ================= */
function montarTabela(){
  let tbody = document.querySelector("#tabelaItens tbody");
  tbody.innerHTML="";

  let total = 0;

  itensAtuais.forEach((it, i)=>{
    let subtotal = it.valor_unit * it.quant_max;
    total += subtotal;

    tbody.innerHTML += `
      <tr>
        <td>${it.item_tr}</td>
        <td class="editavel">${inputOuTexto(i,"especificacao",it.especificacao)}</td>
        <td>${it.unidade}</td>
        <td class="editavel">${inputOuTexto(i,"quant_max",it.quant_max)}</td>
        <td class="editavel">${inputOuTexto(i,"quant_min",it.quant_min)}</td>
        <td class="editavel">${inputOuTexto(i,"valor_unit",it.valor_unit.toFixed(2).replace(".",","))}</td>
        <td>${money(subtotal)}</td>
      </tr>
    `;
  });

  valorTotalItens.innerHTML = "Total: " + money(total);
}

function inputOuTexto(i,campo,valor){
  return habilitarEdicao.checked 
    ? `<input onchange="editarItem(${i}, '${campo}', this.value)" value="${valor}">`
    : valor;
}

function editarItem(i, campo, valor){
  if(campo === "valor_unit") valor = parse(valor);
  if(campo === "quant_max" || campo === "quant_min") valor = Number(valor);

  itensAtuais[i][campo] = valor;
  montarTabela();
}

/* ================= SALVAR ITENS ================= */
async function salvarItens(){
  for(let it of itensAtuais){
    await sb.from("licitacoes_itens")
      .update({
        especificacao: it.especificacao,
        quant_max: it.quant_max,
        quant_min: it.quant_min,
        valor_unit: it.valor_unit
      })
      .eq("id", it.id);
  }

  // recalcular valor total da licitação
  let total = itensAtuais.reduce((s,it)=> s + (it.valor_unit * it.quant_max), 0);

  await sb.from("licitacoes")
    .update({valor: total})
    .eq("id", licitacaoAtual);

  alert("Itens atualizados!");
  fecharItens();
  carregar();
}

/* ================= FILTROS ================= */
pesquisa.addEventListener("input", aplicarFiltros);
filtroStatus.addEventListener("change", aplicarFiltros);
filtroInicio.addEventListener("change", aplicarFiltros);
filtroFim.addEventListener("change", aplicarFiltros);

async function aplicarFiltros(){
  let {data} = await sb
    .from("licitacoes")
    .select(`
      id, codigo, data_sessao, hora_sessao, valor, status, modo,
      empresas:empresa_id(nome)
    `);

  let inicio = filtroInicio.value;
  let fim = filtroFim.value;
  let stat = filtroStatus.value;
  let busca = pesquisa.value.toLowerCase();

  let filtrado = data.filter(l => {
    let ok = true;

    if(inicio && l.data_sessao < inicio) ok=false;
    if(fim && l.data_sessao > fim) ok=false;
    if(stat && l.status !== stat) ok=false;
    if(busca && !l.empresas?.nome.toLowerCase().includes(busca)) ok=false;

    return ok;
  });

  renderCards(filtrado);
}

carregar();
</script>

</body>
</html>

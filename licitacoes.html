<!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8"><title>Licita√ß√µes</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{--p:#0b1e39;--pl:#123869;--bg:#f5f7fa;--b:#d4d7df;--r:12px;--sh:0 4px 18px rgba(0,0,0,.08);}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Inter';}
body{background:var(--bg);padding:20px;}
h1{font-size:26px;font-weight:800;color:var(--p);margin-bottom:15px;}
.btn{padding:10px 18px;border:none;border-radius:8px;font-weight:600;cursor:pointer;}
.btn-primary{background:var(--p);color:#fff;} .btn-primary:hover{background:var(--pl);}
.filtros{display:flex;gap:10px;margin:10px 0;} .filtros input{padding:8px;border:1px solid var(--b);border-radius:8px;width:180px;}
.table-wrapper{background:#fff;border:1px solid var(--b);border-radius:var(--r);box-shadow:var(--sh);margin-top:10px;overflow:hidden;}
table{width:100%;border-collapse:collapse;font-size:14px;} thead{background:#f0f3f8;position:sticky;top:0;z-index:5;}
th,td{padding:12px 10px;border-bottom:1px solid var(--b);} tbody tr:hover{background:#f4f7fc;cursor:pointer;}
.badge{padding:6px 10px;border-radius:8px;font-size:11px;font-weight:700;color:#fff;}
.st-PENDENTE{background:#ffbf00;} .st-FUTURA{background:#3498ff;} .st-EMANDAMENTO{background:#ff7e00;}
.st-FINALIZADA{background:#00b36b;} .st-SUSPENSA{background:#d7263d;}
.status-select{padding:5px;border-radius:8px;border:1px solid var(--b);cursor:pointer;}
#popup{position:fixed;inset:0;display:none;justify-content:center;align-items:flex-start;padding-top:20px;background:rgba(0,0,0,.45);z-index:200;}
#popupBox{background:#fff;width:95%;max-width:1300px;max-height:90vh;overflow:auto;border-radius:12px;padding:20px;box-shadow:var(--sh);}
.popup-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;}
.switch{position:relative;display:inline-block;width:46px;height:24px;} .switch input{display:none;}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;transition:.4s;border-radius:34px;}
.slider:before{content:"";position:absolute;height:18px;width:18px;left:3px;bottom:3px;background:#fff;transition:.4s;border-radius:50%;}
input:checked + .slider{background:var(--p);} input:checked + .slider:before{transform:translateX(22px);}
.accordion{background:#eee;color:#000;padding:10px;border-radius:6px;margin-top:12px;font-weight:600;cursor:pointer;}
.accordion.active{background:#dfe8f7;} .panel{display:none;padding:10px 0;}
.table-popup{width:100%;border-collapse:collapse;} .table-popup th,.table-popup td{padding:8px;border-bottom:1px solid var(--b);}
.table-popup input,.table-popup select{width:100%;padding:5px;border:1px solid var(--b);border-radius:6px;}
#overlay{position:fixed;inset:0;background:rgba(255,255,255,.85);display:none;justify-content:center;align-items:center;font-size:22px;font-weight:700;color:var(--p);z-index:999;}
/* modal cadastro */
#modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;justify-content:center;align-items:center;z-index:300;}
#modalBox{background:#fff;width:90%;max-width:1100px;max-height:90vh;overflow:auto;border-radius:12px;padding:20px;}
.lote-card{border:1px solid var(--b);border-radius:10px;padding:12px;margin-top:10px;background:#fff;}
.lote-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.item-row{display:grid;grid-template-columns:1fr 2fr 1fr 1fr 1fr 1fr;gap:6px;margin-top:6px;}
</style>
</head>

<body>

<h1>Licita√ß√µes</h1>
<button class="btn btn-primary" onclick="abrirCadastro()">+ Nova Licita√ß√£o</button>

<div class="filtros">
 <input id="fPesquisa" placeholder="Pesquisar..." oninput="aplicarFiltros()">
 <input type="date" id="fDe" onchange="aplicarFiltros()">
 <input type="date" id="fAte" onchange="aplicarFiltros()">
</div>

<div class="table-wrapper">
<table><thead><tr>
<th>Empresa</th><th>C√≥digo</th><th>Data</th><th>Modo</th><th>Crit√©rio</th><th>Valor</th><th>Status</th><th>Alterar</th>
</tr></thead><tbody id="lista"></tbody></table></div>

<!-- POP-UP -->
<div id="popup"><div id="popupBox">
<div class="popup-header">
<h2 id="popupTitulo"></h2>
<div style="display:flex;gap:12px;align-items:center;">
<span>Editar Itens</span>
<label class="switch"><input type="checkbox" id="toggleEditar" onchange="ativarEdicao()"><span class="slider"></span></label>
<div style="font-size:24px;cursor:pointer;color:#555;" onclick="fecharPopup()">√ó</div>
</div></div>

<div id="popupLotes"></div>
</div></div>

<!-- MODAL CADASTRO -->
<div id="modal"><div id="modalBox">
<h2 style="color:var(--p)">Cadastrar Licita√ß√£o</h2>

<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px;">
 <div><label>Empresa</label><input id="cEmpresa"></div>
 <div><label>C√≥digo</label><input id="cCodigo"></div>
 <div><label>Data</label><input type="date" id="cData"></div>
 <div><label>Hora</label><input type="time" id="cHora"></div>
 <div><label>Modo</label><input id="cModo"></div>
 <div><label>Crit√©rio</label><input id="cCriterio"></div>
 <div><label>Valor Estimado</label><input id="cValor"></div>
</div>

<h3 style="margin-top:15px;">Lotes</h3>
<div id="areaLotes"></div>

<button class="btn btn-primary" style="margin-top:10px" onclick="addLote()">+ Adicionar Lote</button>

<div style="text-align:right;margin-top:20px;">
 <button class="btn" onclick="fecharCadastro()">Cancelar</button>
 <button class="btn btn-primary" onclick="salvarLic()">Salvar Licita√ß√£o</button>
</div>

</div></div>

<div id="overlay">Salvando...</div>

<script>
/* ======================= SUPABASE ======================= */
const sb = supabase.createClient("https://mblvyircwsaxaslklzky.supabase.co","sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x");

let cache = [];
let lotesCadastro = [];

/* ======================= UTIL ======================= */
const maskMoney=v=>Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const parseMoney=v=>parseFloat(v.replace(/[R$\s\.]/g,"").replace(",",".")||0);

/* ======================= POPUP ======================= */
function abrirPopup(l){
 popupTitulo.innerText=`${l.empresa.nome} ‚Ä¢ ${l.codigo} ‚Ä¢ ${l.data_sessao}`;
 carregarLotesPopup(l.id);
 popup.style.display="flex";
}
function fecharPopup(){popup.style.display="none";}

/* LOTES NO POPUP */
async function carregarLotesPopup(id){
 let {data:lotes}=await sb.from("licitacoes_lotes").select("*").eq("licitacao_id",id).order("id");
 let cont="";

 for(let lote of lotes){
   let {data:itens}=await sb.from("licitacoes_itens").select("*").eq("lote_id",lote.id).order("id");

   cont+=`
   <div class="accordion">üì¶ ${lote.nome}</div>
   <div class="panel">
   <table class="table-popup"><thead>
   <tr><th>Item TR</th><th>Descri√ß√£o</th><th>Unidade</th><th>Max</th><th>Min</th><th>Valor</th></tr>
   </thead><tbody>
   ${itens.map(it=>`
     <tr data-id="${it.id}">
       <td><input disabled value="${it.item_tr}"></td>
       <td><input disabled value="${it.especificacao}"></td>
       <td><select disabled>
          <option ${it.unidade=="UN"?"selected":""}>UN</option>
          <option ${it.unidade=="KG"?"selected":""}>KG</option>
          <option ${it.unidade=="CX"?"selected":""}>CX</option>
          <option ${it.unidade=="PCT"?"selected":""}>PCT</option>
       </select></td>
       <td><input disabled value="${it.quant_max}"></td>
       <td><input disabled value="${it.quant_min}"></td>
       <td><input disabled value="${maskMoney(it.valor_unit)}"></td>
     </tr>
   `).join("")}
   </tbody></table>
   <button class="btn btn-primary btnSalvarLote" style="display:none;margin-top:10px">Salvar Itens do Lote</button>
   </div>
   `;
 }

 popupLotes.innerHTML=cont;

 /* acorde√£o */
 document.querySelectorAll(".accordion").forEach((a,i)=>{
   a.onclick=()=>{
     a.classList.toggle("active");
     let p=a.nextElementSibling;
     p.style.display=p.style.display=="block"?"none":"block";
   };
 });
}

/* EDI√á√ÉO INLINE */
function ativarEdicao(){
 let enabled = toggleEditar.checked;
 document.querySelectorAll("#popupItens input,#popupItens select").forEach(el=>el.disabled=!enabled);
 document.querySelectorAll(".btnSalvarLote").forEach(b=>b.style.display=enabled?"block":"none");
}

/* ======================= TELA PRINCIPAL ======================= */
async function carregar(){
 let {data}=await sb.from("licitacoes").select("id,codigo,data_sessao,hora_sessao,criterio,modo,valor,status,empresa:empresa_id (nome)").order("id",{ascending:false});
 cache=data||[]; aplicarFiltros();
}

function aplicarFiltros(){
 let txt=(fPesquisa.value||"").toLowerCase(), de=fDe.value, ate=fAte.value;
 let arr = cache.filter(l=>{
   let ok=true;
   if(txt) ok &= (l.empresa.nome.toLowerCase().includes(txt)||l.codigo.toLowerCase().includes(txt)||l.modo.toLowerCase().includes(txt)||l.criterio.toLowerCase().includes(txt));
   if(de) ok &= l.data_sessao>=de;
   if(ate) ok &= l.data_sessao<=ate;
   return ok;
 });
 renderLista(arr);
}

function renderLista(arr){
 lista.innerHTML="";
 arr.forEach(l=>{
 let tr=document.createElement("tr");
 tr.innerHTML=`
  <td>${l.empresa.nome}</td><td>${l.codigo}</td><td>${l.data_sessao}</td>
  <td>${l.modo}</td><td>${l.criterio}</td><td>${maskMoney(l.valor)}</td>
  <td><span class="badge st-${l.status.replace(/\s/g,"")}">${l.status}</span></td>
  <td><select class="status-select" onchange="mudarStatus(${l.id},this.value)">
      <option ${l.status=="PENDENTE"?"selected":""}>PENDENTE</option>
      <option ${l.status=="FUTURA"?"selected":""}>FUTURA</option>
      <option ${l.status=="EM ANDAMENTO"?"selected":""}>EM ANDAMENTO</option>
      <option ${l.status=="FINALIZADA"?"selected":""}>FINALIZADA</option>
      <option ${l.status=="SUSPENSA"?"selected":""}>SUSPENSA</option>
   </select></td>`;
 tr.onclick=e=>{if(e.target.tagName=="SELECT")return;abrirPopup(l);}
 lista.appendChild(tr);
 });
}

async function mudarStatus(id,st){await sb.from("licitacoes").update({status:st}).eq("id",id);carregar();}

/* ======================= CADASTRO ======================= */
function abrirCadastro(){ modal.style.display="flex"; lotesCadastro=[]; areaLotes.innerHTML=""; }
function fecharCadastro(){ modal.style.display="none"; }

function addLote(){
 let idx=lotesCadastro.length;
 lotesCadastro.push({nome:"",itens:[]});
 areaLotes.innerHTML+=`
  <div class="lote-card" data-i="${idx}">
   <div class="lote-header">
     <input placeholder="Nome do lote" class="lote-nome">
     <button class="btn btn-primary" onclick="addItem(${idx})">+ Item</button>
     <input type="file" onchange="uploadLote(${idx},this)">
   </div>
   <div class="lote-itens"></div>
  </div>`;
}

function addItem(i){
 let lote=areaLotes.querySelector(`[data-i="${i}"] .lote-itens`);
 lote.innerHTML+=`
  <div class="item-row">
   <input placeholder="Item TR"><input placeholder="Descri√ß√£o">
   <select><option>UN</option><option>KG</option><option>CX</option><option>PCT</option></select>
   <input type="number" placeholder="Max"><input type="number" placeholder="Min"><input placeholder="0,00">
  </div>`;
}

function uploadLote(i,input){
 let f=input.files[0]; let reader=new FileReader();
 reader.onload=e=>{
   let wb=XLSX.read(e.target.result,{type:"binary"});
   let loteEl=areaLotes.querySelector(`[data-i="${i}"] .lote-itens`);
   loteEl.innerHTML="";
   wb.SheetNames.forEach(sh=>{
     let dados=XLSX.utils.sheet_to_json(wb.Sheets[sh]);
     dados.forEach(l=>{
       loteEl.innerHTML+=`
        <div class="item-row">
         <input value="${l.item_tr||""}"><input value="${l.especificacao||""}">
         <select><option>UN</option><option>KG</option><option>CX</option><option>PCT</option></select>
         <input type="number" value="${l.quant_max||0}"><input type="number" value="${l.quant_min||0}">
         <input value="${l.valor_unit||0}">
        </div>`;
     });
   });
 };
 reader.readAsBinaryString(f);
}

async function salvarLic(){
 overlay.style.display="flex";
 let lic={
   empresa:cEmpresa.value,codigo:cCodigo.value,data_sessao:cData.value,hora_sessao:cHora.value,
   modo:cModo.value,criterio:cCriterio.value,valor:parseMoney(cValor.value),status:"PENDENTE"
 };
 let {data:salvo}=await sb.from("licitacoes").insert(lic).select().single();

 for(let card of document.querySelectorAll(".lote-card")){
   let nome=card.querySelector(".lote-nome").value;
   let {data:lote}=await sb.from("licitacoes_lotes").insert({licitacao_id:salvo.id,nome}).select().single();

   let linhas=card.querySelectorAll(".item-row");
   for(let row of linhas){
     let c=row.children;
     await sb.from("licitacoes_itens").insert({
       licitacao_id:salvo.id,lote_id:lote.id,
       item_tr:c[0].value,especificacao:c[1].value,unidade:c[2].value,
       quant_max:c[3].value,quant_min:c[4].value,valor_unit:parseMoney(c[5].value)
     });
   }
 }

 overlay.style.display="none";
 modal.style.display="none";
 carregar();
}

carregar();
</script>
</body>
</html>

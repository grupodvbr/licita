<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>LICITAR • Controle de Usuários</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --dark:#0b1e39;
  --dark2:#0e2248;
  --bg:#0c1426;
  --danger:#e53935;
  --radius:18px;
}

*{ box-sizing:border-box; font-family:Inter, system-ui, sans-serif; }

body{
  margin:0;
  height:100vh;
  display:grid;
  grid-template-columns:420px 1fr;
  background:linear-gradient(135deg,var(--bg),#020814);
  overflow:hidden;
}

/* LEFT */
.left{
  background:#fff;
  padding:50px;
}

.logo{
  font-size:36px;
  font-weight:900;
  color:var(--dark);
  margin-bottom:30px;
}

.left h2{
  margin:0 0 20px;
  color:var(--dark);
}

label{
  display:block;
  margin-bottom:6px;
  font-size:14px;
  color:#4d5a7a;
}

input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid #dbe2f2;
  background:#f4f7ff;
  margin-bottom:16px;
  font-size:14px;
}

button{
  width:100%;
  padding:15px;
  border:none;
  border-radius:14px;
  background:linear-gradient(135deg,var(--dark),var(--dark2));
  color:#fff;
  font-weight:800;
  cursor:pointer;
}

/* RIGHT */
.right{
  padding:50px;
  overflow:auto;
  color:#fff;
}

.right h2{
  margin-top:0;
  margin-bottom:30px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
  gap:22px;
}

.card{
  background:#fff;
  color:#0b1e39;
  padding:22px;
  border-radius:var(--radius);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.card b{
  font-size:16px;
}

.card span{
  display:block;
  font-size:14px;
  opacity:.7;
}

.del{
  background:var(--danger);
  padding:10px 18px;
  border-radius:12px;
  border:none;
  color:#fff;
  font-weight:800;
  cursor:pointer;
}

/* POPUP */
#popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}

.popupBox{
  width:360px;
  background:#fff;
  padding:30px;
  border-radius:20px;
  text-align:center;
}

.popupBox h3{
  margin:0 0 10px;
  color:var(--dark);
}

.popupBox p{
  margin:0 0 20px;
  color:#555;
}

.popupBox input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid #dbe2f2;
  margin-bottom:12px;
}

.popupBox .confirm{
  background:var(--danger);
}

.popupBox .cancel{
  background:#ccc;
  color:#000;
}
</style>
</head>

<body>

<script>
/* PROTEÇÃO */
const emailLogado = localStorage.getItem("usuarioEmail");
if(!emailLogado){
  alert("Sessão expirada. Faça login novamente.");
  window.location.href = "login.html";
}
</script>

<!-- POPUP -->
<div id="popup">
  <div class="popupBox">
    <h3>Confirmar Exclusão</h3>
    <p>Digite sua senha para confirmar</p>

    <input id="senhaPopup" type="password" placeholder="Senha do usuário logado">

    <button class="confirm" onclick="confirmarExclusao()">Excluir Usuário</button>
    <button class="cancel" onclick="fecharPopup()">Cancelar</button>
  </div>
</div>

<!-- LEFT -->
<div class="left">
  <div class="logo">LICITAR</div>

  <h2>Novo Usuário</h2>

  <label>Nome Completo</label>
  <input id="u_nome">

  <label>Email</label>
  <input id="u_email" type="email">

  <label>Senha</label>
  <input id="u_senha" type="password">

  <button onclick="salvarUsuario()">Cadastrar</button>
</div>

<!-- RIGHT -->
<div class="right">
  <h2>Usuários Cadastrados</h2>
  <div id="listaUsuarios" class="grid"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

const sb = supabase.createClient(
  "https://mblvyircwsaxaslklzky.supabase.co",
  "SUA_PUBLIC_ANON_KEY_AQUI"
);

let usuarioParaExcluir = null;

/* LISTAR */
async function carregarUsuarios(){
  const { data, error } = await sb.from("usuarios").select("*").order("nome");
  if(error){
    alert("Erro ao carregar usuários");
    console.error(error);
    return;
  }

  listaUsuarios.innerHTML = data.map(u => `
    <div class="card">
      <div>
        <b>${u.nome || "-"}</b>
        <span>${u.email}</span>
      </div>
      <button class="del" onclick="solicitarExclusao('${u.id}')">Excluir</button>
    </div>
  `).join("");
}

/* SOLICITAR */
window.solicitarExclusao = function(id){
  try{
    if(!id) throw new Error("ID do usuário inválido.");

    usuarioParaExcluir = id;
    const popup = document.getElementById("popup");

    if(!popup) throw new Error("Popup não encontrado.");

    popup.style.display = "flex";

    setTimeout(() => {
      if(window.getComputedStyle(popup).display === "none"){
        throw new Error("Popup não foi exibido.");
      }
    },50);

  }catch(e){
    console.error(e);
    alert("Erro ao iniciar exclusão:\n" + e.message);
  }
};

/* FECHAR */
window.fecharPopup = function(){
  popup.style.display = "none";
  usuarioParaExcluir = null;
};

/* CONFIRMAR */
window.confirmarExclusao = async function(){
  try{
    if(!usuarioParaExcluir){
      throw new Error("Nenhum usuário selecionado.");
    }

    const senha = senhaPopup.value;
    if(!senha){
      throw new Error("Digite sua senha.");
    }

    const { error: authError } = await sb.auth.signInWithPassword({
      email: emailLogado,
      password: senha
    });

    if(authError){
      throw new Error("Senha incorreta ou sessão inválida.");
    }

    const { error } = await sb
      .from("usuarios")
      .delete()
      .eq("id", usuarioParaExcluir);

    if(error){
      throw new Error(
        error.message.includes("permission")
        ? "Você não tem permissão para excluir usuários."
        : error.message
      );
    }

    alert("Usuário excluído com sucesso!");
    fecharPopup();
    carregarUsuarios();

  }catch(e){
    console.error(e);
    alert("Erro ao excluir usuário:\n" + e.message);
  }
};

carregarUsuarios();
});
</script>

</body>
</html>

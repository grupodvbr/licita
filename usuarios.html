<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>LICITAR • Usuários</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --dark:#0b1e39;
  --bg:#0c1426;
  --card:#ffffff;
  --radius:18px;
}

*{ box-sizing:border-box; font-family:Inter, system-ui, sans-serif; }

body{
  margin:0;
  height:100vh;
  display:grid;
  grid-template-columns:420px 1fr;
  background:linear-gradient(135deg,var(--bg),#020814);
  overflow:hidden;
}

/* LEFT */
.left{
  background:#fff;
  padding:50px;
}

.logo{
  font-size:36px;
  font-weight:900;
  color:var(--dark);
  margin-bottom:30px;
}

.left h2{
  margin:0 0 20px;
}

label{
  font-size:14px;
  display:block;
  margin-bottom:6px;
}

input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid #dbe2f2;
  background:#f4f7ff;
  margin-bottom:16px;
}

button{
  width:100%;
  padding:15px;
  border:none;
  border-radius:14px;
  background:linear-gradient(135deg,var(--dark),#102a5f);
  color:#fff;
  font-weight:800;
  cursor:pointer;
}

/* RIGHT */
.right{
  padding:50px;
  overflow:auto;
  color:#fff;
}

.right h2{
  margin-top:0;
  margin-bottom:30px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
  gap:22px;
}

.card{
  background:var(--card);
  color:#0b1e39;
  padding:22px;
  border-radius:var(--radius);
  cursor:pointer;
  transition:.2s;
}

.card:hover{
  transform:translateY(-3px);
  box-shadow:0 20px 40px rgba(0,0,0,.15);
}

.card b{
  font-size:16px;
}

.card span{
  font-size:14px;
  opacity:.7;
}

/* MODAL HISTÓRICO */
#modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  display:none;
  justify-content:flex-end;
  z-index:999;
}

.modalBox{
  width:420px;
  background:#fff;
  height:100%;
  padding:30px;
  overflow:auto;
}

.modalBox h3{
  margin-top:0;
}

.log{
  border-left:4px solid var(--dark);
  padding:10px 12px;
  margin-bottom:12px;
  background:#f4f7ff;
  border-radius:8px;
}

.log small{
  display:block;
  opacity:.6;
}
</style>
</head>

<body>

<script>
const emailLogado = localStorage.getItem("usuarioEmail");
if(!emailLogado){
  alert("Sessão expirada.");
  location.href = "login.html";
}
</script>

<!-- MODAL HISTÓRICO -->
<div id="modal">
  <div class="modalBox">
    <h3 id="histNome">Histórico</h3>
    <div id="histLista"></div>
    <br>
    <button onclick="fecharModal()">Fechar</button>
  </div>
</div>

<!-- LEFT -->
<div class="left">
  <div class="logo">LICITAR</div>
  <h2>Novo Usuário</h2>

  <label>Nome Completo</label>
  <input id="u_nome">

  <label>Email</label>
  <input id="u_email">

  <label>Senha</label>
  <input id="u_senha" type="password">

  <button onclick="salvarUsuario()">Cadastrar</button>
</div>

<!-- RIGHT -->
<div class="right">
  <h2>Usuários Cadastrados</h2>
  <div id="listaUsuarios" class="grid"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {

const sb = supabase.createClient(
  "https://mblvyircwsaxaslklzky.supabase.co",
  "SUA_PUBLIC_ANON_KEY"
);

/* VERIFICAR ROLE */
const { data: usuarioAtual } = await sb
  .from("usuarios")
  .select("role")
  .eq("email", emailLogado)
  .single();

const isAdmin = usuarioAtual?.role === 'admin';

/* LISTAR */
async function carregarUsuarios(){
  const { data, error } = await sb
    .from("usuarios")
    .select("id,nome,email")
    .order("nome");

  if(error){
    alert("Erro ao carregar usuários");
    return;
  }

  listaUsuarios.innerHTML = data.map(u => `
    <div class="card" onclick="abrirHistorico('${u.id}','${u.nome || u.email}')">
      <b>${u.nome || "-"}</b>
      <span>${u.email}</span>
    </div>
  `).join("");
}

/* ABRIR HISTÓRICO */
window.abrirHistorico = async function(id, nome){
  if(!isAdmin){
    alert("Apenas administradores podem ver histórico.");
    return;
  }

  histNome.innerText = "Histórico • " + nome;
  histLista.innerHTML = "Carregando...";

  modal.style.display = "flex";

  const { data, error } = await sb
    .from("auditoria_usuarios")
    .select("*")
    .eq("usuario_afetado", id)
    .order("created_at",{ascending:false});

  if(error){
    histLista.innerHTML = "Erro ao carregar histórico.";
    return;
  }

  if(data.length === 0){
    histLista.innerHTML = "<p>Nenhum registro encontrado.</p>";
    return;
  }

  histLista.innerHTML = data.map(l => `
    <div class="log">
      <b>${l.acao}</b>
      <small>${new Date(l.created_at).toLocaleString()}</small>
      <small>Executado por: ${l.email_executor || '-'}</small>
    </div>
  `).join("");
};

/* FECHAR MODAL */
window.fecharModal = function(){
  modal.style.display = "none";
};

carregarUsuarios();
});
</script>

</body>
</html>

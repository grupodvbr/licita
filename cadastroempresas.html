<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Clientes e Fornecedores</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<style>
:root{
  --primary:#0b1e39;
  --primary-light:#123869;
  --border:#d4d7df;
  --bg:#f5f7fa;
  --radius:12px;
  --danger:#c62828;
  --danger-bg:#ffe5e5;
  --blue-soft:#eaf1ff;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter}
body{background:var(--bg);padding:20px}
h1{font-size:24px;font-weight:700;color:var(--primary);margin-bottom:15px}

.filtros{
  background:#fff;
  padding:15px;
  border-radius:12px;
  border:1px solid var(--border);
  display:flex;
  gap:20px;
  align-items:flex-end;
}
label{font-size:13px;font-weight:600}
input,select{
  width:230px;
  padding:8px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#f8f9fc;
}
.btn{
  border:none;
  padding:10px 18px;
  font-weight:600;
  border-radius:8px;
  cursor:pointer;
}
.btn-clean{background:#eceff5}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:disabled{background:#9ca6b3}

table{
  width:100%;
  margin-top:20px;
  border-collapse:collapse;
  background:#fff;
  border-radius:12px;
  overflow:hidden;
}
thead{background:#eef1f6}
th,td{
  padding:8px;
  text-align:center;
  border-bottom:1px solid #eee;
}

#modal{
  position:fixed;
  inset:0;
  display:none;
  justify-content:center;
  align-items:flex-start;
  padding-top:30px;
  background:rgba(0,0,0,.45);
  z-index:9999;
}
#modalBox{
  background:#fff;
  width:95%;
  max-width:1100px;
  max-height:85vh;
  overflow:auto;
  border-radius:12px;
  padding:25px;
}
.grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:16px;
}
#alertaDuplicado{
  display:none;
  margin-bottom:10px;
  padding:10px;
  background:var(--danger-bg);
  color:var(--danger);
  border-radius:8px;
  font-weight:700;
  text-align:center;
}
#overlay{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.85);
  z-index:99999;
  justify-content:center;
  align-items:center;
  font-size:24px;
  font-weight:700;
}
</style>
</head>

<body>

<h1>Clientes e Fornecedores</h1>

<div class="filtros">
  <div><label>Nome</label><input id="f_nome"></div>
  <div><label>CPF/CNPJ</label><input id="f_doc"></div>
  <div>
    <label>Tipo</label>
    <select id="f_tipo">
      <option value="">Todos</option>
      <option value="licitante">Licitante</option>
      <option value="fornecedor">Fornecedor</option>
      <option value="ambas">Ambas</option>
    </select>
  </div>
  <button class="btn btn-clean" onclick="limparFiltros()">Limpar</button>
  <button class="btn btn-primary" onclick="filtrar()">Pesquisar</button>
  <button class="btn btn-primary" onclick="abrirModal()">+ Novo Cadastro</button>
</div>

<table>
<thead>
<tr>
  <th>Nome</th><th>CPF/CNPJ</th><th>Telefone</th>
  <th>Email</th><th>Tipo</th><th>Cidade</th><th>Ações</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>

<div id="modal"><div id="modalBox">
<h2 id="tituloModal">Nova Empresa</h2>
<div id="alertaDuplicado">⚠ CPF/CNPJ já está cadastrado</div>

<div class="grid">
  <select id="tipo">
    <option value="licitante">Licitante</option>
    <option value="fornecedor">Fornecedor</option>
    <option value="ambas">Ambas</option>
  </select>
  <input id="doc" placeholder="CPF/CNPJ">
  <input id="nome" placeholder="Razão Social">
  <input id="fantasia" placeholder="Fantasia">
  <input id="responsavel" placeholder="Responsável">
  <input id="email" placeholder="Email">
  <input id="telefone" placeholder="Telefone">
  <input id="cep" placeholder="CEP">
  <input id="logradouro" placeholder="Logradouro">
  <input id="numero" placeholder="Número">
  <input id="bairro" placeholder="Bairro">
  <input id="cidade" placeholder="Cidade">
  <input id="uf" placeholder="UF">
  <select id="pix_tipo">
    <option value="">Pix Tipo</option>
    <option value="cpf">CPF</option>
    <option value="cnpj">CNPJ</option>
    <option value="email">Email</option>
    <option value="telefone">Telefone</option>
    <option value="aleatoria">Aleatória</option>
  </select>
  <input id="pix_chave" placeholder="Pix Chave">
  <input id="banco" placeholder="Banco">
  <input id="agencia" placeholder="Agência">
  <input id="conta" placeholder="Conta">
  <input id="observacao" placeholder="Observação" style="grid-column:span 4">
</div>

<div style="margin-top:20px;text-align:right">
  <button class="btn btn-clean" onclick="fecharModal()">Cancelar</button>
  <button class="btn btn-primary" id="btnSalvar" onclick="salvar()">Salvar</button>
</div>
</div></div>

<div id="overlay">Salvando...</div>

<script>
const sb = supabase.createClient(
  "https://mblvyircwsaxaslklzky.supabase.co",
  "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x"
);

let editarID=null;
let ultimoCNPJ=null;

/* ===================== */
function abrirModal(id=null){
  editarID=id;
  ultimoCNPJ=null;
  modal.style.display="flex";
  alertaDuplicado.style.display="none";
  if(!id) limparCampos();
}
function fecharModal(){ modal.style.display="none"; }

/* ===================== */
async function carregar(){
  const {data}=await sb.from("empresas").select("*").order("nome");
  window.empresas=data||[];
  renderTabela(data);
}
function renderTabela(lista){
  lista.innerHTML="";
  lista.forEach(e=>{
    lista.innerHTML+=`
      <tr>
        <td>${e.nome}</td>
        <td>${e.doc}</td>
        <td>${e.telefone||""}</td>
        <td>${e.email||""}</td>
        <td>${e.tipo}</td>
        <td>${e.cidade||""}</td>
        <td><button class="btn btn-primary" onclick="editar(${e.id})">Editar</button></td>
      </tr>`;
  });
}
function filtrar(){
  renderTabela(window.empresas.filter(e =>
    e.nome.toLowerCase().includes(f_nome.value.toLowerCase()) &&
    e.doc.toLowerCase().includes(f_doc.value.toLowerCase()) &&
    (!f_tipo.value || e.tipo===f_tipo.value)
  ));
}
function limparFiltros(){ f_nome.value=f_doc.value=f_tipo.value=""; renderTabela(window.empresas); }

/* ===================== */
doc.onblur = async ()=>{
  const v = doc.value.replace(/\D/g,"");
  if(v.length===14 && v!==ultimoCNPJ){
    ultimoCNPJ=v;
    buscarCNPJ(v);
  }
  const {data}=await sb.from("empresas").select("id").eq("doc",doc.value);
  btnSalvar.disabled = data.length && !editarID;
  alertaDuplicado.style.display = btnSalvar.disabled ? "block":"none";
};

/* ===================== */
async function buscarCNPJ(cnpj){
  try{
    const r=await fetch(`https://publica.cnpj.ws/cnpj/${cnpj}`);
    if(!r.ok) return;
    const d=await r.json();
    if(d.razao_social) nome.value=d.razao_social.toUpperCase();
    if(d.nome_fantasia) fantasia.value=d.nome_fantasia.toUpperCase();
    if(d.estabelecimento?.email) email.value=d.estabelecimento.email;
    if(d.estabelecimento?.telefone1) telefone.value=d.estabelecimento.telefone1;
    if(d.estabelecimento?.logradouro) logradouro.value=d.estabelecimento.logradouro.toUpperCase();
    if(d.estabelecimento?.numero) numero.value=d.estabelecimento.numero;
    if(d.estabelecimento?.bairro) bairro.value=d.estabelecimento.bairro.toUpperCase();
    if(d.estabelecimento?.cidade?.nome) cidade.value=d.estabelecimento.cidade.nome.toUpperCase();
    if(d.estabelecimento?.estado?.sigla) uf.value=d.estabelecimento.estado.sigla.toUpperCase();
  }catch{}
}

/* ===================== */
async function salvar(){
  overlay.style.display="flex";
  const dados={
    tipo:tipo.value,doc:doc.value,nome:nome.value,fantasia:fantasia.value,
    responsavel:responsavel.value,email:email.value,telefone:telefone.value,
    cep:cep.value,logradouro:logradouro.value,numero:numero.value,
    bairro:bairro.value,cidade:cidade.value,uf:uf.value,
    pix_tipo:pix_tipo.value,pix_chave:pix_chave.value,
    banco:banco.value,agencia:agencia.value,conta:conta.value,
    observacao:observacao.value
  };
  editarID
    ? await sb.from("empresas").update(dados).eq("id",editarID)
    : await sb.from("empresas").insert(dados);
  overlay.style.display="none";
  fecharModal();
  carregar();
}

function limparCampos(){
  document.querySelectorAll("#modal input").forEach(i=>i.value="");
}

carregar();
</script>

</body>
</html>

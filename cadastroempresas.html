<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Cadastro de Empresas • LICITAR</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<style>
:root{
  --primary:#0b1e39;
  --primary-light:#163861;
  --bg:#f5f7fb;
  --card:#ffffff;
  --border:#d2d8e2;
  --text:#0b1e39;
  --text-light:#3a4660;
  --radius:12px;
  --shadow:0 4px 16px rgba(0,0,0,.08);
}

*{ font-family:Inter, sans-serif; box-sizing:border-box; }
body{
  margin:0;
  background:var(--bg);
  padding:20px;
  display:flex;
  justify-content:center;
}

#container{
  width:95%;
  max-width:1200px;
  background:white;
  padding:25px;
  border-radius:18px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
}

h1{
  text-align:center;
  color:var(--primary);
  margin-bottom:25px;
}

/* FORM */
form{
  background:var(--card);
  padding:25px;
  border-radius:14px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  margin-bottom:25px;
}

label{
  font-size:14px;
  font-weight:600;
  color:var(--text-light);
}

input, select{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid var(--border);
  margin-top:5px;
  margin-bottom:15px;
  background:#f8faff;
  font-size:14px;
}

input:focus, select:focus{
  border-color:var(--primary);
  outline:none;
  box-shadow:0 0 0 3px rgba(11,30,57,.20);
}

.btn{
  padding:12px 18px;
  border:none;
  border-radius:10px;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
  transition:.25s;
}

.btn-primary{
  background:var(--primary);
  color:white;
}
.btn-primary:hover{ background:var(--primary-light); }

/* LISTA */
#busca{
  padding:12px;
  border-radius:10px;
  border:1px solid var(--border);
  width:100%;
  margin-bottom:18px;
}

.cardEmpresa{
  padding:18px;
  background:white;
  border-radius:12px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  margin-bottom:12px;
}
.cardEmpresa h3{
  margin:0;
  font-size:17px;
  color:var(--primary);
}
.cardEmpresa small{
  color:var(--text-light);
}
</style>
</head>

<body>

<div id="container">

<h1>Cadastro de Empresas</h1>

<!-- ================= FORMULÁRIO DE CADASTRO ================= -->
<form id="formEmpresa">

  <label>Tipo da Empresa</label>
  <select id="tipo">
    <option value="licitante">Empresa Licitatória</option>
    <option value="fornecedor">Fornecedor</option>
    <option value="ambas">Ambas</option>
  </select>

  <label>CNPJ / CPF</label>
  <input id="doc" placeholder="00.000.000/0000-00" maxlength="18">

  <label>Razão Social</label>
  <input id="nome">

  <label>Nome Fantasia</label>
  <input id="fantasia">

  <label>Responsável</label>
  <input id="responsavel">

  <label>E-mail</label>
  <input id="email">

  <label>Telefone</label>
  <input id="telefone" placeholder="(00) 00000-0000" maxlength="15">

  <label>CEP</label>
  <input id="cep" maxlength="9">

  <label>Logradouro</label>
  <input id="logradouro">

  <label>Número</label>
  <input id="numero">

  <label>Complemento</label>
  <input id="complemento">

  <label>Bairro</label>
  <input id="bairro">

  <label>Cidade</label>
  <input id="cidade">

  <label>UF</label>
  <input id="uf" maxlength="2">

  <label>Tipo Pix</label>
  <select id="pix_tipo">
    <option value="">Selecione</option>
    <option value="cpf">CPF</option>
    <option value="cnpj">CNPJ</option>
    <option value="email">Email</option>
    <option value="telefone">Telefone</option>
    <option value="aleatoria">Chave Aleatória</option>
  </select>

  <label>Chave Pix</label>
  <input id="pix_chave">

  <label>Banco</label>
  <input id="banco">

  <label>Agência</label>
  <input id="agencia">

  <label>Conta</label>
  <input id="conta">

  <label>Observação</label>
  <input id="observacao">

  <button type="button" class="btn btn-primary" onclick="salvarEmpresa()">Salvar Empresa</button>
</form>

<!-- ======================= BUSCA ======================= -->
<input id="busca" placeholder="Pesquisar por nome, CPF, CNPJ..." onkeyup="filtrarLista()">

<!-- ======================= LISTA ======================= -->
<div id="listaEmpresas"></div>

</div>

<script>
// ======================== SUPABASE ==========================
const SUPABASE_URL  = "https://mblvyircwsaxaslklzky.supabase.co";
const SUPABASE_KEY  = "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ===========================================================
// MÁSCARAS
// ===========================================================
function mascaraCPF(v){
  v = v.replace(/\D/g,"");
  v = v.replace(/(\d{3})(\d)/,"$1.$2");
  v = v.replace(/(\d{3})(\d)/,"$1.$2");
  v = v.replace(/(\d{3})(\d{1,2})$/,"$1-$2");
  return v;
}

function mascaraCNPJ(v){
  v = v.replace(/\D/g,"");
  v = v.replace(/^(\d{2})(\d)/,"$1.$2");
  v = v.replace(/^(\d{2})\.(\d{3})(\d)/,"$1.$2.$3");
  v = v.replace(/\.(\d{3})(\d)/,".$1/$2");
  v = v.replace(/(\d{4})(\d)/,"$1-$2");
  return v;
}

function mascaraTelefone(v){
  v = v.replace(/\D/g,"");
  v = v.replace(/^(\d{2})(\d)/,"($1) $2");
  v = v.replace(/(\d{5})(\d)/,"$1-$2");
  return v;
}

function mascaraCEP(v){
  v = v.replace(/\D/g,"");
  v = v.replace(/(\d{5})(\d)/,"$1-$2");
  return v;
}

// Atribui máscaras automáticas
document.getElementById("telefone").oninput = e => e.target.value = mascaraTelefone(e.target.value);
document.getElementById("cep").oninput      = e => e.target.value = mascaraCEP(e.target.value);
document.getElementById("doc").oninput      = e => {
  let v = e.target.value.replace(/\D/g,"");
  e.target.value = (v.length <= 11) ? mascaraCPF(e.target.value) : mascaraCNPJ(e.target.value);
};

// ===========================================================
// CONSULTA AUTOMÁTICA DE CEP
// ===========================================================
document.getElementById("cep").addEventListener("keyup", async e =>{
  let cep = e.target.value.replace(/\D/g,"");
  if(cep.length !== 8) return;

  let req = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
  let dados = await req.json();

  if(!dados.erro){
    logradouro.value = dados.logradouro;
    bairro.value     = dados.bairro;
    cidade.value     = dados.localidade;
    uf.value         = dados.uf;
  }
});

// ===========================================================
// CONSULTA AUTOMÁTICA DE CNPJ
// ===========================================================
document.getElementById("doc").addEventListener("blur", async e =>{
  let cnpj = e.target.value.replace(/\D/g,"");
  if(cnpj.length !== 14) return;

  let req = await fetch(`https://publica.cnpj.ws/cnpj/${cnpj}`);
  let d = await req.json();

  if(d.razao_social) nome.value     = d.razao_social;
  if(d.nome_fantasia) fantasia.value = d.nome_fantasia;
  if(d.estabelecimento){
    telefone.value = mascaraTelefone(d.estabelecimento.telefone1 || "");
    email.value    = d.estabelecimento.email || "";
    logradouro.value = d.estabelecimento.logradouro || "";
    numero.value     = d.estabelecimento.numero || "";
    bairro.value     = d.estabelecimento.bairro || "";
    cidade.value     = d.estabelecimento.cidade?.nome || "";
    uf.value         = d.estabelecimento.estado?.sigla || "";
  }
});

// ===========================================================
// SALVAR EMPRESA NO SUPABASE
// ===========================================================
async function salvarEmpresa(){

  let dados = {
    tipo:tipo.value,
    doc:doc.value,
    nome:nome.value,
    fantasia:fantasia.value,
    responsavel:responsavel.value,
    email:email.value,
    telefone:telefone.value,
    cep:cep.value,
    logradouro:logradouro.value,
    numero:numero.value,
    complemento:complemento.value,
    bairro:bairro.value,
    cidade:cidade.value,
    uf:uf.value,
    pix_tipo:pix_tipo.value,
    pix_chave:pix_chave.value,
    banco:banco.value,
    agencia:agencia.value,
    conta:conta.value,
    observacao:observacao.value
  };

  const { error } = await sb.from("empresas").insert(dados);

  if(error){ alert("Erro ao salvar"); return; }

  alert("Empresa cadastrada com sucesso!");
  carregarEmpresas();
  document.getElementById("formEmpresa").reset();
}

// ===========================================================
// LISTAGEM
// ===========================================================
async function carregarEmpresas(){
  const { data } = await sb.from("empresas").select("*").order("nome",{ascending:true});
  window.empresas = data;
  renderLista(data);
}

function renderLista(lista){
  listaEmpresas.innerHTML = "";

  lista.forEach(e=>{
    listaEmpresas.innerHTML += `
      <div class="cardEmpresa">
        <h3>${e.nome}</h3>
        <small>${e.doc} • ${e.tipo.toUpperCase()}</small><br>
        <small>${e.cidade} - ${e.uf}</small>
      </div>
    `;
  });
}

function filtrarLista(){
  let q = busca.value.toLowerCase();
  let filtrado = window.empresas.filter(e =>
    e.nome.toLowerCase().includes(q) ||
    e.doc.toLowerCase().includes(q)
  );
  renderLista(filtrado);
}

carregarEmpresas();

</script>

</body>
</html>

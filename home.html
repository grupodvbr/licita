<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>LICITAR ‚Ä¢ Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --p:#0b1e39;
  --blue:#1e88e5;
  --bg:#f4f6fb;
  --card:#fff;
  --border:#e3e8f0;
  --ok:#2e7d32;
}

*{box-sizing:border-box;font-family:Inter}

body{
  margin:0;
  background:var(--bg);
  padding:20px;
  color:#222;
}

h1{color:var(--p);margin-bottom:20px}

/* ================= CARD ================= */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:18px;
  max-width:360px;
  cursor:pointer;
  transition:.25s;
}

.card:hover{
  box-shadow:0 12px 28px rgba(11,30,57,.08);
  transform:translateY(-2px);
}

.card-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

.card-header h3{
  margin:0;
  font-size:15px;
  color:var(--p);
}

.card-header select{
  padding:6px 10px;
  border-radius:8px;
  border:1px solid var(--border);
  font-size:12px;
}

.card-footer{
  text-align:center;
  font-weight:600;
  margin-top:10px;
  color:var(--p);
}

/* ================= MODAL ================= */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  justify-content:center;
  align-items:flex-start;
  padding-top:30px;
  z-index:1000;
}

.box{
  background:#fff;
  width:95%;
  max-width:1200px;
  max-height:90vh;
  border-radius:16px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

.header{
  padding:16px;
  border-bottom:1px solid var(--border);
  position:sticky;
  top:0;
  background:#fff;
  z-index:10;
}

.header h2{
  margin:0;
  color:var(--p);
}

.header small{
  color:#555;
}

.close{
  position:absolute;
  right:16px;
  top:16px;
  cursor:pointer;
  font-size:18px;
}

.body{
  padding:16px;
  overflow:auto;
}

/* ================= TABLE ================= */
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}

th,td{
  border-bottom:1px solid var(--border);
  padding:8px;
  text-align:center;
}

th{
  background:#f7f9fc;
  font-weight:600;
}

td:first-child,th:first-child{
  text-align:left;
}

.menor{
  color:var(--ok);
  font-weight:700;
}
</style>
</head>

<body>

<h1>Dashboard</h1>

<div class="card" onclick="abrirModal()">
  <div class="card-header">
    <h3>Itens sem pre√ßo</h3>

    <!-- üîΩ SELECT N√ÉO ABRE MODAL -->
    <select id="filtroCotacao"
      onclick="event.stopPropagation()"
      onchange="carregarIndicador()">
    </select>
  </div>

  <canvas id="grafico" height="160"></canvas>

  <div class="card-footer">
    <span id="faltantes">0</span> itens sem cota√ß√£o
  </div>
</div>

<!-- ================= MODAL ================= -->
<div class="modal" id="modal">
  <div class="box">
    <div class="header">
      <h2>Total estimado: <span id="total"></span></h2>
      <small>Menor valor √ó quantidade m√≠nima</small>
      <div class="close" onclick="fecharModal()">‚úï</div>
    </div>
    <div class="body">
      <table id="tabela"></table>
    </div>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://mblvyircwsaxaslklzky.supabase.co",
  "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x"
);

let chart;

/* ================= INIT ================= */
carregarFiltro();

/* ================= FILTRO (EMPRESA) ================= */
async function carregarFiltro(){
  const {data} = await sb.from("cotacoes")
    .select(`
      id,
      licitacao:licitacao_id(
        empresas(nome)
      )
    `)
    .eq("status","ativa");

  filtroCotacao.innerHTML="";

  data.forEach(c=>{
    const nomeEmpresa = c.licitacao?.empresas?.nome || "";
    const primeiroNome = nomeEmpresa.split(" ")[0];

    filtroCotacao.innerHTML += `
      <option value="${c.id}">
        ${primeiroNome}
      </option>
    `;
  });

  carregarIndicador();
}

/* ================= INDICADOR ================= */
async function carregarIndicador(){
  const cotacaoId = filtroCotacao.value;

  const {data} = await sb.from("cotacoes_itens")
    .select("valor_unit")
    .eq("cotacao_id",cotacaoId);

  const total = data.length;
  const faltam = data.filter(i => !i.valor_unit).length;

  faltantes.innerText = faltam;
  renderGrafico(total - faltam, faltam);
}

/* ================= GR√ÅFICO ================= */
function renderGrafico(ok,pend){
  if(chart) chart.destroy();

  chart = new Chart(grafico,{
    type:"doughnut",
    data:{
      datasets:[{
        data:[ok,pend],
        backgroundColor:["#1e88e5","#e3e8f0"],
        borderWidth:0
      }]
    },
    options:{
      cutout:"80%",
      plugins:{legend:{display:false}}
    }
  });
}

/* ================= MODAL ================= */
async function abrirModal(){
  modal.style.display="flex";
  montarTabela();
}

function fecharModal(){
  modal.style.display="none";
}

/* ================= TABELA ================= */
async function montarTabela(){
  const cotacaoId = filtroCotacao.value;

  const {data} = await sb.from("cotacoes_itens")
    .select(`
      item:item_id(item_tr,quant_min),
      valor_unit,
      cotacao:cotacao_id(fornecedor_id,empresas(nome))
    `)
    .eq("cotacao_id",cotacaoId);

  let mapa = {};
  let fornecedores = new Set();

  data.forEach(r=>{
    const item = r.item.item_tr;
    fornecedores.add(r.cotacao.empresas.nome);

    if(!mapa[item]){
      mapa[item] = {
        min: r.item.quant_min,
        vals: []
      };
    }

    mapa[item].vals.push({
      nome: r.cotacao.empresas.nome,
      valor: r.valor_unit
    });
  });

  fornecedores = [...fornecedores];

  let html = `<tr><th>Item</th><th>Qtd Min</th>`;
  fornecedores.forEach(f => html += `<th>${f}</th>`);
  html += `</tr>`;

  let total = 0;

  Object.entries(mapa).forEach(([item,o])=>{
    const menor = Math.min(...o.vals.map(v => v.valor ?? Infinity));
    total += menor * o.min;

    html += `<tr><td>${item}</td><td>${o.min}</td>`;

    fornecedores.forEach(f=>{
      const v = o.vals.find(x => x.nome === f)?.valor;
      html += `
        <td class="${v === menor ? "menor" : ""}">
          ${v ? `R$ ${v.toFixed(2)}` : "-"}
        </td>`;
    });

    html += `</tr>`;
  });

  tabela.innerHTML = html;
  total.innerText = `R$ ${total.toFixed(2)}`;
}
</script>

</body>
</html>

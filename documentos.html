<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Gerenciador de Documentos ‚Ä¢ LICITAR PREMIUM</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ===========================================================
   LICITAR DARK PREMIUM ‚Äî ESTILO BASE
=========================================================== */
:root{
  --bg:#0d0f14;
  --card:#14171d;
  --card-light:#1b1f27;
  --text:#f5f5f5;
  --text-muted:#a9a9a9;
  --border:#22252d;

  --gold:#cfa452;
  --gold-light:#e9c884;
  --gold-dark:#ad8134;

  --radius:18px;
  --shadow:0 8px 22px rgba(0,0,0,.45);
  --shadow-hover:0 12px 30px rgba(0,0,0,.6);
}

/* ===== RESET ===== */
body{
  margin:0;
  padding:40px 0;
  font-family:'Inter',sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  justify-content:center;
}

/* ===== CONTAINER ===== */
#container{
  width:92%;
  max-width:1650px;
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.05);
  padding:45px;
  border-radius:28px;
  backdrop-filter:blur(25px) saturate(180%);
  box-shadow:var(--shadow);
}

/* ===== T√çTULO ===== */
#titulo{
  text-align:center;
  margin-bottom:32px;
  font-size:34px;
  font-weight:700;
  color:var(--gold-light);
  letter-spacing:1px;
  text-shadow:0 0 12px rgba(207,164,82,.45);
}

/* ===== BUSCA ===== */
#busca{
  width:100%;
  padding:16px 20px;
  font-size:17px;
  border-radius:16px;
  background:var(--card);
  border:1px solid var(--border);
  color:var(--text);
}
#busca:focus{
  border-color:var(--gold);
  box-shadow:0 0 0 3px rgba(207,164,82,.25);
  outline:none;
}

/* ===== BREADCRUMB ===== */
#breadcrumbs{
  margin:25px 0;
  font-weight:500;
  color:var(--gold-light);
  font-size:17px;
}

/* ===== TOOLBAR ===== */
.toolbar{
  display:flex;
  gap:15px;
  flex-wrap:wrap;
  margin-bottom:35px;
}

.btn{
  padding:13px 22px;
  border:none;
  border-radius:14px;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
  transition:.22s;
  color:#fff;
  text-transform:uppercase;
  box-shadow:0 4px 14px rgba(0,0,0,.35);
}
.btn:hover{
  transform:translateY(-3px);
  opacity:.9;
}

.btn-nova{ background:var(--gold); color:#000; }
.btn-upload{ background:var(--gold-dark); }
.btn-voltar{ background:#2d2f35; }

/* ===== GRID ===== */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:32px;
}

.item{
  background:var(--card-light);
  border:1px solid var(--border);
  padding:28px 22px;
  border-radius:var(--radius);
  text-align:center;
  cursor:pointer;
  box-shadow:var(--shadow);
  transition:.25s;
}
.item:hover{
  transform:translateY(-6px);
  box-shadow:var(--shadow-hover);
}

.thumb{
  width:110px;
  height:110px;
  background:#1e2129;
  border-radius:14px;
  object-fit:cover;
  display:flex;
  justify-content:center;
  align-items:center;
  margin:auto;
}

.itemNome{
  margin-top:16px;
  font-weight:600;
  font-size:15px;
  color:var(--text);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Skeleton */
.skeleton{
  background:#1f2229;
  height:180px;
  border-radius:var(--radius);
  animation:pulse 1.4s infinite ease-in-out;
}
@keyframes pulse{
  0%{opacity:.5;}
  50%{opacity:1;}
  100%{opacity:.5;}
}

/* ========== √çCONES PREMIUM ========== */

.icon-folder{
  width:90px;
  height:auto;
  filter: drop-shadow(0 4px 6px rgba(0,0,0,.45));
}

.folder-preview{
  position:relative;
  width:110px;
  height:110px;
  margin:auto;
}
.folder-preview .mini{
  width:36px;
  height:36px;
  border-radius:6px;
  position:absolute;
  bottom:-4px;
  right:-6px;
  border:2px solid rgba(0,0,0,.4);
  object-fit:cover;
  background:#2a2d35;
}
.folder-preview .mini:nth-child(2){ right:26px; }
.folder-preview .mini:nth-child(3){ right:58px; }

/* √çcones de arquivo */
.file-icon{
  width:80px;
  height:80px;
  margin:auto;
  opacity:.8;
  filter:drop-shadow(0 4px 8px rgba(0,0,0,.5));
}
.file-icon.pdf{ content:url('https://img.icons8.com/color/96/pdf.png'); }
.file-icon.img{ content:url('https://img.icons8.com/color/96/image.png'); }
.file-icon.doc{ content:url('https://img.icons8.com/color/96/doc.png'); }
.file-icon.xls{ content:url('https://img.icons8.com/color/96/xls.png'); }
.file-icon.video{ content:url('https://img.icons8.com/color/96/video.png'); }
.file-icon.zip{ content:url('https://img.icons8.com/color/96/zip.png'); }
.file-icon.generic{ content:url('https://img.icons8.com/fluency/96/file.png'); }

/* =============== MODAL =============== */

#modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999999;
}
#modalBox{
  background:var(--card-light);
  padding:30px;
  width:95%;
  max-width:900px;
  border-radius:26px;
  border:1px solid rgba(255,255,255,0.08);
}
#modalPreview{
  width:100%;
  height:520px;
  background:#0f1116;
  border-radius:16px;
  border:1px solid var(--border);
  margin-top:12px;
}
.modal-buttons{
  margin-top:18px;
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}

/* ============ MENU MOVER ============ */

#moveMenu{
  position:fixed;
  right:-420px;
  top:0;
  width:380px;
  height:100%;
  background:rgba(20,23,29,0.96);
  box-shadow:-6px 0 18px rgba(0,0,0,.55);
  border-left:1px solid rgba(255,255,255,0.05);
  padding:28px 20px;
  z-index:9999999;
  transition:.35s ease;
}
#moveMenu.open{ right:0; }

#moveList{
  max-height:65vh;
  overflow-y:auto;
  padding-right:8px;
}

.moveItem{
  padding:12px;
  margin-bottom:10px;
  border-radius:12px;
  background:var(--card);
  border:1px solid var(--border);
  cursor:pointer;
}
.moveItem:hover{ background:#1f2229; }

/* ============ POPUPS ============ */

#popupCriar, #popupUpload{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:99999;
}
#popupBox, #uploadBox{
  background:var(--card-light);
  padding:32px;
  width:90%;
  max-width:460px;
  border-radius:22px;
}
#dropArea{
  border:2px dashed var(--gold);
  padding:45px;
  text-align:center;
  border-radius:18px;
  margin-top:20px;
  color:var(--gold-light);
}
#dropArea.dragover{
  background:rgba(207,164,82,0.15);
  border-color:var(--gold-light);
}

</style>
</head>

<body>

<!-- =======================
     CONTAINER PRINCIPAL
======================= -->
<div id="container">

  <h1 id="titulo">Gerenciador de Documentos ‚Ä¢ LICITAR PREMIUM</h1>

  <input id="busca" placeholder="Pesquisar documentos..." onkeyup="pesquisar()">

  <div id="breadcrumbs">üìÅ Raiz</div>

  <div class="toolbar">
    <button class="btn btn-nova" onclick="abrirPopupCriar()">üìÅ Nova Pasta</button>
    <button class="btn btn-upload" onclick="abrirUpload()">‚¨Ü Upload</button>
    <button class="btn btn-voltar" onclick="voltarPasta()">‚¨Ö Voltar</button>
  </div>

  <div id="lista" class="grid"></div>

</div>

<!-- =======================
     POPUP CRIAR PASTA
======================= -->
<div id="popupCriar">
  <div id="popupBox">
    <h3 style="color:var(--gold-light)">Criar Pasta</h3>
    <input id="nomePasta" placeholder="Nome da pasta" style="width:100%;padding:14px;border-radius:12px;margin-top:10px;">
    <button onclick="criarPasta()" class="btn btn-nova" style="margin-top:20px;width:100%;">Criar</button>
    <button onclick="fecharPopupCriar()" class="btn btn-voltar" style="margin-top:12px;width:100%;">Cancelar</button>
  </div>
</div>

<!-- =======================
     POPUP UPLOAD
======================= -->
<div id="popupUpload">
  <div id="uploadBox">
    <h3 style="color:var(--gold-light)">Enviar Arquivo</h3>

    <select id="uploadDestino" style="width:100%;padding:12px;border-radius:12px;margin-top:8px;"></select>

    <div id="dropArea">Arraste arquivos aqui<br>ou clique para selecionar</div>
    <input id="uploadInput" type="file" multiple style="display:none">

    <button onclick="enviarUpload()" class="btn btn-upload" style="width:100%;margin-top:20px;">Enviar</button>
    <button onclick="fecharUpload()" class="btn btn-voltar" style="margin-top:12px;width:100%;">Cancelar</button>
  </div>
</div>

<!-- =======================
     MODAL VISUALIZA√á√ÉO
======================= -->
<div id="modal">
  <div id="modalBox">

    <button onclick="fecharModal()" class="btn btn-voltar" style="float:right;margin-bottom:15px;">Fechar</button>

    <h2 id="modalTitulo" style="color:var(--gold-light);margin-bottom:10px;"></h2>

    <iframe id="modalPreview"></iframe>

    <div class="modal-buttons">
      <button onclick="baixarArquivo()" class="btn btn-upload">‚¨á Download</button>
      <button onclick="abrirMover()" class="btn btn-nova">üìÅ Mover</button>
      <button onclick="excluirArquivo()" class="btn" style="background:#d9534f;">üóë Excluir</button>
    </div>

  </div>
</div>

<!-- =======================
     MENU LATERAL MOVER
======================= -->
<div id="moveMenu">
  <h3 style="color:var(--gold-light)">Mover Arquivo</h3>

  <input id="moveSearch" placeholder="Pesquisar pasta..."
         style="width:100%;padding:12px;border-radius:12px;margin-bottom:15px;">

  <div id="moveList"></div>

  <button class="btn btn-voltar" style="width:100%;margin-top:18px;" onclick="fecharMover()">
    Fechar
  </button>
</div>


<!-- =======================
     SCRIPT PRINCIPAL
======================= -->
<script>
/* =============================
   CONFIG SUPABASE
============================= */
const SUPABASE_URL = "https://mblvyircwsaxaslklzky.supabase.co";
const SUPABASE_KEY = "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let usuario = localStorage.getItem("usuarioEmail") || "desconhecido";
let pastaAtual = null;
let historicoPastas = [];
let dadosPastas = [];
let dadosDocs = [];
let linkAtual = "";
let arquivoAtualID = null;

/* ============ IN√çCIO ============ */
window.onload = () => {
  renderSkeleton();
  carregarTudo();
};

/* Loader */
function renderSkeleton(){
  let html="";
  for(let i=0;i<12;i++) html+=`<div class="skeleton"></div>`;
  document.getElementById("lista").innerHTML = html;
}

/* Carregar */
async function carregarTudo(){
  const p = await sb.from("pastas").select("*");
  dadosPastas = p.data || [];

  const d = await sb.from("documentos").select("*");
  dadosDocs = d.data || [];

  preencherDestinoUpload();
  mostrarPasta(null);
}

/* Mostrar pasta */
function mostrarPasta(id){
  pastaAtual = id;
  historicoPastas.push(id);

  let nome = id ? dadosPastas.find(x=>x.id===id)?.nome : "Raiz";
  document.getElementById("breadcrumbs").innerHTML = "üìÅ " + nome;

  const pastas = dadosPastas.filter(p=>p.pai_id === id);
  const docs = dadosDocs.filter(d=>d.pasta_id === id);

  let html = "";

  /* Pastas */
  pastas.forEach(p=>{
    const thumbs = dadosDocs.filter(x=>x.pasta_id===p.id).slice(0,3);
    let mini="";
    thumbs.forEach(a=> mini+=`<img class="mini" src="${a.url}">`);
    html+=`
      <div class="item" onclick="entrarPasta('${p.id}')">
        <div class="folder-preview">
          <img src="https://img.icons8.com/fluency/96/folder-invoices.png" class="icon-folder">
          ${mini}
        </div>
        <div class="itemNome">${p.nome}</div>
      </div>`;
  });

  /* Arquivos */
  docs.forEach(d=>{
    html+=`
      <div class="item" onclick="abrirArquivo('${d.nome}','${d.url}','${d.id}')">
        ${thumbDoc(d)}
        <div class="itemNome">${d.nome}</div>
      </div>`;
  });

  document.getElementById("lista").innerHTML = html || "<p>Vazio.</p>";
}

/* Thumb inteligente */
function thumbDoc(doc){
  let ext = doc.nome.split(".").pop().toLowerCase();

  const IMGS = ["jpg","jpeg","png","gif","webp"];
  if(IMGS.includes(ext)) return `<img class="thumb" src="${doc.url}">`;

  if(ext==="pdf") return `<div class="file-icon pdf"></div>`;
  if(["doc","docx"].includes(ext)) return `<div class="file-icon doc"></div>`;
  if(["xls","xlsx"].includes(ext)) return `<div class="file-icon xls"></div>`;
  if(["mp4","mkv","avi"].includes(ext)) return `<div class="file-icon video"></div>`;
  if(["zip","rar","7z"].includes(ext)) return `<div class="file-icon zip"></div>`;

  return `<div class="file-icon generic"></div>`;
}

/* Entrar pasta */
function entrarPasta(id){
  mostrarPasta(id);
}

/* Voltar */
function voltarPasta(){
  if(historicoPastas.length>1){
    historicoPastas.pop();
    mostrarPasta(historicoPastas[historicoPastas.length-1]);
  }
}

/* Criar Pasta */
function abrirPopupCriar(){ popupCriar.style.display="flex"; }
function fecharPopupCriar(){ popupCriar.style.display="none"; nomePasta.value=""; }

async function criarPasta(){
  const nome = nomePasta.value.trim();
  if(!nome) return alert("Digite o nome.");

  await sb.from("pastas").insert({
    nome,
    capa:"gold",
    pai_id:pastaAtual,
    criado_por:usuario
  });

  fecharPopupCriar();
  carregarTudo();
}

/* Upload */
function abrirUpload(){ popupUpload.style.display="flex"; }
function fecharUpload(){ popupUpload.style.display="none"; }

function preencherDestinoUpload(){
  uploadDestino.innerHTML="";
  dadosPastas.forEach(p=>{
    uploadDestino.innerHTML+=`<option value="${p.id}">${p.nome}</option>`;
  });
}

dropArea.onclick = ()=> uploadInput.click();

dropArea.ondragover = e=>{ e.preventDefault(); dropArea.classList.add("dragover"); };
dropArea.ondragleave = ()=> dropArea.classList.remove("dragover");

dropArea.ondrop = e=>{
  e.preventDefault();
  dropArea.classList.remove("dragover");
  enviarArquivos(e.dataTransfer.files);
};

function enviarUpload(){ enviarArquivos(uploadInput.files); }

async function enviarArquivos(files){
  const destino = uploadDestino.value;

  for(const file of files){
    const caminho = Date.now()+"_"+file.name;
    await sb.storage.from("documentos").upload(caminho,file);
    const url = `${SUPABASE_URL}/storage/v1/object/public/documentos/${caminho}`;

    const doc = await sb.from("documentos").insert({
      pasta_id: destino,
      nome:file.name,
      tipo:file.type,
      tamanho:file.size,
      url,
      criado_por:usuario
    });
  }

  fecharUpload();
  carregarTudo();
}

/* Modal */
function abrirArquivo(nome,url,id){
  modalTitulo.innerText = nome;
  modalPreview.src = url;
  arquivoAtualID = id;
  linkAtual = url;
  modal.style.display="flex";
}
function fecharModal(){ modal.style.display="none"; }

function baixarArquivo(){
  const a = document.createElement("a");
  a.href = linkAtual;
  a.download = "";
  a.click();
}

/* Excluir */
async function excluirArquivo(){
  if(!confirm("Excluir?")) return;
  await sb.from("documentos").delete().eq("id",arquivoAtualID);
  fecharModal();
  carregarTudo();
}

/* MOVER */
function abrirMover(){ moveMenu.classList.add("open"); montarListaMover(); }
function fecharMover(){ moveMenu.classList.remove("open"); }

function montarListaMover(){
  moveList.innerHTML="";
  dadosPastas.forEach(p=>{
    moveList.innerHTML+=`
      <div class="moveItem" onclick="moverArquivo('${p.id}')">üìÅ ${p.nome}</div>
    `;
  });
}

async function moverArquivo(dest){
  await sb.from("documentos").update({pasta_id:dest}).eq("id",arquivoAtualID);
  fecharMover();
  fecharModal();
  carregarTudo();
}

/* Busca mover */
moveSearch.onkeyup = ()=>{
  let q = moveSearch.value.toLowerCase();
  moveList.innerHTML="";
  dadosPastas
    .filter(p=>p.nome.toLowerCase().includes(q))
    .forEach(p=>{
      moveList.innerHTML+=`<div class="moveItem" onclick="moverArquivo('${p.id}')">üìÅ ${p.nome}</div>`;
    });
};

/* Busca global */
function pesquisar(){
  let q = busca.value.toLowerCase().trim();
  if(!q){ mostrarPasta(pastaAtual); return; }

  let resultados = [
    ...dadosPastas.filter(p=>p.nome.toLowerCase().includes(q)),
    ...dadosDocs.filter(d=>d.nome.toLowerCase().includes(q))
  ];

  let html="";
  resultados.forEach(item=>{
    if(item.capa){
      html+=`
        <div class="item" onclick="entrarPasta('${item.id}')">
          <img src="https://img.icons8.com/fluency/96/folder-invoices.png" class="icon-folder">
          <div class="itemNome">${item.nome}</div>
        </div>`;
    } else {
      html+=`
        <div class="item" onclick="abrirArquivo('${item.nome}','${item.url}','${item.id}')">
          ${thumbDoc(item)}
          <div class="itemNome">${item.nome}</div>
        </div>`;
    }
  });

  lista.innerHTML = html || "<p>Nenhum resultado.</p>";
  breadcrumbs.innerHTML = "üîç Resultados da busca";
}
</script>

</body>
</html>

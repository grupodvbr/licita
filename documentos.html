<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Gerenciador de Documentos ‚Ä¢ LICITAR PREMIUM</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ===========================================================
   LICITAR DARK PREMIUM ‚Äî ESTILO BASE
   =========================================================== */
:root{
  --bg:#0d0f14;
  --card:#14171d;
  --card-light:#1b1f27;
  --text:#f5f5f5;
  --text-muted:#a9a9a9;
  --border:#22252d;

  --gold:#cfa452;
  --gold-light:#e9c884;
  --gold-dark:#ad8134;

  --radius:18px;
  --shadow:0 8px 22px rgba(0,0,0,.45);
  --shadow-hover:0 12px 30px rgba(0,0,0,.6);
}

/* ======= RESET ======== */
body{
  margin:0;
  padding:40px 0;
  font-family:'Inter',sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  justify-content:center;
}

/* ======= CONTAINER ======== */
#container{
  width:92%;
  max-width:1650px;
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.05);
  padding:45px;
  border-radius:28px;
  backdrop-filter:blur(25px) saturate(180%);
  box-shadow:var(--shadow);
}

/* ======= T√çTULO ======== */
#titulo{
  text-align:center;
  margin-bottom:32px;
  font-size:34px;
  font-weight:700;
  color:var(--gold-light);
  letter-spacing:1px;
  text-shadow:0 0 12px rgba(207,164,82,.45);
}

/* ======= BUSCA ======== */
#busca{
  width:100%;
  padding:16px 20px;
  font-size:17px;
  border-radius:16px;
  background:var(--card);
  border:1px solid var(--border);
  color:var(--text);
  transition:.25s;
}
#busca:focus{
  border-color:var(--gold);
  box-shadow:0 0 0 3px rgba(207,164,82,.25);
  outline:none;
}

/* ======= BREADCRUMB ======== */
#breadcrumbs{
  margin:25px 0;
  font-weight:500;
  color:var(--gold-light);
  font-size:17px;
}

/* ======= TOOLBAR ======== */
.toolbar{
  display:flex;
  gap:15px;
  flex-wrap:wrap;
  margin-bottom:35px;
}

.btn{
  padding:13px 22px;
  border:none;
  border-radius:14px;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
  transition:.22s;
  color:#fff;
  text-transform:uppercase;
  box-shadow:0 4px 14px rgba(0,0,0,.35);
}

.btn:hover{
  transform:translateY(-3px);
  opacity:.9;
}

.btn-nova{ background:var(--gold); color:#000; }
.btn-upload{ background:var(--gold-dark); }
.btn-voltar{ background:#2d2f35; }

/* ======= GRID ======== */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:32px;
}

/* BASE DO CARD (PASTA/ARQUIVO) ‚Äî ser√° refinado na Parte 2 */
.item{
  background:var(--card-light);
  border:1px solid var(--border);
  padding:28px 22px;
  border-radius:var(--radius);
  text-align:center;
  cursor:pointer;
  box-shadow:var(--shadow);
  transition:.25s;
}
.item:hover{
  transform:translateY(-6px);
  box-shadow:var(--shadow-hover);
}

/* Thumbnail base */
.thumb{
  width:110px;
  height:110px;
  background:#1e2129;
  border-radius:14px;
  object-fit:cover;
  display:flex;
  justify-content:center;
  align-items:center;
  margin:auto;
}

/* Nome do item */
.itemNome{
  margin-top:16px;
  font-weight:600;
  font-size:15px;
  color:var(--text);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Skeleton */
.skeleton{
  background:#1f2229;
  height:180px;
  border-radius:var(--radius);
  animation:pulse 1.4s infinite ease-in-out;
}
@keyframes pulse{
  0%{opacity:.5;}
  50%{opacity:1;}
  100%{opacity:.5;}
}
/* ============================================================
   PARTE 2 ‚Äî CSS AVAN√áADO (LICITAR DARK PREMIUM)
   ============================================================ */

/* =======================
   √çCONES PREMIUM
======================= */

.icon-folder{
  width:90px;
  height:auto;
  filter: drop-shadow(0 4px 6px rgba(0,0,0,.45));
}

.folder-preview{
  position:relative;
  width:110px;
  height:110px;
  margin:auto;
}

.folder-preview .mini{
  width:36px;
  height:36px;
  border-radius:6px;
  position:absolute;
  bottom:-4px;
  right:-6px;
  border:2px solid rgba(0,0,0,.4);
  object-fit:cover;
  background:#2a2d35;
}

/* Quando houver 2 arquivos */
.folder-preview .mini:nth-child(2){
  right:26px;
  bottom:0px;
}

/* Quando houver 3 arquivos */
.folder-preview .mini:nth-child(3){
  right:58px;
  bottom:4px;
}

/* =======================
   Tipos de arquivos
======================= */

.file-icon{
  width:80px;
  height:80px;
  margin:auto;
  opacity:.8;
  filter:drop-shadow(0 4px 8px rgba(0,0,0,.5));
}

/* PDF */
.file-icon.pdf{ content:url('https://img.icons8.com/color/96/pdf.png'); }

/* IMAGENS */
.file-icon.img{ content:url('https://img.icons8.com/color/96/image.png'); }

/* DOC */
.file-icon.doc{ content:url('https://img.icons8.com/color/96/doc.png'); }

/* XLS */
.file-icon.xls{ content:url('https://img.icons8.com/color/96/xls.png'); }

/* V√çDEO */
.file-icon.video{ content:url('https://img.icons8.com/color/96/video.png'); }

/* ZIP */
.file-icon.zip{ content:url('https://img.icons8.com/color/96/zip.png'); }

/* GEN√âRICO */
.file-icon.generic{ content:url('https://img.icons8.com/fluency/96/file.png'); }

/* =======================
   MODAL PREMIUM
======================= */

#modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999999;
  animation:fadeIn .25s ease-out;
}

#modalBox{
  background:var(--card-light);
  padding:30px;
  width:95%;
  max-width:900px;
  border-radius:26px;
  box-shadow:0 0 20px rgba(0,0,0,.6);
  border:1px solid rgba(255,255,255,0.08);
  animation:pop .25s ease-out;
}

#modalPreview{
  width:100%;
  height:520px;
  margin-top:12px;
  background:#0f1116;
  border-radius:16px;
  border:1px solid var(--border);
}

#modalTitulo{
  margin:0;
  padding:0;
  color:var(--gold-light);
  font-size:22px;
  font-weight:600;
  text-shadow:0 0 12px rgba(207,164,82,.45);
}

/* Bot√µes do modal */
.modal-buttons{
  margin-top:18px;
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}

/* =======================
   MENU LATERAL (MOVER)
======================= */

#moveMenu{
  position:fixed;
  right:-420px;
  top:0;
  width:380px;
  height:100%;
  background:rgba(20,23,29,0.96);
  box-shadow:-6px 0 18px rgba(0,0,0,.55);
  border-left:1px solid rgba(255,255,255,0.05);
  backdrop-filter:blur(30px);
  padding:28px 20px;
  z-index:9999999;
  transition:.35s ease;
}

#moveMenu.open{
  right:0;
}

#moveMenu h3{
  margin:0 0 15px 0;
  color:var(--gold);
  font-size:20px;
  font-weight:600;
}

#moveSearch{
  width:100%;
  padding:12px 16px;
  border-radius:14px;
  border:1px solid var(--border);
  background:#101217;
  color:#fff;
  margin-bottom:18px;
}

#moveList{
  max-height:65vh;
  overflow-y:auto;
  padding-right:8px;
}

.moveItem{
  padding:12px;
  margin-bottom:10px;
  border-radius:12px;
  background:var(--card);
  border:1px solid var(--border);
  cursor:pointer;
  transition:.22s;
  color:var(--text);
}
.moveItem:hover{
  background:#1f2229;
}

/* =======================
   POPUP (CRIAR / UPLOAD)
======================= */

#popupCriar, #popupUpload{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:99999;
  animation:fadeIn .25s ease-out;
}

#popupBox, #uploadBox{
  background:var(--card-light);
  padding:32px;
  width:90%;
  max-width:460px;
  border-radius:22px;
  border:1px solid rgba(255,255,255,.08);
  box-shadow:0 0 15px rgba(0,0,0,.45);
  animation:pop .22s ease-out;
}

input, select{
  background:#121418;
  border:1px solid var(--border);
  color:#fff;
}

/* =======================
   DRAG & DROP √Ä LA LICITAR
======================= */

#dropArea{
  border:2px dashed var(--gold);
  padding:45px;
  text-align:center;
  border-radius:18px;
  margin-top:20px;
  background:rgba(255,255,255,0.03);
  font-size:16px;
  transition:.25s;
  color:var(--gold-light);
}
#dropArea.dragover{
  background:rgba(207,164,82,0.15);
  border-color:var(--gold-light);
}

/* =======================
   ANIMA√á√ïES
======================= */
@keyframes fadeIn{
  from{opacity:0;}
  to{opacity:1;}
}

@keyframes pop{
  from{transform:scale(.92);opacity:0;}
  to{transform:scale(1);opacity:1;}
}
</style>

<script>

/* =============================
   CONFIG SUPABASE
============================= */
const SUPABASE_URL = "https://mblvyircwsaxaslklzky.supabase.co";
const SUPABASE_KEY = "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let usuario = localStorage.getItem("usuarioEmail") || "desconhecido";
let pastaAtual = null;
let historicoPastas = [];
let dadosPastas = [];
let dadosDocs = [];
let linkAtual = "";
let arquivoAtualID = null;
let corEscolhida = null;

/* =============================
   LOADING
============================= */
window.onload = () => {
  renderSkeleton();
  carregarTudo();
};

function renderSkeleton(){
  let html="";
  for(let i=0;i<12;i++){
    html+=`<div class="skeleton"></div>`;
  }
  document.getElementById("lista").innerHTML = html;
}

/* =============================
   CARREGAR TUDO
============================= */
async function carregarTudo(){
  const p = await sb.from("pastas").select("*");
  dadosPastas = p.data || [];

  const d = await sb.from("documentos").select("*");
  dadosDocs = d.data || [];

  preencherDestinoUpload();
  mostrarPasta(null);
}

/* ======================================================
   MOSTRAR PASTA (AGORA COM MINIATURAS NOS FOLDERS)
   ====================================================== */
function mostrarPasta(id){
  pastaAtual = id;
  historicoPastas.push(id);

  let nome = id ? dadosPastas.find(x=>x.id===id)?.nome : "Raiz";
  document.getElementById("breadcrumbs").innerHTML = "üìÅ " + nome;

  const pastas = dadosPastas.filter(p=>p.pai_id === id);
  const docs = dadosDocs.filter(d=>d.pasta_id === id);

  let html = "";

  /* ======== PASTAS COM MINIATURAS ======== */
  pastas.forEach(p=>{
    // pegar at√© 3 arquivos da pasta
    const arquivos = dadosDocs.filter(x=>x.pasta_id === p.id).slice(0,3);

    let miniaturas = "";
    arquivos.forEach(arq=>{
      miniaturas += `
        <img class="mini" src="${arq.url}">
      `;
    });

    html += `
      <div class="item" onclick="entrarPasta('${p.id}')" draggable="false">
        <div class="folder-preview">
          <img src="https://img.icons8.com/fluency/96/folder-invoices.png" class="icon-folder">
          ${miniaturas}
        </div>
        <div class="itemNome">${p.nome}</div>
      </div>`;
  });

  /* ======== ARQUIVOS ======== */
  docs.forEach(d=>{
    let thumb = thumbDoc(d);
    html += `
      <div class="item fileCard" 
           onclick="abrirArquivo('${d.nome}','${d.url}','${d.id}')"
           draggable="true"
           ondragstart="iniciarDrag(event,'${d.id}')">
        ${thumb}
        <div class="itemNome">${d.nome}</div>
      </div>`;
  });

  document.getElementById("lista").innerHTML = html || "<p style='padding:20px'>Vazio.</p>";
}

/* ======================================================
   THUMBNAIL DO ARQUIVO (seleciona √≠cone automaticamente)
   ====================================================== */
function thumbDoc(doc){
  let ext = doc.nome.split(".").pop().toLowerCase();
  const imgs = ["jpg","jpeg","png","gif","webp"];
  const pdf = ["pdf"];
  const docx = ["doc","docx"];
  const xls = ["xls","xlsx"];
  const video = ["mp4","mov","avi","mkv"];
  const zip = ["zip","rar","7z"];

  if(imgs.includes(ext)) return `<img class="thumb" src="${doc.url}">`;
  if(pdf.includes(ext)) return `<div class="file-icon pdf"></div>`;
  if(docx.includes(ext)) return `<div class="file-icon doc"></div>`;
  if(xls.includes(ext)) return `<div class="file-icon xls"></div>`;
  if(video.includes(ext)) return `<div class="file-icon video"></div>`;
  if(zip.includes(ext)) return `<div class="file-icon zip"></div>`;
  
  return `<div class="file-icon generic"></div>`;
}

/* =============================
   NAVEGA√á√ÉO
============================= */
function entrarPasta(id){
  mostrarPasta(id);
}

function voltarPasta(){
  if(historicoPastas.length > 1){
    historicoPastas.pop();
    mostrarPasta(historicoPastas[historicoPastas.length-1]);
  }
}

/* =============================
   CRIAR PASTA
============================= */
document.querySelectorAll(".colorSelect").forEach(c=>{
  c.onclick = ()=>{
    document.querySelectorAll(".colorSelect").forEach(x=>x.classList.remove("active"));
    c.classList.add("active");
    corEscolhida = c.dataset.cor;
  };
});

function abrirPopupCriar(){ document.getElementById("popupCriar").style.display="flex"; }
function fecharPopupCriar(){
  document.getElementById("popupCriar").style.display="none";
  document.getElementById("nomePasta").value="";
  corEscolhida=null;
}

async function criarPasta(){
  const nome = document.getElementById("nomePasta").value.trim();
  if(!nome) return alert("Digite o nome.");

  await sb.from("pastas").insert({
    nome,
    capa:"gold",
    pai_id:pastaAtual,
    criado_por:usuario
  });

  fecharPopupCriar();
  carregarTudo();
}

/* =============================
   UPLOAD
============================= */
function abrirUpload(){ document.getElementById("popupUpload").style.display="flex"; }
function fecharUpload(){ document.getElementById("popupUpload").style.display="none"; }

function preencherDestinoUpload(){
  const sel = document.getElementById("uploadDestino");
  sel.innerHTML = "";

  dadosPastas.forEach(p=>{
    sel.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
  });
}

/* drag drop */
const drop = document.getElementById("dropArea");

drop.onclick = ()=> document.getElementById("uploadInput").click();
drop.ondragover = e=>{
  e.preventDefault();
  drop.classList.add("dragover");
};
drop.ondragleave = ()=> drop.classList.remove("dragover");
drop.ondrop = e=>{
  e.preventDefault();
  drop.classList.remove("dragover");
  enviarArquivos(e.dataTransfer.files);
};

function enviarUpload(){ enviarArquivos(document.getElementById("uploadInput").files); }

async function enviarArquivos(files){
  const destino = document.getElementById("uploadDestino").value;

  for(const file of files){
    const caminho = Date.now()+"_"+file.name;
    await sb.storage.from("documentos").upload(caminho, file);

    const url = `${SUPABASE_URL}/storage/v1/object/public/documentos/${caminho}`;

    const doc = await sb.from("documentos").insert({
      pasta_id: destino,
      nome: file.name,
      tipo: file.type,
      tamanho: file.size,
      url,
      criado_por: usuario
    });

    await sb.from("historico_documentos").insert({
      documento_id: doc.data[0].id,
      usuario,
      acao:"CRIADO"
    });
  }

  fecharUpload();
  carregarTudo();
}

/* ======================================================
   MODAL DE ARQUIVO
====================================================== */
function abrirArquivo(nome,url,id){
  arquivoAtualID = id;
  linkAtual = url;

  document.getElementById("modalTitulo").innerText = nome;
  document.getElementById("modalPreview").src = url;
  document.getElementById("modal").style.display="flex";

  sb.from("historico_documentos").insert({
    documento_id:id,
    usuario,
    acao:"VISUALIZADO"
  });
}

function fecharModal(){
  document.getElementById("modal").style.display="none";
}

/* DOWNLOAD */
function baixarArquivo(){
  const a = document.createElement("a");
  a.href = linkAtual;
  a.download = "";
  a.click();
}

/* EXCLUIR */
async function excluirArquivo(){
  if(!confirm("Excluir arquivo?")) return;

  await sb.from("documentos").delete().eq("id", arquivoAtualID);

  fecharModal();
  carregarTudo();
}

/* ======================================================
   MENU LATERAL ‚Äî MOVER ARQUIVO
====================================================== */
function abrirMover(){
  document.getElementById("moveMenu").classList.add("open");
  montarListaMover();
}

function fecharMover(){
  document.getElementById("moveMenu").classList.remove("open");
}

function montarListaMover(){
  const box = document.getElementById("moveList");
  box.innerHTML = "";

  dadosPastas.forEach(p=>{
    box.innerHTML += `
      <div class="moveItem" onclick="moverArquivo('${p.id}')">
        üìÅ ${p.nome}
      </div>
    `;
  });
}

async function moverArquivo(destino){
  await sb.from("documentos").update({ pasta_id: destino }).eq("id", arquivoAtualID);

  fecharMover();
  fecharModal();
  carregarTudo();
}

/* BUSCA DENTRO DO MENU LATERAL */
document.getElementById("moveSearch").onkeyup = ()=>{
  let q = document.getElementById("moveSearch").value.toLowerCase().trim();
  const box = document.getElementById("moveList");
  box.innerHTML = "";

  dadosPastas
    .filter(p => p.nome.toLowerCase().includes(q))
    .forEach(p=>{
      box.innerHTML += `
        <div class="moveItem" onclick="moverArquivo('${p.id}')">
          üìÅ ${p.nome}
        </div>
      `;
    });
};

/* ======================================================
   DRAG & DROP ‚Äî C√ìPIA (N√ÉO MOVE)
====================================================== */
let arquivoDragID = null;

function iniciarDrag(e,id){
  arquivoDragID = id;
  e.dataTransfer.setData("text/plain", id);
}

/* Colocar drop nas pastas */
document.addEventListener("dragover", e=>e.preventDefault());
document.addEventListener("drop", async e=>{
  const item = e.target.closest(".item");
  if(!item) return;

  const nome = item.querySelector(".itemNome")?.innerText;

  const pastaAlvo = dadosPastas.find(x=>x.nome===nome);
  if(!pastaAlvo) return;  // pasta n√£o encontrada

  // copiar arquivo
  const original = dadosDocs.find(x=>x.id == arquivoDragID);
  if(!original) return;

  await sb.from("documentos").insert({
    pasta_id: pastaAlvo.id,
    nome: original.nome,
    tipo: original.tipo,
    tamanho: original.tamanho,
    url: original.url,
    criado_por: usuario
  });

  carregarTudo();
});

/* ======================================================
   BUSCA GLOBAL
====================================================== */
function pesquisar(){
  const q = document.getElementById("busca").value.toLowerCase().trim();

  if(!q){ mostrarPasta(pastaAtual); return; }

  const resultados = [
    ...dadosPastas.filter(p=>p.nome.toLowerCase().includes(q)),
    ...dadosDocs.filter(d=>d.nome.toLowerCase().includes(q))
  ];

  let html = "";

  resultados.forEach(item=>{
    if(item.capa){ 
      html += `
        <div class="item" onclick="entrarPasta('${item.id}')">
          <img src="https://img.icons8.com/fluency/96/folder-invoices.png" class="icon-folder">
          <div class="itemNome">${item.nome}</div>
        </div>`;
    } 
    else {
      const thumb = thumbDoc(item);
      html += `
        <div class="item" onclick="abrirArquivo('${item.nome}','${item.url}','${item.id}')">
          ${thumb}
          <div class="itemNome">${item.nome}</div>
        </div>`;
    }
  });

  document.getElementById("breadcrumbs").innerHTML = "üîç Resultados da busca";
  document.getElementById("lista").innerHTML =
    html || "<div style='padding:20px'>Nenhum resultado encontrado.</div>";
}
</script>
   <!-- MENU LATERAL FLUTUANTE ‚Äì MOVER ARQUIVO -->
<div id="moveMenu">
  <h3>Mover Arquivo</h3>

  <input id="moveSearch" placeholder="Pesquisar pasta...">

  <div id="moveList"></div>

  <button class="btn btn-voltar" style="width:100%;margin-top:18px;" onclick="fecharMover()">
    Fechar
  </button>
</div>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Documentos ‚Ä¢ LICITAR</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ============================================================
    APPLE LIGHT PREMIUM ‚Äî VISUAL A1 (iCloud/Finder)
============================================================ */
:root{
  --bg:#f5f6f7;
  --card:#ffffff;
  --border:#e5e7eb;
  --text:#1d1d1f;
  --muted:#6f6f70;

  --blue:#007aff;
  --purple:#6e56cf;
  --gray:#8e8e93;

  --radius:14px;
  --shadow:0 4px 16px rgba(0,0,0,.06);
  --shadow-hover:0 8px 24px rgba(0,0,0,.10);
}

/* BODY */
body{
  margin:0;
  padding:25px;
  background:var(--bg);
  font-family:'Inter',sans-serif;
  color:var(--text);
  display:flex;
  justify-content:center;
}

/* CONTAINER */
#container{
  width:94%;
  max-width:1400px;
  background:var(--card);
  padding:28px 36px;
  border-radius:22px;
  box-shadow:var(--shadow);
}

/* T√çTULO */
#titulo{
  text-align:center;
  margin-top:5px;
  margin-bottom:22px;
  font-size:28px;
  font-weight:700;
  color:#0b1e39;
  letter-spacing:-0.5px;
}

/* BUSCA */
#busca{
  width:100%;
  padding:13px 18px;
  border-radius:12px;
  border:1px solid var(--border);
  background:white;
  font-size:15px;
  transition:.2s;
}
#busca:focus{
  border-color:var(--blue);
  box-shadow:0 0 0 3px #007aff33;
  outline:none;
}

/* BREADCRUMB */
#breadcrumbs{
  margin:16px 0 26px 0;
  font-size:15px;
  font-weight:500;
  color:var(--gray);
}

/* TOOLBAR */
.toolbar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:24px;
}

.btn{
  padding:10px 18px;
  font-size:14px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
  color:white;
  transition:.18s;
}
.btn:hover{
  transform:translateY(-2px);
  opacity:.95;
}

.btn-nova{ background:var(--blue); }
.btn-upload{ background:var(--purple); }
.btn-voltar{ background:var(--gray); }

/* GRID */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  grid-gap:22px;
}

/* ITEM CARD */
.item{
  background:white;
  padding:18px 14px;
  border-radius:var(--radius);
  border:1px solid var(--border);
  text-align:center;
  cursor:pointer;
  box-shadow:var(--shadow);
  transition:.22s;
}
.item:hover{
  transform:translateY(-4px);
  box-shadow:var(--shadow-hover);
}

/* √çCONES PEQUENOS */
.thumb{
  width:70px;
  height:70px;
  border-radius:14px;
  object-fit:cover;
  margin:auto;
  background:#f0f0f0;
}

/* Nomes */
.itemNome{
  margin-top:10px;
  font-size:14px;
  font-weight:600;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

/* POPUPS */
#popupCriar,#popupUpload{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}

#popupBox,#uploadBox{
  background:white;
  padding:26px;
  width:90%;
  max-width:420px;
  border-radius:18px;
  box-shadow:var(--shadow-hover);
  animation:fade .25s ease-out;
}

@keyframes fade{
  from{opacity:0;transform:translateY(15px);}
  to{opacity:1;transform:none;}
}

/* CORES PASTAS */
.colorRow{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:14px;
}

.colorSelect{
  width:28px;
  height:28px;
  border-radius:50%;
  cursor:pointer;
  border:3px solid transparent;
}
.colorSelect.active{
  border-color:#000;
}

/* DROP AREA */
#dropArea{
  border:2px dashed var(--border);
  padding:30px;
  text-align:center;
  border-radius:12px;
  background:#fafafa;
  margin-top:15px;
  transition:.2s;
}
#dropArea.dragover{
  background:#eaf2ff;
  border-color:var(--blue);
}

/* MODAL */
#modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999999;
}

#modalBox{
  background:white;
  width:90%;
  max-width:820px;
  padding:24px;
  border-radius:20px;
  box-shadow:var(--shadow-hover);
}

#modalPreview{
  width:100%;
  height:420px;
  border-radius:12px;
  border:none;
  margin-top:10px;
  background:#f2f2f2;
}

/* Skeleton */
.skeleton{
  background:#ececec;
  height:130px;
  border-radius:14px;
}
</style>
</head>

<body>

<div id="container">

  <h1 id="titulo">Gerenciador de Documentos</h1>

  <input id="busca" placeholder="Pesquisar..." onkeyup="pesquisar()">

  <div id="breadcrumbs">üìÅ Raiz</div>

  <div class="toolbar">
    <button class="btn btn-nova" onclick="abrirPopupCriar()">Nova Pasta</button>
    <button class="btn btn-upload" onclick="abrirUpload()">Upload</button>
    <button class="btn btn-voltar" onclick="voltarPasta()">Voltar</button>
  </div>

  <div id="lista" class="grid"></div>

</div>

<!-- POPUP CRIAR PASTA -->
<div id="popupCriar">
  <div id="popupBox">
    <h3>Criar nova pasta</h3>
    <label>Nome:</label>
    <input id="nomePasta" style="width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);margin-top:6px;">

    <p style="margin-top:14px;">Cor:</p>
    <div class="colorRow">
      <div class="colorSelect" style="background:#4F8CF1" data-cor="azul"></div>
      <div class="colorSelect" style="background:#60D364" data-cor="verde"></div>
      <div class="colorSelect" style="background:#F8D441" data-cor="amarelo"></div>
      <div class="colorSelect" style="background:#F7A654" data-cor="laranja"></div>
      <div class="colorSelect" style="background:#F55D5D" data-cor="vermelho"></div>
      <div class="colorSelect" style="background:#BF6AF7" data-cor="roxo"></div>
      <div class="colorSelect" style="background:#A5A5A5" data-cor="cinza"></div>
      <div class="colorSelect" style="background:#000" data-cor="preto"></div>
    </div>

    <button onclick="criarPasta()" class="btn btn-nova" style="width:100%;margin-top:20px;">Criar</button>
    <button onclick="fecharPopupCriar()" class="btn" style="background:#ddd;color:#333;margin-top:10px;width:100%;">Cancelar</button>
  </div>
</div>

<!-- POPUP UPLOAD -->
<div id="popupUpload">
  <div id="uploadBox">
    <h3>Enviar arquivo</h3>

    <label>Destino:</label>
    <select id="uploadDestino" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);margin-top:6px;"></select>

    <div id="dropArea">Clique ou arraste</div>
    <input id="uploadInput" type="file" multiple style="display:none">

    <button onclick="enviarUpload()" class="btn btn-upload" style="width:100%;margin-top:16px;">Enviar</button>
    <button onclick="fecharUpload()" class="btn" style="background:#ddd;color:#333;margin-top:10px;width:100%;">Cancelar</button>
  </div>
</div>

<!-- MODAL -->
<div id="modal">
  <div id="modalBox">

    <button onclick="fecharModal()" class="btn btn-voltar" style="float:right;margin-bottom:12px;">Fechar</button>

    <h2 id="modalTitulo"></h2>
    <iframe id="modalPreview"></iframe>

    <button onclick="baixarArquivo()" class="btn btn-upload" style="margin-top:12px;">Download</button>
    <button onclick="excluirArquivo()" class="btn" style="background:#e74c3c;margin-left:10px;">Excluir</button>
    <button onclick="navigator.clipboard.writeText(linkAtual)" class="btn btn-nova" style="margin-left:10px;">Copiar link</button>

  </div>
</div>

<!-- ============================================
     JAVASCRIPT ‚Äî MANTIVE 100% DAS SUAS FUN√á√ïES
============================================ -->
<script>
/* CONFIG SUPABASE */
const SUPABASE_URL = "https://mblvyircwsaxaslklzky.supabase.co";
const SUPABASE_KEY = "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let usuario = localStorage.getItem("usuarioEmail") || "desconhecido";
let pastaAtual = null;
let historicoPastas = [];
let dadosPastas = [];
let dadosDocs = [];
let linkAtual = "";
let corEscolhida=null;

/* SKELETON */
window.onload = ()=>{
  renderSkeleton();
  carregarTudo();
};
function renderSkeleton(){
  let html="";
  for(let i=0;i<10;i++){ html+=`<div class="skeleton"></div>`; }
  document.getElementById("lista").innerHTML = html;
}

/* CARREGAR DADOS */
async function carregarTudo(){
  const p = await sb.from("pastas").select("*");
  dadosPastas = p.data || [];

  const d = await sb.from("documentos").select("*");
  dadosDocs = d.data || [];

  preencherDestinoUpload();
  mostrarPasta(null);
}

/* EXIBIR PASTA */
function mostrarPasta(id){
  pastaAtual=id;
  historicoPastas.push(id);

  let nome=id ? dadosPastas.find(x=>x.id===id)?.nome : "Raiz";
  document.getElementById("breadcrumbs").innerHTML = "üìÅ "+nome;

  const pastas = dadosPastas.filter(p=>p.pai_id===id);
  const docs = dadosDocs.filter(d=>d.pasta_id===id);

  let html="";

  pastas.forEach(p=>{
    html+=`
      <div class="item" onclick="entrarPasta('${p.id}')">
        ${svgCor(p.capa)}
        <div class="itemNome">${p.nome}</div>
      </div>`;
  });

  docs.forEach(d=>{
    html+=`
      <div class="item" onclick="abrirArquivo('${d.nome}','${d.url}','${d.id}')">
        ${thumbDoc(d)}
        <div class="itemNome">${d.nome}</div>
      </div>`;
  });

  document.getElementById("lista").innerHTML = html || "<p style='padding:10px'>Vazio.</p>";
}

/* √çCONE PASTA */
function svgCor(cor){
  return `<img class="thumb" src="https://img.icons8.com/color/96/folder-invoices.png">`;
}

/* THUMB DOC */
function thumbDoc(doc){
  let ext = doc.nome.split(".").pop().toLowerCase();
  if(["jpg","jpeg","png","gif","webp"].includes(ext))
    return `<img class="thumb" src="${doc.url}">`;

  return `<img class="thumb" src="https://img.icons8.com/fluency-systems-regular/96/document.png">`;
}

/* NAVEGA√á√ÉO */
function entrarPasta(id){ mostrarPasta(id); }
function voltarPasta(){
  if(historicoPastas.length>1){
    historicoPastas.pop();
    mostrarPasta(historicoPastas[historicoPastas.length-1]);
  }
}

/* CRIAR PASTA */
document.querySelectorAll(".colorSelect").forEach(c=>{
  c.onclick=()=>{
    document.querySelectorAll(".colorSelect").forEach(x=>x.classList.remove("active"));
    c.classList.add("active");
    corEscolhida=c.dataset.cor;
  };
});

function abrirPopupCriar(){ document.getElementById("popupCriar").style.display="flex"; }
function fecharPopupCriar(){
  document.getElementById("popupCriar").style.display="none";
  document.getElementById("nomePasta").value="";
}

async function criarPasta(){
  const nome=document.getElementById("nomePasta").value.trim();
  if(!nome) return alert("Digite o nome.");

  await sb.from("pastas").insert({
    nome,
    capa:corEscolhida,
    pai_id:pastaAtual,
    criado_por:usuario
  });

  fecharPopupCriar();
  carregarTudo();
}

/* UPLOAD */
function abrirUpload(){ document.getElementById("popupUpload").style.display="flex"; }
function fecharUpload(){ document.getElementById("popupUpload").style.display="none"; }

function preencherDestinoUpload(){
  const s=document.getElementById("uploadDestino");
  s.innerHTML="";
  dadosPastas.forEach(p=>{
    s.innerHTML+=`<option value="${p.id}">${p.nome}</option>`;
  });
}

/* Drag drop */
const drop=document.getElementById("dropArea");
drop.onclick=()=>document.getElementById("uploadInput").click();
drop.ondragover=e=>{ e.preventDefault(); drop.classList.add("dragover"); };
drop.ondragleave=()=>drop.classList.remove("dragover");
drop.ondrop=e=>{
  e.preventDefault();
  drop.classList.remove("dragover");
  enviarArquivos(e.dataTransfer.files);
};

function enviarUpload(){
  enviarArquivos(document.getElementById("uploadInput").files);
}

async function enviarArquivos(files){
  const destino=document.getElementById("uploadDestino").value;

  for(const file of files){
    const caminho=Date.now()+"_"+file.name;

    await sb.storage.from("documentos").upload(caminho,file);

    const url=`${SUPABASE_URL}/storage/v1/object/public/documentos/${caminho}`;

    const doc=await sb.from("documentos").insert({
      pasta_id:destino,
      nome:file.name,
      tipo:file.type,
      tamanho:file.size,
      url,
      criado_por:usuario
    });

    await sb.from("historico_documentos").insert({
      documento_id:doc.data[0].id,
      usuario,
      acao:"CRIADO"
    });
  }

  fecharUpload();
  carregarTudo();
}

/* MODAL */
function abrirArquivo(nome,url,id){
  linkAtual=url;
  document.getElementById("modalPreview").src=url;
  document.getElementById("modalTitulo").innerText=nome;
  document.getElementById("modal").style.display="flex";

  sb.from("historico_documentos").insert({
    documento_id:id,usuario,acao:"VISUALIZADO"
  });
}
function fecharModal(){ document.getElementById("modal").style.display="none"; }
function baixarArquivo(){ window.open(linkAtual,"_blank"); }

/* EXCLUIR */
async function excluirArquivo(){
  if(!confirm("Excluir arquivo?")) return;
  await sb.from("documentos").delete().eq("url",linkAtual);
  fecharModal();
  carregarTudo();
}

/* BUSCA */
function pesquisar(){
  const q=document.getElementById("busca").value.toLowerCase().trim();
  if(!q){ mostrarPasta(pastaAtual); return; }

  const r=[
    ...dadosPastas.filter(p=>p.nome.toLowerCase().includes(q)),
    ...dadosDocs.filter(d=>d.nome.toLowerCase().includes(q))
  ];

  let html="";
  r.forEach(item=>{
    if(item.capa){
      html+=`<div class="item" onclick="entrarPasta('${item.id}')">${svgCor(item.capa)}<div class="itemNome">${item.nome}</div></div>`;
    }else{
      html+=`<div class="item" onclick="abrirArquivo('${item.nome}','${item.url}','${item.id}')">${thumbDoc(item)}<div class="itemNome">${item.nome}</div></div>`;
    }
  });

  document.getElementById("breadcrumbs").innerHTML="üîç Resultados";
  document.getElementById("lista").innerHTML=html||"<p style='padding:10px'>Nenhum resultado.</p>";
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gerenciador ‚Ä¢ LICITAR</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
body{
  margin:0;background:#eef1f6;font-family:'Inter',sans-serif;
  display:flex;justify-content:center;padding:20px;color:#222;
}
#app{
  width:95%;max-width:1500px;background:#fff;border-radius:20px;
  padding:25px;box-shadow:0 5px 20px #0001;
}
h1{text-align:center;margin-bottom:15px;font-size:26px;color:#0b1e39;}
#search{width:100%;padding:10px 14px;border-radius:10px;border:1px solid #ccc;margin-bottom:20px}
.toolbar{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
.btn{
  padding:10px 16px;border:none;border-radius:10px;color:#fff;
  font-size:14px;cursor:pointer;font-weight:600;
}
.btn-nova{background:#2563eb}
.btn-upload{background:#7c3aed}
.btn-voltar{background:#6b7280}

.grid{
  display:grid;gap:18px;
  grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
}
.card{
  background:#fff;padding:14px;border-radius:12px;border:1px solid #ddd;
  text-align:center;cursor:pointer;position:relative;transition:.2s;
}
.card:hover{transform:translateY(-4px);box-shadow:0 4px 12px #0002;}
.thumb{
  width:70px;height:70px;border-radius:10px;object-fit:cover;
  margin:auto;background:#eee;
}
.name{
  margin-top:8px;font-size:14px;font-weight:600;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.menuBtn{
  position:absolute;top:8px;right:8px;background:#fff;border-radius:50%;
  padding:4px;border:1px solid #ccc;cursor:pointer;font-size:12px;
}
.menu{
  position:absolute;top:30px;right:8px;background:#fff;border:1px solid #ccc;
  border-radius:8px;display:none;flex-direction:column;min-width:120px;z-index:10;
}
.menu button{
  background:none;border:none;padding:8px;text-align:left;font-size:13px;cursor:pointer;
}
.menu button:hover{background:#f3f3f3}
.menu .danger{color:#d9534f}

.popup,.overlay{
  position:fixed;inset:0;background:#0008;display:none;
  align-items:center;justify-content:center;z-index:999;
}
.box{
  background:#fff;padding:20px;border-radius:14px;
  width:90%;max-width:420px;
}
label{font-size:14px;font-weight:600;margin-top:10px;display:block}
input,select{
  width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;
}
#previewList div{
  background:#f7f7f7;margin:5px 0;padding:8px;border-radius:8px;
  display:flex;justify-content:space-between;align-items:center;
  font-size:13px;
}
#previewList span{max-width:70%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
#loader{
  background:#0008;color:#fff;font-size:20px;display:none;
  align-items:center;justify-content:center;position:fixed;inset:0;z-index:999999;
}
</style>
</head>

<body>
<div id="loader">Processando...</div>

<div id="app">
  <h1>GERENCIADOR DE DOCUMENTOS</h1>

  <input id="search" placeholder="Pesquisar..." onkeyup="buscar()">

  <div class="toolbar">
    <button class="btn btn-nova" onclick="abrirCriarPasta()">Nova Pasta</button>
    <button class="btn btn-upload" onclick="abrirUpload()">Upload</button>
    <button class="btn btn-voltar" onclick="voltar()">Voltar</button>
  </div>

  <div id="breadcrumb">üìÅ Raiz</div>

  <div id="lista" class="grid"></div>
</div>

<!-- CRIAR PASTA -->
<div id="popupCriar" class="popup">
  <div class="box">
    <h3>Criar pasta</h3>
    <label>Nome:</label>
    <input id="nomePasta">
    <button class="btn btn-nova" style="width:100%;margin-top:15px" onclick="criarPasta()">Criar</button>
    <button style="width:100%;margin-top:8px" onclick="fecharCriarPasta()">Cancelar</button>
  </div>
</div>

<!-- UPLOAD -->
<div id="popupUpload" class="popup">
  <div class="box">
    <h3>Enviar arquivos</h3>

    <label>Destino:</label>
    <select id="destinoUpload"></select>

    <label>Arquivos selecionados:</label>
    <div id="previewList"></div>

    <button onclick="selecionarMais()" style="margin-top:10px">+ Adicionar mais</button>
    <input id="fileInput" type="file" multiple style="display:none">

    <button class="btn btn-upload" style="width:100%;margin-top:15px" onclick="confirmarUpload()">Enviar</button>
    <button style="width:100%;margin-top:8px" onclick="fecharUpload()">Cancelar</button>
  </div>
</div>

<script>
/* SUPABASE */
const sb = supabase.createClient(
 "https://mblvyircwsaxaslklzky.supabase.co",
 "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x"
);

let pastaAtual=null;
let historico=[null];
let pastas=[];
let arquivos=[];
let anexos=[];

window.onload=()=>carregar();

/* LOADING */
function loading(show){
  document.getElementById("loader").style.display = show?"flex":"none";
}

/* CARREGAR TUDO */
async function carregar(){
  loading(true);

  pastas = (await sb.from("pastas").select("*")).data || [];
  arquivos = (await sb.from("documentos").select("*")).data || [];

  preencherDestino();
  listar(pastaAtual);

  loading(false);
}

/* LISTAR */
function listar(id){
  pastaAtual=id;
  const lista=document.getElementById("lista");
  lista.innerHTML="";

  document.getElementById("breadcrumb").innerText =
    "üìÅ "+(id? pastas.find(x=>x.id===id)?.nome : "Raiz");

  const subPastas = pastas.filter(p=>p.pai_id===id);
  const docs = arquivos.filter(a=>a.pasta_id===id);

  [...subPastas,...docs].forEach(item=>{
    const card=document.createElement("div");
    card.className="card";

    card.innerHTML=`
      <div class="menuBtn" onclick="abrirMenu(event,'${item.id}','${item.pai_id}','${item.nome}','${item.url||""}','${item.capa||""}')">‚ãÆ</div>
      <div class="menu" id="menu-${item.id}">
        <button onclick="abrirRenomear('${item.id}','${item.nome}','${item.url||""}')">Renomear</button>
        <button onclick="abrirMover('${item.id}')">Mover</button>
        <button class="danger" onclick="excluir('${item.id}','${item.url||""}')">Excluir</button>
      </div>
    `;

    const img=document.createElement("img");
    img.className="thumb";

    if(item.url){
      let ext=item.nome.split(".").pop().toLowerCase();
      if(["jpg","jpeg","png","gif","webp"].includes(ext)) img.src=item.url;
      else img.src="https://img.icons8.com/pastel-glyph/256/file--v1.png";

      card.onclick=()=> window.open(item.url,"_blank");
    }else{
      img.src="https://img.icons8.com/fluency-systems-filled/96/4F8CF1/folder.png";
      card.onclick=()=> entrar(item.id);
    }

    card.prepend(img);

    const name=document.createElement("div");
    name.className="name";
    name.innerText=item.nome;

    card.appendChild(name);
    lista.appendChild(card);
  });
}

/* ABRIR MENU */
function abrirMenu(e,id){
  e.stopPropagation();
  fecharMenus();
  document.getElementById("menu-"+id).style.display="flex";
}
function fecharMenus(){
  document.querySelectorAll(".menu").forEach(m=>m.style.display="none");
}
document.body.onclick=()=>fecharMenus();

/* ENTRAR */
function entrar(id){
  historico.push(id);
  listar(id);
}

/* VOLTAR */
function voltar(){
  if(historico.length>1){
    historico.pop();
    listar(historico[historico.length-1]);
  }
}

/* CRIAR PASTA */
function abrirCriarPasta(){ document.getElementById("popupCriar").style.display="flex"; }
function fecharCriarPasta(){ document.getElementById("popupCriar").style.display="none"; }

async function criarPasta(){
  let nome=document.getElementById("nomePasta").value.trim();
  if(!nome) return alert("Digite um nome");

  loading(true);

  await sb.from("pastas").insert({
    nome,pai_id:pastaAtual,criado_por:"sistema",capa:"azul"
  });

  fecharCriarPasta();
  carregar();
}

/* UPLOAD */
function abrirUpload(){
  anexos=[];
  document.getElementById("previewList").innerHTML="";
  document.getElementById("popupUpload").style.display="flex";
}
function fecharUpload(){ document.getElementById("popupUpload").style.display="none"; }

function selecionarMais(){
  document.getElementById("fileInput").click();
}
document.getElementById("fileInput").onchange=e=>{
  [...e.target.files].forEach(f=>adicionarPreview(f));
};
function adicionarPreview(file){
  anexos.push(file);
  renderPreview();
}
function removerPreview(i){
  anexos.splice(i,1);
  renderPreview();
}
function renderPreview(){
  const box=document.getElementById("previewList");
  box.innerHTML="";
  anexos.forEach((f,i)=>{
    box.innerHTML+=`
      <div><span>${f.name}</span>
      <button onclick="removerPreview(${i})">X</button></div>
    `;
  });
}
function preencherDestino(){
  const sel=document.getElementById("destinoUpload");
  sel.innerHTML="";
  pastas.forEach(p=>{
    sel.innerHTML+=`<option value="${p.id}">${p.nome}</option>`;
  });
}

/* CONFIRMAR UPLOAD */
async function confirmarUpload(){
  if(anexos.length===0) return alert("Nenhum arquivo selecionado");

  loading(true);

  const destino=document.getElementById("destinoUpload").value;

  for(const file of anexos){
    let nome = Date.now()+"_"+file.name;

    await sb.storage.from("documentos").upload(nome,file);

    let url=`https://mblvyircwsaxaslklzky.supabase.co/storage/v1/object/public/documentos/${nome}`;

    await sb.from("documentos").insert({
      nome:file.name,pasta_id:destino,url,tipo:file.type,
      tamanho:file.size,criado_por:"sistema"
    });
  }

  fecharUpload();
  carregar();
}

/* RENOMEAR / MOVER / EXCLUIR */
function abrirRenomear(id,nome,url){
  let novo=prompt("Novo nome:",nome);
  if(!novo) return;

  sb.from(url? "documentos":"pastas")
    .update({nome:novo}).eq("id",id).then(()=>carregar());
}

function abrirMover(id){
  let destino=prompt("Mover para (ID da pasta):","");
  if(!destino) return;

  sb.from("documentos").update({pasta_id:destino}).eq("id",id).then(()=>carregar());
}

async function excluir(id,url){
  if(!confirm("Excluir definitivamente?")) return;

  loading(true);

  if(url){
    let nome=url.split("/").pop();
    await sb.storage.from("documentos").remove([nome]);
    await sb.from("documentos").delete().eq("id",id);
  }else{
    await sb.from("pastas").delete().eq("id",id);
  }

  carregar();
}

/* BUSCA */
function buscar(){
  let q=document.getElementById("search").value.toLowerCase();
  if(!q) return listar(pastaAtual);

  let res=[
    ...pastas.filter(p=>p.nome.toLowerCase().includes(q)),
    ...arquivos.filter(a=>a.nome.toLowerCase().includes(q))
  ];

  let lista=document.getElementById("lista");
  lista.innerHTML="";

  res.forEach(item=>{
    let card=document.createElement("div");
    card.className="card";

    if(item.url) card.onclick=()=>window.open(item.url,"_blank");
    else card.onclick=()=>entrar(item.id);

    let img=document.createElement("img");
    img.className="thumb";
    img.src=item.url ? item.url :
      "https://img.icons8.com/fluency-systems-filled/96/4F8CF1/folder.png";

    card.appendChild(img);

    let name=document.createElement("div");
    name.className="name";
    name.innerText=item.nome;
    card.appendChild(name);

    lista.appendChild(card);
  });
}
</script>

</body>
</html>

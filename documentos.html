<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Gerenciador de Documentos</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ===========================================================
   LICITAR ‚Ä¢ TEMA CLARO (MESMO TEMA DO LOGIN)
=========================================================== */
:root{
  --bg:#f5f7fb;
  --card:#ffffff;
  --border:#d2d8e2;
  --text:#0b1e39;
  --text-light:#3a4660;

  --primary:#0b1e39;
  --primary-hover:#1d3259;

  --radius:14px;
  --shadow:0 4px 16px rgba(0,0,0,.08);
}

/* RESET */
*{
  box-sizing:border-box;
  font-family:Inter, sans-serif;
}
body{
  margin:0;
  padding:30px;
  background:var(--bg);
  display:flex;
  justify-content:center;
  color:var(--text);
}

/* CONTAINER */
#container{
  width:95%;
  max-width:1500px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:20px;
  padding:35px;
  box-shadow:var(--shadow);
}

/* T√çTULO */
#titulo{
  text-align:center;
  font-size:32px;
  font-weight:800;
  color:var(--primary);
  margin-bottom:26px;
}

/* BUSCA */
#busca{
  width:100%;
  padding:14px;
  font-size:15px;
  background:#f5f8ff;
  border:1px solid var(--border);
  border-radius:10px;
}
#busca:focus{
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(11,30,57,.18);
  outline:none;
}

/* BREADCRUMB */
#breadcrumbs{
  margin:18px 0;
  font-size:15px;
  color:var(--primary);
  font-weight:600;
}

/* BOT√ïES */
.toolbar{
  display:flex;
  gap:15px;
  margin-bottom:25px;
}
.btn{
  border:none;
  padding:12px 18px;
  border-radius:10px;
  font-size:14px;
  cursor:pointer;
  font-weight:600;
  transition:.25s;
}
.btn:hover{
  opacity:.9;
}
.btn-nova{
  background:var(--primary);
  color:white;
}
.btn-upload{
  background:#3a4660;
  color:white;
}
.btn-voltar{
  background:#ddd;
  color:#333;
}

/* GRID */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(200px,1fr));
  gap:24px;
}

/* ITEM (PASTAS E ARQUIVOS) */
.item{
  background:white;
  border:1px solid var(--border);
  border-radius:16px;
  padding:20px;
  box-shadow:var(--shadow);
  transition:.25s;
  text-align:center;
  cursor:pointer;
}
.item:hover{
  transform:translateY(-4px);
}

/* √çCONES */
.icon-folder{
  width:80px;
}
.thumb{
  width:90px;
  height:90px;
  border-radius:10px;
  object-fit:cover;
  background:#eef2ff;
  margin:auto;
}

/* NOME */
.itemNome{
  margin-top:12px;
  font-size:15px;
  color:var(--text-light);
  font-weight:600;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* MINIATURAS NA PASTA */
.folder-preview{
  width:95px;
  height:95px;
  margin:auto;
  position:relative;
}
.folder-preview{
  width:95px;
  height:95px;
  margin:auto;
  position:relative;
}

/* Miniaturas NA FRENTE da pasta */
.folder-preview .mini{
  width:32px;
  height:32px;
  border-radius:6px;
  position:absolute;
  top:8px;           /* sobe para cima */
  right:8px;         /* vai para frente, canto superior */
  border:2px solid #fff;
  object-fit:cover;
  box-shadow:0 3px 6px rgba(0,0,0,.25);
}

/* segunda miniatura ‚Äî levemente para a esquerda */
.folder-preview .mini:nth-child(2){
  right:42px;      
}

/* terceira miniatura */
.folder-preview .mini:nth-child(3){
  right:74px;
}

/* √çCONES DE ARQUIVOS */
.file-icon{
  width:70px;
  height:70px;
  margin:auto;
}

/* MODAL */
#modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.3);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}
#modalBox{
  background:white;
  width:90%;
  max-width:750px;
  padding:26px;
  border-radius:16px;
  border:1px solid var(--border);
  box-shadow:0 8px 26px rgba(0,0,0,.15);
}
#modalPreview{
  width:100%;
  height:450px;
  border-radius:10px;
  border:1px solid var(--border);
  margin:12px 0;
}
.modal-buttons{
  display:flex;
  gap:10px;
}

/* MENU LATERAL MOVER */
#moveMenu{
  position:fixed;
  right:-380px;
  top:0;
  width:350px;
  height:100%;
  background:white;
  border-left:1px solid var(--border);
  box-shadow:-8px 0 15px rgba(0,0,0,.15);
  padding:20px;
  transition:.35s ease;
}
#moveMenu.open{
  right:0;
}
.moveItem{
  padding:12px;
  border:1px solid var(--border);
  border-radius:10px;
  background:white;
  margin-bottom:10px;
  cursor:pointer;
}
.moveItem:hover{
  background:#f5f8ff;
}

/* POPUP CRIAR / UPLOAD */
#popupCriar, #popupUpload{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  display:none;
  justify-content:center;
  align-items:center;
}
#popupBox, #uploadBox{
  background:white;
  border:1px solid var(--border);
  padding:28px;
  border-radius:14px;
  width:90%;
  max-width:400px;
}

#dropArea{
  border:2px dashed #3a4660;
  color:#3a4660;
  border-radius:12px;
  padding:26px;
  text-align:center;
  margin-top:10px;
}
#dropArea.dragover{
  background:#eef2ff;
  border-color:var(--primary);
}

/* SKELETON */
.skeleton{
  background:#eef2ff;
  height:150px;
  border-radius:14px;
  animation:pulse 1.4s infinite ease-in-out;
}
@keyframes pulse{
  0%{opacity:.5;}
  50%{opacity:1;}
  100%{opacity:.5;}
}


</style>
</head>

<body>

<!-- =======================
     CONTAINER PRINCIPAL
======================= -->
<div id="container">

  <h1 id="titulo">Gerenciador de Documentos</h1>

  <input id="busca" placeholder="Pesquisar documentos..." onkeyup="pesquisar()">

  <div id="breadcrumbs">üìÅ Raiz</div>

  <div class="toolbar">
    <button class="btn btn-nova" onclick="abrirPopupCriar()">üìÅ Nova Pasta</button>
    <button class="btn btn-upload" onclick="abrirUpload()">‚¨Ü Upload</button>
    <button class="btn btn-voltar" onclick="voltarPasta()">‚¨Ö Voltar</button>
  </div>

  <div id="lista" class="grid"></div>

</div>

<!-- =======================
     POPUP CRIAR PASTA
======================= -->
<div id="popupCriar">
  <div id="popupBox">
    <h3 style="color:var(--gold-light)">Criar Pasta</h3>
    <input id="nomePasta" placeholder="Nome da pasta" style="width:100%;padding:14px;border-radius:12px;margin-top:10px;">
    <button onclick="criarPasta()" class="btn btn-nova" style="margin-top:20px;width:100%;">Criar</button>
    <button onclick="fecharPopupCriar()" class="btn btn-voltar" style="margin-top:12px;width:100%;">Cancelar</button>
  </div>
</div>

<!-- =======================
     POPUP UPLOAD
======================= -->
<div id="popupUpload">
  <div id="uploadBox">
    <h3 style="color:var(--gold-light)">Enviar Arquivo</h3>

    <select id="uploadDestino" style="width:100%;padding:12px;border-radius:12px;margin-top:8px;"></select>

    <div id="dropArea">Arraste arquivos aqui<br>ou clique para selecionar</div>
    <input id="uploadInput" type="file" multiple style="display:none">

    <button onclick="enviarUpload()" class="btn btn-upload" style="width:100%;margin-top:20px;">Enviar</button>
    <button onclick="fecharUpload()" class="btn btn-voltar" style="margin-top:12px;width:100%;">Cancelar</button>
  </div>
</div>

<!-- =======================
     MODAL VISUALIZA√á√ÉO
======================= -->
<div id="modal">
  <div id="modalBox">

    <button onclick="fecharModal()" class="btn btn-voltar" style="float:right;margin-bottom:15px;">Fechar</button>

    <h2 id="modalTitulo" style="color:var(--gold-light);margin-bottom:10px;"></h2>

    <iframe id="modalPreview"></iframe>

    <div class="modal-buttons">
      <button onclick="baixarArquivo()" class="btn btn-upload">‚¨á Download</button>
      <button onclick="abrirMover()" class="btn btn-nova">üìÅ Mover</button>
      <button onclick="excluirArquivo()" class="btn" style="background:#d9534f;">üóë Excluir</button>
    </div>

  </div>
</div>

<!-- =======================
     MENU LATERAL MOVER
======================= -->
<div id="moveMenu">
  <h3 style="color:var(--gold-light)">Mover Arquivo</h3>

  <input id="moveSearch" placeholder="Pesquisar pasta..."
         style="width:100%;padding:12px;border-radius:12px;margin-bottom:15px;">

  <div id="moveList"></div>

  <button class="btn btn-voltar" style="width:100%;margin-top:18px;" onclick="fecharMover()">
    Fechar
  </button>
</div>


<!-- =======================
     SCRIPT PRINCIPAL
======================= -->
<script>
/* =============================
   CONFIG SUPABASE
============================= */
const SUPABASE_URL = "https://mblvyircwsaxaslklzky.supabase.co";
const SUPABASE_KEY = "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let usuario = localStorage.getItem("usuarioEmail") || "desconhecido";
let pastaAtual = null;
let historicoPastas = [];
let dadosPastas = [];
let dadosDocs = [];
let linkAtual = "";
let arquivoAtualID = null;

/* ============ IN√çCIO ============ */
window.onload = () => {
  renderSkeleton();
  carregarTudo();
};

/* Loader */
function renderSkeleton(){
  let html="";
  for(let i=0;i<12;i++) html+=`<div class="skeleton"></div>`;
  document.getElementById("lista").innerHTML = html;
}

/* Carregar */
async function carregarTudo(){
  const p = await sb.from("pastas").select("*");
  dadosPastas = p.data || [];

  const d = await sb.from("documentos").select("*");
  dadosDocs = d.data || [];

  preencherDestinoUpload();
  mostrarPasta(null);
}

/* Mostrar pasta */
function mostrarPasta(id){
  pastaAtual = id;
  historicoPastas.push(id);

  let nome = id ? dadosPastas.find(x=>x.id===id)?.nome : "Raiz";
  document.getElementById("breadcrumbs").innerHTML = "üìÅ " + nome;

  const pastas = dadosPastas.filter(p=>p.pai_id === id);
  const docs = dadosDocs.filter(d=>d.pasta_id === id);

  let html = "";

  /* Pastas */
  pastas.forEach(p=>{
    const thumbs = dadosDocs.filter(x=>x.pasta_id===p.id).slice(0,3);
    let mini="";
    thumbs.forEach(a=> mini+=`<img class="mini" src="${a.url}">`);
    html+=`
      <div class="item" onclick="entrarPasta('${p.id}')">
        <div class="folder-preview">
          <img src="https://img.icons8.com/fluency/96/folder-invoices.png" class="icon-folder">
          ${mini}
        </div>
        <div class="itemNome">${p.nome}</div>
      </div>`;
  });

  /* Arquivos */
  docs.forEach(d=>{
    html+=`
      <div class="item" onclick="abrirArquivo('${d.nome}','${d.url}','${d.id}')">
        ${thumbDoc(d)}
        <div class="itemNome">${d.nome}</div>
      </div>`;
  });

  document.getElementById("lista").innerHTML = html || "<p>Vazio.</p>";
}

/* Thumb inteligente */
function thumbDoc(doc){
  let ext = doc.nome.split(".").pop().toLowerCase();

  const IMGS = ["jpg","jpeg","png","gif","webp"];
  if(IMGS.includes(ext)) return `<img class="thumb" src="${doc.url}">`;

  if(ext==="pdf") return `<div class="file-icon pdf"></div>`;
  if(["doc","docx"].includes(ext)) return `<div class="file-icon doc"></div>`;
  if(["xls","xlsx"].includes(ext)) return `<div class="file-icon xls"></div>`;
  if(["mp4","mkv","avi"].includes(ext)) return `<div class="file-icon video"></div>`;
  if(["zip","rar","7z"].includes(ext)) return `<div class="file-icon zip"></div>`;

  return `<div class="file-icon generic"></div>`;
}

/* Entrar pasta */
function entrarPasta(id){
  mostrarPasta(id);
}

/* Voltar */
function voltarPasta(){
  if(historicoPastas.length>1){
    historicoPastas.pop();
    mostrarPasta(historicoPastas[historicoPastas.length-1]);
  }
}

/* Criar Pasta */
function abrirPopupCriar(){ popupCriar.style.display="flex"; }
function fecharPopupCriar(){ popupCriar.style.display="none"; nomePasta.value=""; }

async function criarPasta(){
  const nome = nomePasta.value.trim();
  if(!nome) return alert("Digite o nome.");

  await sb.from("pastas").insert({
    nome,
    capa:"gold",
    pai_id:pastaAtual,
    criado_por:usuario
  });

  fecharPopupCriar();
  carregarTudo();
}

/* Upload */
function abrirUpload(){ popupUpload.style.display="flex"; }
function fecharUpload(){ popupUpload.style.display="none"; }

function preencherDestinoUpload(){
  uploadDestino.innerHTML="";
  dadosPastas.forEach(p=>{
    uploadDestino.innerHTML+=`<option value="${p.id}">${p.nome}</option>`;
  });
}

dropArea.onclick = ()=> uploadInput.click();

dropArea.ondragover = e=>{ e.preventDefault(); dropArea.classList.add("dragover"); };
dropArea.ondragleave = ()=> dropArea.classList.remove("dragover");

dropArea.ondrop = e=>{
  e.preventDefault();
  dropArea.classList.remove("dragover");
  enviarArquivos(e.dataTransfer.files);
};

function enviarUpload(){ enviarArquivos(uploadInput.files); }

async function enviarArquivos(files){
  const destino = uploadDestino.value;

  for(const file of files){
    const caminho = Date.now()+"_"+file.name;
    await sb.storage.from("documentos").upload(caminho,file);
    const url = `${SUPABASE_URL}/storage/v1/object/public/documentos/${caminho}`;

    const doc = await sb.from("documentos").insert({
      pasta_id: destino,
      nome:file.name,
      tipo:file.type,
      tamanho:file.size,
      url,
      criado_por:usuario
    });
  }

  fecharUpload();
  carregarTudo();
}

/* Modal */
function abrirArquivo(nome,url,id){
  modalTitulo.innerText = nome;
  modalPreview.src = url;
  arquivoAtualID = id;
  linkAtual = url;
  modal.style.display="flex";
}
function fecharModal(){ modal.style.display="none"; }

function baixarArquivo(){
  const a = document.createElement("a");
  a.href = linkAtual;
  a.download = "";
  a.click();
}

/* Excluir */
async function excluirArquivo(){
  if(!confirm("Excluir?")) return;
  await sb.from("documentos").delete().eq("id",arquivoAtualID);
  fecharModal();
  carregarTudo();
}

/* MOVER */
function abrirMover(){ moveMenu.classList.add("open"); montarListaMover(); }
function fecharMover(){ moveMenu.classList.remove("open"); }

function montarListaMover(){
  moveList.innerHTML="";
  dadosPastas.forEach(p=>{
    moveList.innerHTML+=`
      <div class="moveItem" onclick="moverArquivo('${p.id}')">üìÅ ${p.nome}</div>
    `;
  });
}

async function moverArquivo(dest){
  await sb.from("documentos").update({pasta_id:dest}).eq("id",arquivoAtualID);
  fecharMover();
  fecharModal();
  carregarTudo();
}

/* Busca mover */
moveSearch.onkeyup = ()=>{
  let q = moveSearch.value.toLowerCase();
  moveList.innerHTML="";
  dadosPastas
    .filter(p=>p.nome.toLowerCase().includes(q))
    .forEach(p=>{
      moveList.innerHTML+=`<div class="moveItem" onclick="moverArquivo('${p.id}')">üìÅ ${p.nome}</div>`;
    });
};

/* Busca global */
function pesquisar(){
  let q = busca.value.toLowerCase().trim();
  if(!q){ mostrarPasta(pastaAtual); return; }

  let resultados = [
    ...dadosPastas.filter(p=>p.nome.toLowerCase().includes(q)),
    ...dadosDocs.filter(d=>d.nome.toLowerCase().includes(q))
  ];

  let html="";
  resultados.forEach(item=>{
    if(item.capa){
      html+=`
        <div class="item" onclick="entrarPasta('${item.id}')">
          <img src="https://img.icons8.com/fluency/96/folder-invoices.png" class="icon-folder">
          <div class="itemNome">${item.nome}</div>
        </div>`;
    } else {
      html+=`
        <div class="item" onclick="abrirArquivo('${item.nome}','${item.url}','${item.id}')">
          ${thumbDoc(item)}
          <div class="itemNome">${item.nome}</div>
        </div>`;
    }
  });

  lista.innerHTML = html || "<p>Nenhum resultado.</p>";
  breadcrumbs.innerHTML = "üîç Resultados da busca";
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Documentos ‚Ä¢ LICITAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  padding:20px;
  font-family:Inter, sans-serif;
  background:#f4f6fb;
}

.card{
  background:#fff;
  padding:25px;
  border-radius:14px;
  box-shadow:0 4px 20px rgba(0,0,0,0.06);
}

h2{
  color:#0b1e39;
  font-size:26px;
  margin-bottom:15px;
}

.btn{
  background:#0b1e39;
  color:white;
  padding:10px 18px;
  border-radius:8px;
  cursor:pointer;
  border:none;
  font-size:14px;
  transition:.2s;
}
.btn:hover{ background:#143463; }

.pasta{
  padding:12px;
  margin:6px 0;
  background:#eef3ff;
  border-radius:8px;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:10px;
}
.pasta:hover{ background:#dce6ff; }

.doc{
  padding:12px;
  margin:5px 0;
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:8px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.doc:hover{
  background:#f7f9ff;
}

.action{
  margin-left:10px;
  cursor:pointer;
}
.action:hover{ opacity:.7; }

#busca{
  width:100%;
  padding:12px;
  border:1px solid #cbd5e1;
  border-radius:8px;
  margin:15px 0 25px 0;
  font-size:15px;
}

#overlay{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(255,255,255,.8);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
  font-size:22px;
  font-weight:600;
  color:#0b1e39;
}

.modal{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.45);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}
.modal-box{
  background:white;
  padding:22px;
  width:380px;
  border-radius:12px;
  box-shadow:0 4px 20px rgba(0,0,0,0.3);
}
.modal-box h3{
  margin-bottom:12px;
}
input,textarea{
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:8px;
  border:1px solid #cbd5e1;
}
.close{
  float:right;
  cursor:pointer;
  font-weight:bold;
}
</style>
</head>

<body>

<div id="overlay">‚è≥ Processando...</div>

<div class="card">

  <h2>üìÅ Documentos</h2>

  <button class="btn" onclick="abrirModalUpload()">‚ûï Novo Documento</button>
  <button class="btn" onclick="abrirModalPasta()">üìÅ Nova Pasta</button>

  <input id="busca" type="text" placeholder="Pesquisar documentos ou pastas..." oninput="pesquisar()">

  <h3 id="caminho">üìÇ /</h3>

  <div id="listaPastas"></div>
  <div id="listaDocumentos"></div>

</div>

<!-- MODAL UPLOAD -->
<div class="modal" id="modalUpload">
  <div class="modal-box">
    <div class="close" onclick="fechar('modalUpload')">X</div>
    <h3>Adicionar Documento</h3>

    <input type="file" id="inpArquivo">
    <input type="text" id="inpCategoria" placeholder="Categoria">
    <textarea id="inpDescricao" placeholder="Descri√ß√£o"></textarea>

    <button class="btn" onclick="uploadDocumento()">Enviar</button>
  </div>
</div>

<!-- MODAL PASTA -->
<div class="modal" id="modalPasta">
  <div class="modal-box">
    <div class="close" onclick="fechar('modalPasta')">X</div>
    <h3>Criar Nova Pasta</h3>

    <input id="inpPastaNome" placeholder="Nome da pasta">
    <button class="btn" onclick="criarPasta()">Criar</button>
  </div>
</div>

<script>
/* =============================== */
/* CONFIG SUPABASE */
/* =============================== */
const SUPABASE_URL = "https://mblvyircwsaxaslklzky.supabase.co";
const SUPABASE_KEY = "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const usuario = localStorage.getItem("usuarioEmail");
let pastaAtual = null;

/* =============================== */
/* MODAIS */
/* =============================== */
function abrirModalUpload(){ document.getElementById("modalUpload").style.display="flex"; }
function abrirModalPasta(){ document.getElementById("modalPasta").style.display="flex"; }
function fechar(id){ document.getElementById(id).style.display="none"; }

/* =============================== */
/* OVERLAY */
/* =============================== */
function loading(show=true){
  document.getElementById("overlay").style.display = show ? "flex" : "none";
}

/* =============================== */
/* CARREGAR PASTAS E DOCUMENTOS */
/* =============================== */
async function carregar(){
  loading(true);

  const { data: pastas } = await sb
    .from("pastas")
    .select("*")
    .is("pai_id", pastaAtual);

  const { data: docs } = await sb
    .from("documentos")
    .select("*")
    .is("pasta_id", pastaAtual);

  document.getElementById("listaPastas").innerHTML = "";
  document.getElementById("listaDocumentos").innerHTML = "";

  pastas?.forEach(p => {
    document.getElementById("listaPastas").innerHTML += `
      <div class="pasta" onclick="abrirPasta('${p.id}', '${p.nome}')">
        üìÅ <b>${p.nome}</b>
      </div>`;
  });

  docs?.forEach(d => {
    document.getElementById("listaDocumentos").innerHTML += `
      <div class="doc">
        <div>üìÑ ${d.nome}</div>
        <div>
          <span class="action" onclick="visualizar('${d.url}','${d.id}')">üëÅÔ∏è</span>
          <span class="action" onclick="baixar('${d.url}','${d.id}')">‚¨áÔ∏è</span>
          <span class="action" onclick="excluirDoc('${d.id}')">üóëÔ∏è</span>
        </div>
      </div>`;
  });

  loading(false);
}

/* =============================== */
/* ABRIR PASTAS */
/* =============================== */
function abrirPasta(id,nome){
  pastaAtual = id;
  document.getElementById("caminho").innerHTML = "üìÇ /" + nome;
  carregar();
}

/* =============================== */
/* CRIAR PASTA */
/* =============================== */
async function criarPasta(){
  loading(true);

  await sb.from("pastas").insert({
    nome: document.getElementById("inpPastaNome").value,
    pai_id: pastaAtual,
    criado_por: usuario
  });

  fechar("modalPasta");
  carregar();
}

/* =============================== */
/* UPLOAD DOCUMENTO */
/* =============================== */
async function uploadDocumento(){
  const arq = document.getElementById("inpArquivo").files[0];
  if(!arq) return alert("Selecione um arquivo");

  loading(true);

  const caminho = Date.now()+"_"+arq.name;

  const { data: up, error: errUp } = await sb
    .storage
    .from("documentos")
    .upload(caminho, arq);

  if(errUp){
    alert("Erro no upload: "+errUp.message);
    loading(false);
    return;
  }

  const url = `${SUPABASE_URL}/storage/v1/object/public/documentos/${caminho}`;

  const { data: inserted } = await sb
    .from("documentos")
    .insert({
      pasta_id: pastaAtual,
      nome: arq.name,
      tipo: arq.type,
      tamanho: arq.size,
      url,
      categoria: document.getElementById("inpCategoria").value,
      descricao: document.getElementById("inpDescricao").value,
      criado_por: usuario
    })
    .select()
    .single();

  await sb.from("historico_documentos").insert({
    documento_id: inserted.id,
    usuario,
    acao:"CRIADO"
  });

  fechar("modalUpload");
  carregar();
}

/* =============================== */
/* VISUALIZAR / BAIXAR */
/* =============================== */
function visualizar(url,id){
  window.open(url);
  sb.from("historico_documentos").insert({ documento_id:id, usuario, acao:"VISUALIZADO" });
}

function baixar(url,id){
  window.open(url);
  sb.from("historico_documentos").insert({ documento_id:id, usuario, acao:"DOWNLOAD" });
}

/* =============================== */
/* EXCLUIR DOCUMENTO */
/* =============================== */
async function excluirDoc(id){
  if(!confirm("Excluir documento?")) return;
  loading(true);

  await sb.from("documentos").delete().eq("id", id);

  await sb.from("historico_documentos").insert({
    documento_id:id,
    usuario,
    acao:"EXCLUIDO"
  });

  carregar();
}

/* =============================== */
/* BUSCA GLOBAL */
/* =============================== */
async function pesquisar(){
  const termo = document.getElementById("busca").value.toLowerCase();

  if(termo.length < 2){
    carregar();
    return;
  }

  loading(true);

  const { data } = await sb
    .from("documentos")
    .select("*")
    .ilike("nome", `%${termo}%`);

  document.getElementById("listaPastas").innerHTML = "";
  document.getElementById("listaDocumentos").innerHTML = "";

  data.forEach(d => {
    document.getElementById("listaDocumentos").innerHTML += `
      <div class="doc">
        <div>üìÑ ${d.nome}</div>
        <div>
          <span onclick="visualizar('${d.url}','${d.id}')" class="action">üëÅÔ∏è</span>
          <span onclick="baixar('${d.url}','${d.id}')" class="action">‚¨áÔ∏è</span>
        </div>
      </div>`;
  });

  loading(false);
}

carregar();
</script>

</body>
</html>

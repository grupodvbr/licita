<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Gerenciador de Documentos</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ===========================================================
   LICITAR ‚Ä¢ LAYOUT PROFISSIONAL
=========================================================== */
:root{
  --bg:#f5f7fb;
  --card:#ffffff;
  --border:#d2d8e2;
  --text:#0b1e39;
  --text-light:#3a4660;

  --primary:#0b1e39;
  --primary-hover:#1d3259;

  --radius:12px;
  --shadow:0 4px 16px rgba(0,0,0,.08);
}

/* RESET */
*{
  box-sizing:border-box;
  font-family:Inter, sans-serif;
}
body{
  margin:0;
  padding:25px;
  background:var(--bg);
  display:flex;
  justify-content:center;
  color:var(--text);
}

/* CONTAINER */
#container{
  width:95%;
  max-width:1400px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:30px;
  box-shadow:var(--shadow);
}

/* T√çTULO */
#titulo{
  text-align:center;
  font-size:26px;
  font-weight:800;
  color:var(--primary);
  margin-bottom:18px;
}

/* BUSCA */
#busca{
  width:100%;
  padding:12px;
  font-size:14px;
  background:#f5f8ff;
  border:1px solid var(--border);
  border-radius:10px;
}
#busca:focus{
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(11,30,57,.18);
  outline:none;
}

/* BREADCRUMB */
#breadcrumbs{
  margin:14px 0;
  font-size:14px;
  color:var(--primary);
  font-weight:600;
}

/* BOT√ïES */
.toolbar{
  display:flex;
  gap:12px;
  margin-bottom:20px;
}
.btn{
  border:none;
  padding:10px 16px;
  border-radius:10px;
  font-size:13px;
  cursor:pointer;
  font-weight:600;
  transition:.25s;
}
.btn:hover{ opacity:.9; }

.btn-nova{ background:var(--primary); color:white; }
.btn-upload{ background:#3a4660; color:white; }
.btn-voltar{ background:#ddd; color:#333; }

/* GRID */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(160px,1fr));
  gap:20px;
}

/* ITEM */
.item{
  background:white;
  border:1px solid var(--border);
  border-radius:14px;
  padding:15px;
  box-shadow:var(--shadow);
  transition:.25s;
  text-align:center;
  cursor:pointer;
}
.item:hover{
  transform:translateY(-3px);
}

/* PASTA */
.icon-folder{
  width:60px;
}

.folder-preview{
  position:relative;
  width:70px;
  height:70px;
  margin:auto;
}

.folder-preview .mini{
  width:24px;
  height:24px;
  border-radius:6px;
  position:absolute;
  top:3px;
  right:3px;
  border:2px solid white;
  object-fit:cover;
  box-shadow:0 2px 5px rgba(0,0,0,.25);
}
.folder-preview .mini:nth-child(2){ right:28px; }
.folder-preview .mini:nth-child(3){ right:54px; }

.itemNome{
  margin-top:8px;
  font-size:13px;
  font-weight:600;
  color:var(--text-light);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
/* Checkbox no canto superior */
.selectBox {
  position: absolute;
  top: 8px;
  left: 8px;
  width: 18px;
  height: 18px;
  cursor: pointer;
  z-index: 5;
}

/* Bot√£o 3 pontinhos */
.moreBtn {
  position: absolute;
  top: 8px;
  right: 8px;
  font-size: 20px;
  cursor: pointer;
  background: none;
  border: none;
  color: var(--text-light);
}

#actionBar {
  display: none;
  margin-top: -5px;
  margin-bottom: 20px;
  gap: 12px;
  display: none;
  justify-content: flex-start;
}


#actionBar button {
  padding: 10px 16px;
  font-size: 13px;
  font-weight: 600;
  border-radius: 10px;
  cursor: pointer;
  border: none;
}




/* THUMB */
.thumb{
  width:70px;
  height:70px;
  border-radius:10px;
  object-fit:cover;
  margin:auto;
  background:#eef2ff;
}

/* FILE ICON */
.file-icon{
  width:55px;
  height:55px;
  margin:auto;
  background:#ececec;
  border-radius:6px;
}

/* MODAL */
#modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.3);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}
#modalBox{
  background:white;
  width:90%;
  max-width:650px;
  padding:22px;
  border-radius:16px;
  border:1px solid var(--border);
}
#modalPreview{
  width:100%;
  height:380px;
  border-radius:10px;
  border:1px solid var(--border);
  margin:12px 0;
}

/* BOT√ïES DO MODAL */
.modal-buttons{
  display:flex;
  gap:10px;
}

/* POPUPS */
#popupCriar, #popupUpload, #popupEditar, #popupExcluirPasta{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:99999;
}

.popBox{
  background:white;
  padding:25px;
  border-radius:12px;
  border:1px solid var(--border);
  width:90%;
  max-width:380px;
}

/* PR√âVIA DE UPLOAD */
#previewArea img{
  width:60px;
  height:60px;
  object-fit:cover;
  border-radius:8px;
  margin:4px;
  border:1px solid var(--border);
}

/* Overlay carregando */
#overlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.75);
  display:none;
  justify-content:center;
  align-items:center;
  font-size:20px;
  color:var(--primary);
  z-index:999999;
}

/* MENU MOVER */
#moveMenu{
  position:fixed;
  right:-380px;
  top:0;
  width:300px;
  height:100%;
  background:white;
  border-left:1px solid var(--border);
  box-shadow:-6px 0 18px rgba(0,0,0,.12);
  padding:22px;
  transition:.35s ease;
  z-index:99999;
}

#moveMenu.open{ right:0; }

.movePasta{
  padding:10px 12px;
  border:1px solid var(--border);
  background:white;
  border-radius:10px;
  margin-bottom:10px;
  cursor:pointer;
  font-size:14px;
  display:flex;
  align-items:center;
  gap:10px;
}
.movePasta:hover{
  background:#f2f4ff;
}
</style>
</head>

<body>

<!-- =============== OVERLAY =============== -->
<div id="overlay">Enviando...</div>

<!-- =============== CONTAINER =============== -->
<div id="container">

  <h1 id="titulo">Gerenciador de Documentos</h1>

  <input id="busca" placeholder="Pesquisar documentos..." onkeyup="pesquisar()">

  <div id="breadcrumbs">üìÅ Raiz</div>

  <div class="toolbar">
    <button class="btn btn-nova" onclick="abrirPopupCriar()">üìÅ Nova Pasta</button>
    <button class="btn btn-upload" onclick="abrirUpload()">‚¨Ü Upload</button>
    <button id="btnVoltar" class="btn btn-voltar" onclick="voltarPasta()">‚¨Ö Voltar</button>
  </div>

<div id="actionBar">
  <button class="btn btn-nova" onclick="moverEmMassa()">Mover Selecionados</button>
  <button class="btn" style="background:#d9534f;color:white;" onclick="excluirEmMassa()">Excluir Selecionados</button>
  <button class="btn btn-voltar" onclick="limparSelecao()">Cancelar</button>
</div>


  <div id="lista" class="grid"></div>

</div>

<!-- ================= POPUP CRIAR PASTA ================= -->
<div id="popupCriar">
<div class="popBox">
  <h3>Criar Pasta</h3>
  <input id="nomePasta" placeholder="Nome da pasta" style="width:100%;padding:12px;border-radius:10px;">
  <button class="btn btn-nova" style="width:100%;margin-top:15px;" onclick="criarPasta()">Criar</button>
  <button class="btn btn-voltar" style="width:100%;margin-top:10px;" onclick="fecharPopupCriar()">Cancelar</button>
</div>
</div>

<!-- ================= POPUP EDITAR PASTA ================= -->
<div id="popupEditar">
<div class="popBox">
  <h3>Renomear pasta</h3>
  <input id="novoNome" style="width:100%;padding:12px;border-radius:10px;">
  <button class="btn btn-nova" style="width:100%;margin-top:15px;" onclick="salvarEditar()">Salvar</button>
  <button class="btn btn-voltar" style="width:100%;margin-top:10px;" onclick="fecharEditar()">Cancelar</button>
</div>
</div>

<!-- ================= POPUP EXCLUIR PASTA ================= -->
<div id="popupExcluirPasta">
<div class="popBox">
  <h3>Excluir Pasta?</h3>
  <p>Isso excluir√° TODOS os arquivos dentro dela.</p>
  <button class="btn" style="background:#d9534f;color:white;width:100%;" onclick="confirmarExcluirPasta()">Excluir</button>
  <button class="btn btn-voltar" style="width:100%;margin-top:10px;" onclick="fecharExcluirPasta()">Cancelar</button>
</div>
</div>

<!-- ================= POPUP UPLOAD ================= -->
<div id="popupUpload">
<div class="popBox">
  <h3>Enviar Arquivo</h3>

  <select id="uploadDestino" style="width:100%;padding:10px;border-radius:10px;margin-top:8px;"></select>

  <div id="dropArea" style="margin-top:10px;padding:20px;border:2px dashed var(--text-light);border-radius:10px;text-align:center;cursor:pointer;">
    Arraste arquivos aqui<br>ou clique
  </div>

  <div id="previewArea" style="display:flex;flex-wrap:wrap;margin-top:10px;"></div>

  <input id="uploadInput" type="file" multiple style="display:none">

  <button onclick="enviarUpload()" class="btn btn-upload" style="width:100%;margin-top:20px;">Enviar</button>
  <button onclick="fecharUpload()" class="btn btn-voltar" style="width:100%;margin-top:10px;">Cancelar</button>
</div>
</div>

<!-- ============== MODAL VISUALIZA√á√ÉO ============== -->
<div id="modal">
<div id="modalBox">

  <button onclick="fecharModal()" class="btn btn-voltar" style="float:right;">Fechar</button>

  <h2 id="modalTitulo" style="margin-top:0;"></h2>

  <iframe id="modalPreview"></iframe>

  <div class="modal-buttons">
    <button onclick="baixarArquivo()" class="btn btn-upload">‚¨á Download</button>
    <button onclick="abrirMover()" class="btn btn-nova">üìÅ Mover</button>
    <button onclick="excluirArquivo()" class="btn" style="background:#d9534f;color:white;">üóë Excluir</button>
  </div>

</div>
</div>

<!-- ======================= MENU LATERAL: MOVER ARQUIVO ======================= -->
<div id="moveMenu">
  <h3 style="margin-top:0;color:var(--primary);">Mover para...</h3>

  <input id="buscaMover" placeholder="Pesquisar pasta..."
         style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);">

  <div id="listaMover" style="margin-top:12px;max-height:65vh;overflow-y:auto;"></div>

  <button class="btn btn-voltar" style="width:100%;margin-top:15px;" onclick="fecharMover()">
    Cancelar
  </button>
</div>

<!-- ======================= SCRIPT PRINCIPAL ======================= -->
<script>

/* ====================== SUPABASE ====================== */
const SUPABASE_URL  = "https://mblvyircwsaxaslklzky.supabase.co";
const SUPABASE_KEY  = "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ====================== VARI√ÅVEIS ====================== */
let usuario = localStorage.getItem("usuarioEmail") || "desconhecido";
let pastaAtual = null;
let historicoPastas = [];
let dadosPastas = [];
let dadosDocs = [];
let linkAtual = "";
let arquivoAtualID = null;
let pastaEditarID = null;
let pastaExcluirID = null;

/* ====================== INICIALIZAR ====================== */
window.onload = () => {
  renderSkeleton();
  carregarTudo();
};

/* ====================== SKELETON ====================== */
function renderSkeleton(){
  let html = "";
  for(let i=0;i<10;i++) html += `<div class="skeleton"></div>`;
  lista.innerHTML = html;
}

/* ====================== CARREGAR TUDO ====================== */
async function carregarTudo(){
  const p = await sb.from("pastas").select("*");
  dadosPastas = p.data || [];

  const d = await sb.from("documentos").select("*");
  dadosDocs = d.data || [];

  preencherDestinoUpload();
  mostrarPasta(pastaAtual);
}

/* ===========================================================
   VISUALIZAR PASTAS E ARQUIVOS
=========================================================== */
function mostrarPasta(id){

  // ‚õî Impede duplicar a mesma pasta consecutivamente no hist√≥rico
  if (historicoPastas[historicoPastas.length - 1] !== id) {
      historicoPastas.push(id);
  }

  pastaAtual = id;

  // Esconde bot√£o voltar se estiver na raiz
  btnVoltar.style.display = (id === null) ? "none" : "inline-block";

  let nome = id ? dadosPastas.find(x=>x.id===id)?.nome : "Raiz";
  breadcrumbs.innerHTML = "üìÅ " + nome;

  const pastas = dadosPastas.filter(p=>p.pai_id === id);
  const docs   = dadosDocs.filter(d=>d.pasta_id === id);

  let html = "";

  /* PASTAS */
  pastas.forEach(p=>{
    const prev = dadosDocs.filter(x=>x.pasta_id===p.id).slice(0,3);
    let mini = "";
    prev.forEach(a=> mini+=`<img class="mini" src="${a.url}">`);

    html += `
      <div class="item">
        <div onclick="entrarPasta('${p.id}')">
          <div class="folder-preview">
            <img src="https://img.icons8.com/fluency/96/folder-invoices.png" class="icon-folder">
            ${mini}
          </div>
          <div class="itemNome">${p.nome}</div>
        </div>

        <div style="margin-top:6px;display:flex;justify-content:center;gap:6px;">
          <button onclick="abrirEditar('${p.id}','${p.nome}')" class="btn" style="padding:4px 8px;font-size:11px;">‚úèÔ∏è</button>
          <button onclick="abrirExcluirPasta('${p.id}','${p.nome}')" class="btn" style="padding:4px 8px;font-size:11px;background:#d9534f;color:white;">üóë</button>
        </div>
      </div>
    `;
  });

  /* ARQUIVOS */
 docs.forEach(d=>{
  html += `
    <div class="item" style="position:relative;">
      
      <input type="checkbox" class="selectBox" onchange="atualizarSelecao('${d.id}', this.checked)">
      
      <button class="moreBtn" onclick="abrirArquivo('${d.nome}','${d.url}','${d.id}')">‚ãÆ</button>

      <div onclick="abrirArquivo('${d.nome}','${d.url}','${d.id}')">
        ${thumbDoc(d)}
        <div class="itemNome">${d.nome}</div>
      </div>

    </div>
  `;
});


  lista.innerHTML = html || "<p style='padding:20px;'>Vazio.</p>";
}


function thumbDoc(doc){
  let ext = doc.nome.split(".").pop().toLowerCase();
  const img = ["jpg","jpeg","png","gif","webp"];

  if(img.includes(ext)) {
    return `<img class="thumb" src="${doc.url}">`;
  }

  // √çcone profissional para PDF
  if(ext === "pdf"){
    return `
      <img class="thumb" 
           src="https://img.icons8.com/color/96/pdf.png" 
           style="object-fit:contain;background:white;">
    `;
  }

  // Padr√£o
  return `<div class="file-icon"></div>`;
}


/* ENTRAR */
function entrarPasta(id){
  mostrarPasta(id);
}

function voltarPasta(){
  if (historicoPastas.length <= 1) {
    pastaAtual = null;
    historicoPastas = [null];
    mostrarPasta(null);
    return;
  }

  // Remove a atual
  historicoPastas.pop();

  // √öltima pasta v√°lida
  const destino = historicoPastas[historicoPastas.length - 1];

  pastaAtual = destino;
  mostrarPasta(destino);
}


/* ===========================================================
   CRIAR PASTA
=========================================================== */
function abrirPopupCriar(){ popupCriar.style.display="flex"; }
function fecharPopupCriar(){ popupCriar.style.display="none"; nomePasta.value=""; }

async function criarPasta(){
  const nome = nomePasta.value.trim();
  if(!nome){ alert("Digite um nome."); return; }

  await sb.from("pastas").insert({
    nome,
    pai_id:pastaAtual,
    criado_por:usuario
  });

  fecharPopupCriar();
  carregarTudo();
}

/* ===========================================================
   EDITAR PASTA
=========================================================== */
function abrirEditar(id,nome){
  pastaEditarID = id;
  novoNome.value = nome;
  popupEditar.style.display="flex";
}
function fecharEditar(){ popupEditar.style.display="none"; }

async function salvarEditar(){
  const nome = novoNome.value.trim();
  if(!nome){ alert("Digite um nome."); return; }

  await sb.from("pastas").update({nome}).eq("id",pastaEditarID);
  fecharEditar();
  carregarTudo();
}

/* ===========================================================
   EXCLUIR PASTA
=========================================================== */
function abrirExcluirPasta(id){
  if(!id){ alert("A pasta raiz n√£o pode ser exclu√≠da."); return; }

  pastaExcluirID = id;
  popupExcluirPasta.style.display="flex";
}

function fecharExcluirPasta(){ popupExcluirPasta.style.display="none"; }

async function confirmarExcluirPasta(){
  await sb.from("documentos").delete().eq("pasta_id",pastaExcluirID);
  await sb.from("pastas").delete().eq("id",pastaExcluirID);

  fecharExcluirPasta();
  carregarTudo();
}

/* ===========================================================
   UPLOAD
=========================================================== */
function abrirUpload(){ popupUpload.style.display="flex"; }
function fecharUpload(){
  popupUpload.style.display="none";
  previewArea.innerHTML = "";
}

function preencherDestinoUpload(){
  uploadDestino.innerHTML = "";
  dadosPastas.forEach(p=>{
    uploadDestino.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
  });
}

dropArea.onclick = ()=> uploadInput.click();

/* PR√âVIA */
uploadInput.onchange = e => mostrarPreview(e.target.files);

function mostrarPreview(files){
  previewArea.innerHTML = "";
  for(const file of files){
    let reader = new FileReader();
    reader.onload = e=>{
      previewArea.innerHTML += `<img src="${e.target.result}">`;
    };
    reader.readAsDataURL(file);
  }
}

/* DRAG & DROP */
dropArea.ondragover = e=>{ e.preventDefault(); dropArea.classList.add("dragover"); };
dropArea.ondragleave = ()=> dropArea.classList.remove("dragover");
dropArea.ondrop = e=>{
  e.preventDefault();
  dropArea.classList.remove("dragover");
  uploadInput.files = e.dataTransfer.files;
  mostrarPreview(e.dataTransfer.files);
};

/* ENVIAR */
async function enviarUpload(){
  const files = uploadInput.files;
  if(files.length===0){ alert("Selecione arquivos."); return; }

  const destino = uploadDestino.value;
  overlay.style.display="flex";

  for(const file of files){
    const caminho = Date.now()+"_"+file.name;
    await sb.storage.from("documentos").upload(caminho, file, {
    contentType: file.type,
    upsert: false
});


    const url = `${SUPABASE_URL}/storage/v1/object/public/documentos/${caminho}`;

    await sb.from("documentos").insert({
      pasta_id:destino,
      nome:file.name,
      tipo:file.type,
      tamanho:file.size,
      url,
      criado_por:usuario
    });
  }

  overlay.style.display="none";
  fecharUpload();
  carregarTudo();
}

/* ===========================================================
   ARQUIVOS
=========================================================== */
let arquivoAtualNome = "";

function extrairPath(url) {
    // Obt√©m apenas o nome do arquivo
    return url.split("/documentos/")[1];
}

async function abrirArquivo(nome, url, id) {

    modalTitulo.innerText = nome;
    arquivoAtualID = id;
    arquivoAtualNome = nome;
    linkAtual = url;

    const path = extrairPath(url); // agora correto

    const { data, error } = await sb.storage
        .from("documentos")
        .createSignedUrl(path, 120);

    if (error || !data) {
        console.log(error);
        alert("Erro ao gerar visualiza√ß√£o");
        return;
    }

    modalPreview.src = data.signedUrl;
    modal.style.display = "flex";
}



function fecharModal(){ modal.style.display="none"; }

async function baixarArquivo() {

  // Sanitiza o nome
  let nome = arquivoAtualNome.replace(/[^\w\-\.]+/g, "_");

  // Extrai o caminho completo relativo dentro do bucket
  const path = linkAtual.split("/documentos/")[1];

  // Cria URL assinada com cabe√ßalho correto
  const { data, error } = await sb.storage
    .from("documentos")
    .createSignedUrl(path, 60, { download: nome });

  if (error) {
    alert("Erro ao preparar download");
    return;
  }

  // For√ßa o download com nome correto
  const a = document.createElement("a");
  a.href = data.signedUrl;
  a.download = nome;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

let selecionados = [];

/* Atualiza itens selecionados */
function atualizarSelecao(id, marcado) {
    if (marcado) {
        selecionados.push(id);
    } else {
        selecionados = selecionados.filter(x => x !== id);
    }

    atualizarActionBar();
}

/* Mostra/Esconde barra superior */
function atualizarActionBar() {
    if (selecionados.length > 0) {
        actionBar.style.display = "flex";
    } else {
        actionBar.style.display = "none";
    }
}

/* Limpa sele√ß√£o */
function limparSelecao() {
    selecionados = [];
    document.querySelectorAll(".selectBox").forEach(c => c.checked = false);
    atualizarActionBar();
}

/* EXCLUIR EM MASSA */
async function excluirEmMassa() {
    if (!confirm("Excluir os itens selecionados?")) return;

    for (let id of selecionados) {
        await sb.from("documentos").delete().eq("id", id);
    }

    limparSelecao();
    carregarTudo();
}

/* MOVER EM MASSA */
function moverEmMassa() {
    if (selecionados.length === 0) return;
    abrirMover(); // abre painel lateral
}

async function moverEmMassaPara(destinoID) {
    for (let id of selecionados) {
        await sb.from("documentos").update({ pasta_id: destinoID }).eq("id", id);
    }

    limparSelecao();
    fecharMover();
    carregarTudo();
}





async function excluirArquivo(){
  if(!confirm("Excluir arquivo?")) return;

  await sb.from("documentos").delete().eq("id",arquivoAtualID);
  fecharModal();
  carregarTudo();
}

/* ===========================================================
   MOVER ARQUIVO (PAINEL LATERAL)
=========================================================== */
function abrirMover(){
  montarListaMover();
  moveMenu.classList.add("open");
}

function fecharMover(){
  moveMenu.classList.remove("open");
}

function montarListaMover(){
  listaMover.innerHTML = "";
  dadosPastas.forEach(p=>{
    listaMover.innerHTML += `
      <div class="movePasta" onclick="moverPara('${p.id}')">
        üìÅ ${p.nome}
      </div>
    `;
  });
}

buscaMover.onkeyup = ()=>{
  let q = buscaMover.value.toLowerCase().trim();
  listaMover.innerHTML = "";

  dadosPastas
    .filter(p=>p.nome.toLowerCase().includes(q))
    .forEach(p=>{
      listaMover.innerHTML += `
        <div class="movePasta" onclick="moverPara('${p.id}')">
          üìÅ ${p.nome}
        </div>
      `;
    });
};

async function gerarThumbPrivada(path) {
  const { data } = await sb.storage
      .from("documentos")
      .createSignedUrl(path, 120);

  return data?.signedUrl || "";
}


async function moverPara(destinoID){
  await sb.from("documentos")
          .update({ pasta_id: destinoID })
          .eq("id", arquivoAtualID);

  fecharMover();
  fecharModal();
  carregarTudo();
}


/* ===========================================================
   BUSCA GLOBAL
=========================================================== */
function pesquisar(){
  let q = busca.value.toLowerCase().trim();

  if(!q){
    mostrarPasta(pastaAtual);
    return;
  }

  let resultados = [
    ...dadosPastas.filter(p=>p.nome.toLowerCase().includes(q)),
    ...dadosDocs.filter(d=>d.nome.toLowerCase().includes(q))
  ];

  let html = "";

  resultados.forEach(item=>{
    if(item.capa){
      html += `
        <div class="item" onclick="entrarPasta('${item.id}')">
          <div class="folder-preview">
            <img src="https://img.icons8.com/fluency/96/folder-invoices.png" class="icon-folder">
          </div>
          <div class="itemNome">${item.nome}</div>
        </div>`;
    } else {
      html += `
        <div class="item" onclick="abrirArquivo('${item.nome}','${item.url}','${item.id}')">
          ${thumbDoc(item)}
          <div class="itemNome">${item.nome}</div>
        </div>`;
    }
  });

  lista.innerHTML = html || "<p>Nenhum resultado.</p>";
  breadcrumbs.innerHTML = "üîç Resultados da busca";
}
document.addEventListener("keydown", function(e){

  if (e.key !== "Escape") return;

  // 1) Se modal estiver aberto ‚Üí fecha modal
  if (modal.style.display === "flex") {
    fecharModal();
    return;
  }

  // 2) Se popup de criar pasta estiver aberto
  if (popupCriar.style.display === "flex") {
    fecharPopupCriar();
    return;
  }

  // 3) Se popup editar estiver aberto
  if (popupEditar.style.display === "flex") {
    fecharEditar();
    return;
  }

  // 4) Popup excluir pasta
  if (popupExcluirPasta.style.display === "flex") {
    fecharExcluirPasta();
    return;
  }

  // 5) Popup upload
  if (popupUpload.style.display === "flex") {
    fecharUpload();
    return;
  }

  // 6) Menu mover
  if (moveMenu.classList.contains("open")) {
    fecharMover();
    return;
  }

  // 7) Caso nada disso esteja aberto ‚Üí voltar pasta
  voltarPasta();
});



</script>

</body>
</html>

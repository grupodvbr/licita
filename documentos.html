<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Gerenciador de Documentos</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ===========================================================
   GERENCIADOR DE DOCUMENTOS ‚Ä¢ MODO LISTA (PREMIUM)
=========================================================== */

:root{
  --bg:#f2f4f8;
  --card:#ffffff;
  --border:#e2e8f0;

  --text:#0f172a;
  --text-light:#475569;
  --muted:#94a3b8;

  --primary:#0b1e39;
  --primary-hover:#1e335d;

  --danger:#dc2626;

  --radius-lg:16px;
  --radius-md:12px;
  --radius-sm:8px;

  --shadow-sm:0 1px 4px rgba(15,23,42,.06);
  --shadow-md:0 6px 20px rgba(15,23,42,.08);
}

/* RESET */
*{
  box-sizing:border-box;
  font-family:Inter, system-ui, sans-serif;
}

body{
  margin:0;
  padding:24px;
  background:var(--bg);
  color:var(--text);
  display:flex;
  justify-content:center;
}

/* ===========================================================
   CONTAINER
=========================================================== */
#container{
  width:100%;
  max-width:1400px;
  background:var(--card);
  border-radius:var(--radius-lg);
  padding:24px 26px 28px;
  border:1px solid var(--border);
  box-shadow:var(--shadow-md);
}

/* ===========================================================
   T√çTULO
=========================================================== */
#titulo{
  text-align:center;
  margin:0 0 18px;
  font-size:26px;
  font-weight:700;
  color:var(--primary);
}

/* ===========================================================
   BUSCA
=========================================================== */
#busca{
  width:100%;
  padding:14px 16px;
  border-radius:var(--radius-md);
  border:1px solid var(--border);
  background:#f8fafc;
  font-size:14px;
}

#busca:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 4px rgba(11,30,57,.15);
  background:white;
}

/* ===========================================================
   BREADCRUMB
=========================================================== */
#breadcrumbs{
  margin:14px 0 10px;
  font-size:14px;
  font-weight:600;
  color:var(--primary);
}

/* ===========================================================
   TOOLBAR
=========================================================== */
#toolbarWrap{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  margin-bottom:16px;
}

.toolbarLeft{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

#actionBar{
  display:none;
  gap:10px;
}

/* ===========================================================
   BOT√ïES
=========================================================== */
.btn{
  border:none;
  border-radius:var(--radius-md);
  padding:10px 16px;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
  transition:.2s;
}

.btn-nova{
  background:var(--primary);
  color:white;
}
.btn-nova:hover{ background:var(--primary-hover); }

.btn-upload{
  background:#334155;
  color:white;
}

.btn-voltar{
  background:#e5e7eb;
}

/* ===========================================================
   GRID ‚Üí LISTA
=========================================================== */
.grid{
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* ===========================================================
   ITEM (LINHA)
=========================================================== */
.item{
  display:grid;
  grid-template-columns: 40px 56px 1fr auto;
  align-items:center;
  gap:14px;

  background:white;
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  padding:12px 14px;
  box-shadow:var(--shadow-sm);
  transition:.2s;
  cursor:pointer;
}

.item:hover{
  background:#f8fafc;
  box-shadow:var(--shadow-md);
}

/* ===========================================================
   CHECKBOX
=========================================================== */
.selectBox{
  width:18px;
  height:18px;
  cursor:pointer;
  accent-color:var(--primary);
}

/* ===========================================================
   THUMB / √çCONE
=========================================================== */
.thumb,
.file-icon,
.icon-folder{
  width:42px;
  height:42px;
  border-radius:10px;
  object-fit:cover;
}

.file-icon{
  background:#e5e7eb;
}

/* ===========================================================
   PASTA (PREVIEW)
=========================================================== */
.folder-preview{
  position:relative;
  width:42px;
  height:42px;
}

.folder-preview img{
  width:100%;
  height:100%;
}

.folder-preview .mini{
  display:none; /* lista fica limpa */
}

/* ===========================================================
   NOME
=========================================================== */
.itemNome{
  font-size:14px;
  font-weight:600;
  color:var(--text);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* ===========================================================
   MENU 3 PONTOS
=========================================================== */
.moreBtn{
  background:none;
  border:none;
  font-size:20px;
  cursor:pointer;
  color:var(--muted);
}

.moreBtn:hover{ color:var(--primary); }

.optionsMenu{
  position:absolute;
  background:white;
  border:1px solid var(--border);
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
  width:160px;
  padding:6px 0;
  z-index:9999;
}

.optionsMenu button{
  width:100%;
  padding:10px 14px;
  background:none;
  border:none;
  text-align:left;
  font-size:14px;
  cursor:pointer;
  color:var(--text-light);
}

.optionsMenu button:hover{
  background:#f1f5f9;
  color:var(--primary);
}

/* ===========================================================
   MODAL
=========================================================== */
#modal{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.45);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}

#modalBox{
  background:white;
  width:90%;
  max-width:700px;
  padding:22px;
  border-radius:var(--radius-lg);
}

#modalPreview{
  width:100%;
  height:380px;
  border-radius:12px;
  border:1px solid var(--border);
}

/* ===========================================================
   POPUPS
=========================================================== */
#popupCriar,
#popupUpload,
#popupEditar,
#popupExcluirPasta{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.45);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:99999;
}

.popBox{
  background:white;
  padding:24px;
  border-radius:16px;
  width:90%;
  max-width:380px;
}

/* ===========================================================
   OVERLAY
=========================================================== */
#overlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.75);
  display:none;
  justify-content:center;
  align-items:center;
  font-size:18px;
  font-weight:600;
  color:var(--primary);
  z-index:999999;
}

/* ===========================================================
   MENU LATERAL (MOVER)
=========================================================== */
#moveMenu{
  position:fixed;
  top:0;
  right:-340px;
  width:320px;
  height:100%;
  background:white;
  border-left:1px solid var(--border);
  padding:22px;
  box-shadow:-20px 0 40px rgba(0,0,0,.15);
  transition:.35s;
  z-index:99999;
}

#moveMenu.open{ right:0; }

.movePasta{
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:10px;
  margin-bottom:10px;
  cursor:pointer;
}

.movePasta:hover{
  background:#f1f5f9;
  border-color:var(--primary);
}
/* ===========================================================
   MODO LISTA APENAS PARA ARQUIVOS (DENTRO DA PASTA)
=========================================================== */

/* Arquivos viram lista */
.item:has(.selectBox){
  display:grid;
  grid-template-columns: 32px 60px 1fr 32px;
  align-items:center;
  gap:12px;

  padding:12px 14px;
  text-align:left;
}

/* Remove comportamento de card nos arquivos */
.item:has(.selectBox):hover{
  transform:none;
}

/* Miniatura menor */
.item:has(.selectBox) .thumb,
.item:has(.selectBox) .file-icon{
  width:46px;
  height:46px;
  border-radius:8px;
  margin:0;
}

/* Nome do arquivo: MOSTRA TUDO */
.item:has(.selectBox) .itemNome{
  white-space:normal;      /* quebra linha */
  overflow:visible;
  text-overflow:unset;
  line-height:1.4;
  font-size:14px;
  font-weight:600;
  color:#0f172a;
}

/* Checkbox alinhado */
.item:has(.selectBox) .selectBox{
  position:static;
}

/* Bot√£o 3 pontos alinhado */
.item:has(.selectBox) .moreBtn{
  position:static;
  font-size:18px;
}

/* Remove espa√ßamento vertical desnecess√°rio */
.item:has(.selectBox) > div{
  margin:0;
}

/* Pastas continuam IGUAIS (grid/card) */
.item:not(:has(.selectBox)){
  display:block;
}

</style>
</head>

<body>

<!-- =============== OVERLAY =============== -->
<div id="overlay">Enviando...</div>

<!-- =============== CONTAINER =============== -->
<div id="container">

  <h1 id="titulo">Gerenciador de Documentos</h1>

  <input id="busca" placeholder="Pesquisar documentos..." onkeyup="pesquisar()">

  <div id="breadcrumbs">üìÅ Raiz</div>

 <div id="toolbarWrap">

  <div class="toolbarLeft">
    <button class="btn btn-nova" onclick="abrirPopupCriar()">üìÅ Nova Pasta</button>
    <button class="btn btn-upload" onclick="abrirUpload()">‚¨Ü Upload</button>
    <button id="btnVoltar" class="btn btn-voltar" onclick="voltarPasta()">‚¨Ö Voltar</button>
  </div>

  <div id="actionBar">
    <button class="btn btn-nova" onclick="moverEmMassa()">Mover Selecionados</button>
    <button class="btn" style="background:#d9534f;color:white;" onclick="excluirEmMassa()">Excluir Selecionados</button>
    <button class="btn btn-voltar" onclick="limparSelecao()">Cancelar</button>
  </div>

</div>


  <div id="lista" class="grid"></div>

</div>

<!-- ================= POPUP CRIAR PASTA ================= -->
<div id="popupCriar">
<div class="popBox">
  <h3>Criar Pasta</h3>
  <input id="nomePasta" placeholder="Nome da pasta" style="width:100%;padding:12px;border-radius:10px;">
  <button class="btn btn-nova" style="width:100%;margin-top:15px;" onclick="criarPasta()">Criar</button>
  <button class="btn btn-voltar" style="width:100%;margin-top:10px;" onclick="fecharPopupCriar()">Cancelar</button>
</div>
</div>

<!-- ================= POPUP EDITAR PASTA ================= -->
<div id="popupEditar">
<div class="popBox">
  <h3>Renomear pasta</h3>
  <input id="novoNome" style="width:100%;padding:12px;border-radius:10px;">
  <button class="btn btn-nova" style="width:100%;margin-top:15px;" onclick="salvarEditar()">Salvar</button>
  <button class="btn btn-voltar" style="width:100%;margin-top:10px;" onclick="fecharEditar()">Cancelar</button>
</div>
</div>

<!-- ================= POPUP EXCLUIR PASTA ================= -->
<div id="popupExcluirPasta">
<div class="popBox">
  <h3>Excluir Pasta?</h3>
  <p>Isso excluir√° TODOS os arquivos dentro dela.</p>
  <button class="btn" style="background:#d9534f;color:white;width:100%;" onclick="confirmarExcluirPasta()">Excluir</button>
  <button class="btn btn-voltar" style="width:100%;margin-top:10px;" onclick="fecharExcluirPasta()">Cancelar</button>
</div>
</div>

<!-- ================= POPUP UPLOAD ================= -->
<div id="popupUpload">
<div class="popBox">
  <h3>Enviar Arquivo</h3>

  <select id="uploadDestino" style="width:100%;padding:10px;border-radius:10px;margin-top:8px;"></select>

  <div id="dropArea" style="margin-top:10px;padding:20px;border:2px dashed var(--text-light);border-radius:10px;text-align:center;cursor:pointer;">
    Arraste arquivos aqui<br>ou clique
  </div>

  <div id="previewArea" style="display:flex;flex-wrap:wrap;margin-top:10px;"></div>

  <input id="uploadInput" type="file" multiple style="display:none">

  <button onclick="enviarUpload()" class="btn btn-upload" style="width:100%;margin-top:20px;">Enviar</button>
  <button onclick="fecharUpload()" class="btn btn-voltar" style="width:100%;margin-top:10px;">Cancelar</button>
</div>
</div>
<!-- ========== POPUP RENOMEAR ARQUIVO ========== -->
<div id="popupRename" style="
  position:fixed;inset:0;background:rgba(0,0,0,.35);
  display:none;justify-content:center;align-items:center;z-index:999999;">
  
  <div class="popBox">
    <h3>Nome inv√°lido</h3>
    <p style="font-size:14px;color:#444;">
      O nome do arquivo n√£o pode conter acentos ou espa√ßos.<br>
      Renomeie abaixo:
    </p>

    <input id="renameInput" 
           style="width:100%;padding:12px;border-radius:10px;margin-top:10px;">

    <button onclick="confirmarRename()" 
            class="btn btn-nova" style="width:100%;margin-top:15px;">
      Confirmar
    </button>

    <button onclick="cancelarRename()" 
            class="btn btn-voltar" style="width:100%;margin-top:10px;">
      Cancelar
    </button>
  </div>
</div>

<!-- ============== MODAL VISUALIZA√á√ÉO ============== -->
<div id="modal">
<div id="modalBox">

  <button onclick="fecharModal()" class="btn btn-voltar" style="float:right;">Fechar</button>

  <h2 id="modalTitulo" style="margin-top:0;"></h2>

  <iframe id="modalPreview"></iframe>

  <div class="modal-buttons">
    <button onclick="baixarArquivo()" class="btn btn-upload">‚¨á Download</button>
    <button onclick="abrirMover()" class="btn btn-nova">üìÅ Mover</button>
    <button onclick="excluirArquivo()" class="btn" style="background:#d9534f;color:white;">üóë Excluir</button>
  </div>

</div>
</div>

<!-- ======================= MENU LATERAL: MOVER ARQUIVO ======================= -->
<div id="moveMenu">
  <h3 style="margin-top:0;color:var(--primary);">Mover para...</h3>

  <input id="buscaMover" placeholder="Pesquisar pasta..."
         style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);">

  <div id="listaMover" style="margin-top:12px;max-height:65vh;overflow-y:auto;"></div>

  <button class="btn btn-voltar" style="width:100%;margin-top:15px;" onclick="fecharMover()">
    Cancelar
  </button>
</div>

<!-- ======================= SCRIPT PRINCIPAL ======================= -->
<script>

/* ====================== SUPABASE ====================== */
const SUPABASE_URL  = "https://mblvyircwsaxaslklzky.supabase.co";
const SUPABASE_KEY  = "sb_publishable_oN2CuBzXHaUF7NHYS_M7aw_tBqVeD-x";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ====================== VARI√ÅVEIS ====================== */
let usuario = localStorage.getItem("usuarioEmail") || "desconhecido";
let pastaAtual = null;
let historicoPastas = [];
let dadosPastas = [];
let dadosDocs = [];
let linkAtual = "";
let arquivoAtualID = null;
let pastaEditarID = null;
let pastaExcluirID = null;

/* ====================== INICIALIZAR ====================== */
window.onload = () => {
  renderSkeleton();
  carregarTudo();
};

/* ====================== SKELETON ====================== */
function renderSkeleton(){
  let html = "";
  for(let i=0;i<10;i++) html += `<div class="skeleton"></div>`;
  lista.innerHTML = html;
}

/* ====================== CARREGAR TUDO ====================== */
async function carregarTudo(){
  const p = await sb.from("pastas").select("*");
  dadosPastas = p.data || [];

  const d = await sb.from("documentos").select("*");
  dadosDocs = d.data || [];

  preencherDestinoUpload();
  mostrarPasta(pastaAtual);
}


function miniIcon(doc) {
    let ext = doc.nome.split(".").pop().toLowerCase();

    // IMAGENS
    if (["jpg","jpeg","png","gif","webp"].includes(ext)) {
        return `<img class="mini" src="${doc.url}">`;
    }

    // PDF
    if (ext === "pdf") {
        return `<img class="mini" src="https://img.icons8.com/color/48/pdf.png">`;
    }

    // EXCEL
    if (ext === "xlsx" || ext === "xls") {
        return `<img class="mini" src="https://img.icons8.com/color/48/ms-excel.png">`;
    }

    // WORD
    if (ext === "doc" || ext === "docx") {
        return `<img class="mini" src="https://img.icons8.com/color/48/ms-word.png">`;
    }

    // OUTROS
    return `<img class="mini" src="https://img.icons8.com/ios-filled/50/document.png">`;
}


/* ===========================================================
   VISUALIZAR PASTAS E ARQUIVOS
=========================================================== */
function mostrarPasta(id){

  // ‚õî Impede duplicar a mesma pasta consecutivamente no hist√≥rico
  if (historicoPastas[historicoPastas.length - 1] !== id) {
      historicoPastas.push(id);
  }

  pastaAtual = id;

  // Esconde bot√£o voltar se estiver na raiz
  btnVoltar.style.display = (id === null) ? "none" : "inline-block";

  let nome = id ? dadosPastas.find(x=>x.id===id)?.nome : "Raiz";
  breadcrumbs.innerHTML = "üìÅ " + nome;

  const pastas = dadosPastas.filter(p=>p.pai_id === id);
  const docs   = dadosDocs.filter(d=>d.pasta_id === id);

  let html = "";

  /* PASTAS */
  pastas.forEach(p=>{
    const prev = dadosDocs.filter(x=>x.pasta_id===p.id).slice(0,3);
    let mini = "";
    prev.forEach(a => mini += miniIcon(a));

    html += `
      <div class="item">
        <div onclick="entrarPasta('${p.id}')">
          <div class="folder-preview">
            <img src="https://img.icons8.com/fluency/96/folder-invoices.png" class="icon-folder">
            ${mini}
          </div>
          <div class="itemNome">${p.nome}</div>
        </div>

        <div style="margin-top:6px;display:flex;justify-content:center;gap:6px;">
          <button onclick="abrirEditar('${p.id}','${p.nome}')" class="btn" style="padding:4px 8px;font-size:11px;">‚úèÔ∏è</button>
          <button onclick="abrirExcluirPasta('${p.id}','${p.nome}')" class="btn" style="padding:4px 8px;font-size:11px;background:#d9534f;color:white;">üóë</button>
        </div>
      </div>
    `;
  });

  /* ARQUIVOS */
 docs.forEach(d=>{
  html += `
    <div class="item" style="position:relative;">
      
      <input type="checkbox" class="selectBox" onchange="atualizarSelecao('${d.id}', this.checked)">
      
      <button class="moreBtn" onclick="abrirMenu(event,'${d.id}')">‚ãÆ</button>
<div class="optionsMenu" id="menu-${d.id}">
  <button onclick="event.stopImmediatePropagation(); renomearArquivo('${d.id}')">‚úèÔ∏è Renomear</button>
  <button onclick="event.stopImmediatePropagation(); abrirMoverDireto('${d.id}')">üìÅ Mover</button>
  <button onclick="event.stopImmediatePropagation(); excluirDireto('${d.id}')">üóë Excluir</button>
</div>



      <div onclick="abrirArquivo('${d.nome}','${d.url}','${d.id}')">
        ${thumbDoc(d)}
        <div class="itemNome">${d.nome}</div>
      </div>

    </div>
  `;
});


  lista.innerHTML = html || "<p style='padding:20px;'>Vazio.</p>";
}
/* ============================
   RENOMEAR ARQUIVO
============================ */

function renomearArquivo(id) {
    let doc = dadosDocs.find(d => d.id == id);
    if (!doc) {
        alert("Arquivo n√£o encontrado.");
        return;
    }

    // Remove a extens√£o
    let partes = doc.nome.split(".");
    let ext = partes.pop();
    let nomeSemExt = partes.join(".");

    let novoNome = prompt("Novo nome do arquivo:", nomeSemExt);

    if (!novoNome || novoNome.trim() === "") {
        return; // cancelou
    }

    // Regras: remover acentos e espa√ßos
    novoNome = novoNome
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/ /g, "_")
        .replace(/[^\w\-]/g, "_");

    let nomeFinal = novoNome + "." + ext;

    sb.from("documentos")
        .update({ nome: nomeFinal })
        .eq("id", id)
        .then(({ error }) => {
            if (error) {
                console.log(error);
                alert("Erro ao renomear arquivo.");
                return;
            }

            carregarTudo(); // atualizar tela
        });
}


function thumbDoc(doc){
  let ext = doc.nome.split(".").pop().toLowerCase();
  const img = ["jpg","jpeg","png","gif","webp"];

  // IMAGENS
  if (img.includes(ext)) {
    return `<img class="thumb" src="${doc.url}">`;
  }

  // PDF
  if (ext === "pdf") {
    return `
      <img class="thumb" 
           src="https://img.icons8.com/color/96/pdf.png" 
           style="object-fit:contain;background:white;">
    `;
  }

  // EXCEL (xlsx, xls)
  if (ext === "xlsx" || ext === "xls") {
    return `
      <img class="thumb" 
           src="https://img.icons8.com/color/96/ms-excel.png" 
           style="object-fit:contain;background:white;">
    `;
  }

  // OUTROS FORMATOS
  return `<div class="file-icon"></div>`;
}



/* ENTRAR */
function entrarPasta(id){
  mostrarPasta(id);
}

function voltarPasta(){
  if (historicoPastas.length <= 1) {
    pastaAtual = null;
    historicoPastas = [null];
    mostrarPasta(null);
    return;
  }

  // Remove a atual
  historicoPastas.pop();

  // √öltima pasta v√°lida
  const destino = historicoPastas[historicoPastas.length - 1];

  pastaAtual = destino;
  mostrarPasta(destino);
}


/* ===========================================================
   CRIAR PASTA
=========================================================== */
function abrirPopupCriar(){ popupCriar.style.display="flex"; }
function fecharPopupCriar(){ popupCriar.style.display="none"; nomePasta.value=""; }

async function criarPasta(){
  const nome = nomePasta.value.trim();
  if(!nome){ alert("Digite um nome."); return; }

  await sb.from("pastas").insert({
    nome,
    pai_id:pastaAtual,
    criado_por:usuario
  });

  fecharPopupCriar();
  carregarTudo();
}

/* ===========================================================
   EDITAR PASTA
=========================================================== */
function abrirEditar(id,nome){
  pastaEditarID = id;
  novoNome.value = nome;
  popupEditar.style.display="flex";
}
function fecharEditar(){ popupEditar.style.display="none"; }

async function salvarEditar(){
  const nome = novoNome.value.trim();
  if(!nome){ alert("Digite um nome."); return; }

  await sb.from("pastas").update({nome}).eq("id",pastaEditarID);
  fecharEditar();
  carregarTudo();
}

/* ===========================================================
   EXCLUIR PASTA
=========================================================== */
function abrirExcluirPasta(id){
  if(!id){ alert("A pasta raiz n√£o pode ser exclu√≠da."); return; }

  pastaExcluirID = id;
  popupExcluirPasta.style.display="flex";
}

function fecharExcluirPasta(){ popupExcluirPasta.style.display="none"; }

async function confirmarExcluirPasta(){
  await sb.from("documentos").delete().eq("pasta_id",pastaExcluirID);
  await sb.from("pastas").delete().eq("id",pastaExcluirID);

  fecharExcluirPasta();
  carregarTudo();
}

/* ===========================================================
   UPLOAD
=========================================================== */
function abrirUpload(){ popupUpload.style.display="flex"; }
function fecharUpload(){
  popupUpload.style.display="none";
  previewArea.innerHTML = "";
}

function preencherDestinoUpload(){
  uploadDestino.innerHTML = "";
  dadosPastas.forEach(p=>{
    uploadDestino.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
  });
}

dropArea.onclick = ()=> uploadInput.click();
/* ========= DRAG & DROP CORRIGIDO ========== */

// Permite que arquivos sejam arrastados sobre a p√°gina inteira
window.addEventListener("dragover", e => e.preventDefault());
window.addEventListener("drop", e => e.preventDefault());

// DRAG & DROP CORRIGIDO
dropArea.addEventListener("dragover", e => {
    e.preventDefault();
    dropArea.style.background = "#eef2ff";
    dropArea.style.borderColor = "#0b1e39";
});

dropArea.addEventListener("dragleave", e => {
    dropArea.style.background = "";
    dropArea.style.borderColor = "var(--text-light)";
});

dropArea.addEventListener("drop", e => {
    e.preventDefault();

    dropArea.style.background = "";
    dropArea.style.borderColor = "var(--text-light)";

    let files = e.dataTransfer.files;

    if (!files || files.length === 0) return;

    // Converte FileList ‚Üí FileList REAL com DataTransfer
    const dt = new DataTransfer();
    for (let file of files) dt.items.add(file);

    uploadInput.files = dt.files;

    validarArquivos(dt.files);
});
function abrirMenu(event, id) {
  event.stopPropagation(); // impede abrir o arquivo junto

  document.querySelectorAll(".optionsMenu").forEach(m => m.style.display = "none");

  let menu = document.getElementById("menu-" + id);
  menu.style.display = "block";

  // Fecha se clicar fora
  document.addEventListener("click", () => {
    menu.style.display = "none";
  }, { once: true });
}
function abrirMoverDireto(id) {
  arquivoAtualID = id;
  abrirMover();
}
function excluirDireto(id) {
  if (!confirm("Deseja excluir este arquivo?")) return;

  sb.from("documentos")
    .delete()
    .eq("id", id)
    .then(() => carregarTudo());
}



/* ==============================
   REGRAS DE NOMES PERMITIDOS
============================== */

let arquivoOriginal = null;
let arquivoCorrigir = null;
let extensaoCorrigir = null;

function nomeValido(nomeOriginal) {

  // Nomes proibidos: espa√ßos, acentos, √ß, caracteres especiais
  const regexProibido = /[^A-Za-z0-9_\-\.]/;

  return !regexProibido.test(nomeOriginal);
}


/* ==============================
   QUANDO O USU√ÅRIO ESCOLHE ARQUIVO
============================== */
uploadInput.onchange = e => validarArquivos(e.target.files);

function validarArquivos(files) {
  previewArea.innerHTML = "";
  arquivoOriginal = null;
  arquivoCorrigir = null;

  for (const file of files) {
    const name = file.name;
    const ext = name.split(".").pop();
    const nameWithoutExt = name.replace("." + ext, "");

    let nomeSemEspaco = nameWithoutExt.replace(/ /g, "_");
    let nomeSemAcento = nomeSemEspaco.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

   if (!nomeValido(name)) {
      arquivoCorrigir = file;
      extensaoCorrigir = ext;
      renameInput.value = nomeSemAcento;
      popupRename.style.display = "flex";
      return;
    }

// Mostra pr√©via dependendo do tipo
if (file.type.startsWith("image/")) {

    // IMAGEM ‚Üí mostra a miniatura
    let reader = new FileReader();
    reader.onload = ev => {
        previewArea.innerHTML += `<img src="${ev.target.result}">`;
    };
    reader.readAsDataURL(file);

} else if (file.type === "application/pdf") {

    // PDF ‚Üí mostra √≠cone de PDF
    previewArea.innerHTML += `
        <img src="https://img.icons8.com/color/96/pdf.png" 
             style="width:60px;height:60px;object-fit:contain;border-radius:8px;border:1px solid var(--border);margin:4px;">
    `;

} else {

    // OUTROS FORMATOS ‚Üí √≠cone gen√©rico
    previewArea.innerHTML += `
        <div style="
            width:60px;height:60px;background:#ececec;
            border-radius:8px;margin:4px;display:flex;
            align-items:center;justify-content:center;
            border:1px solid var(--border);font-size:12px;color:#555;
        ">${file.name.split('.').pop().toUpperCase()}</div>
    `;

}
  }

  arquivoOriginal = files;
}

/* ==============================
   POPUP: RENOMEAR
============================== */
renameInput.oninput = () => {
  let txt = renameInput.value;
  txt = txt.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  txt = txt.replace(/ /g, "_");
  txt = txt.replace(/[^\w\-]+/g, "_");
  renameInput.value = txt;
};

function cancelarRename() {
  popupRename.style.display = "none";
  uploadInput.value = "";
  previewArea.innerHTML = "";
  arquivoCorrigir = null;
  arquivoOriginal = null;
}


function confirmarRename() {
  const novoNome = renameInput.value.trim();
  if (!novoNome) {
    alert("Digite um nome v√°lido.");
    return;
  }

  const novoArquivo = new File([arquivoCorrigir], novoNome + "." + extensaoCorrigir, {
    type: arquivoCorrigir.type
  });

  popupRename.style.display = "none";
  uploadInput.files = fileListFromArray([novoArquivo]);
  validarArquivos(uploadInput.files);
}

function fileListFromArray(files) {
  const dt = new DataTransfer();
  files.forEach(f => dt.items.add(f));
  return dt.files;
}


/* ENVIAR */
async function enviarUpload(){
  const files = uploadInput.files;
  if(files.length===0){ alert("Selecione arquivos."); return; }

  const destino = uploadDestino.value;
  overlay.style.display="flex";

  for(const file of files){
    const caminho = Date.now()+"_"+file.name;
    await sb.storage.from("documentos").upload(caminho, file, {
    contentType: file.type,
    upsert: false
});


    const url = `${SUPABASE_URL}/storage/v1/object/public/documentos/${caminho}`;

    await sb.from("documentos").insert({
      pasta_id:destino,
      nome:file.name,
      tipo:file.type,
      tamanho:file.size,
      url,
      criado_por:usuario
    });
  }

  overlay.style.display="none";
  fecharUpload();
  carregarTudo();
}

/* ===========================================================
   ARQUIVOS
=========================================================== */
let arquivoAtualNome = "";

function extrairPath(url) {
    // Obt√©m apenas o nome do arquivo
    return url.split("/documentos/")[1];
}

async function abrirArquivo(nome, url, id) {

    modalTitulo.innerText = nome;
    arquivoAtualID = id;
    arquivoAtualNome = nome;
    linkAtual = url;

    const path = extrairPath(url); // agora correto

    const { data, error } = await sb.storage
        .from("documentos")
        .createSignedUrl(path, 120);

    if (error || !data) {
        console.log(error);
        alert("Erro ao gerar visualiza√ß√£o");
        return;
    }

    if (nome.toLowerCase().endsWith(".pdf")) {

    // preview nativa de PDF
    modalPreview.src = data.signedUrl;

} else if (
    nome.toLowerCase().endsWith(".xlsx") ||
    nome.toLowerCase().endsWith(".xls")
) {

    // Visualiza√ß√£o pelo Office Viewer
    const encoded = encodeURIComponent(data.signedUrl);
    modalPreview.src = `https://view.officeapps.live.com/op/embed.aspx?src=${encoded}`;

} else {
    // Outros arquivos ‚Üí download autom√°tico ou mensagem
    modalPreview.src = data.signedUrl;
}

    modal.style.display = "flex";
}



function fecharModal(){ modal.style.display="none"; }

async function baixarArquivo() {

  // Sanitiza o nome
  let nome = arquivoAtualNome.replace(/[^\w\-\.]+/g, "_");

  // Extrai o caminho completo relativo dentro do bucket
  const path = linkAtual.split("/documentos/")[1];

  // Cria URL assinada com cabe√ßalho correto
  const { data, error } = await sb.storage
    .from("documentos")
    .createSignedUrl(path, 60, { download: nome });

  if (error) {
    alert("Erro ao preparar download");
    return;
  }

  // For√ßa o download com nome correto
  const a = document.createElement("a");
  a.href = data.signedUrl;
  a.download = nome;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

let selecionados = [];

/* Atualiza itens selecionados */
function atualizarSelecao(id, marcado) {
    if (marcado) {
        selecionados.push(id);
    } else {
        selecionados = selecionados.filter(x => x !== id);
    }

    atualizarActionBar();
}

/* Mostra/Esconde barra superior */
function atualizarActionBar() {
    if (selecionados.length > 0) {
        actionBar.style.display = "flex";
    } else {
        actionBar.style.display = "none";
    }
}

/* Limpa sele√ß√£o */
function limparSelecao() {
    selecionados = [];
    document.querySelectorAll(".selectBox").forEach(c => c.checked = false);
    atualizarActionBar();
}

/* EXCLUIR EM MASSA */
async function excluirEmMassa() {
    if (!confirm("Excluir os itens selecionados?")) return;

    for (let id of selecionados) {
        await sb.from("documentos").delete().eq("id", id);
    }

    limparSelecao();
    carregarTudo();
}

/* MOVER EM MASSA */
function moverEmMassa() {
    if (selecionados.length === 0) return;
    abrirMover(); // abre painel lateral
}

async function moverEmMassaPara(destinoID) {
    for (let id of selecionados) {
        await sb.from("documentos").update({ pasta_id: destinoID }).eq("id", id);
    }

    limparSelecao();
    fecharMover();
    carregarTudo();
}





async function excluirArquivo(){
  if(!confirm("Excluir arquivo?")) return;

  await sb.from("documentos").delete().eq("id",arquivoAtualID);
  fecharModal();
  carregarTudo();
}

/* ===========================================================
   MOVER ARQUIVO (PAINEL LATERAL)
=========================================================== */
function abrirMover(){
  montarListaMover();
  moveMenu.classList.add("open");
}

function fecharMover(){
  moveMenu.classList.remove("open");
}

function montarListaMover(){
  listaMover.innerHTML = "";
  dadosPastas.forEach(p=>{
    listaMover.innerHTML += `
      <div class="movePasta" onclick="moverPara('${p.id}')">
        üìÅ ${p.nome}
      </div>
    `;
  });
}

buscaMover.onkeyup = ()=>{
  let q = buscaMover.value.toLowerCase().trim();
  listaMover.innerHTML = "";

  dadosPastas
    .filter(p=>p.nome.toLowerCase().includes(q))
    .forEach(p=>{
      listaMover.innerHTML += `
        <div class="movePasta" onclick="moverPara('${p.id}')">
          üìÅ ${p.nome}
        </div>
      `;
    });
};

async function gerarThumbPrivada(path) {
  const { data } = await sb.storage
      .from("documentos")
      .createSignedUrl(path, 120);

  return data?.signedUrl || "";
}


async function moverPara(destinoID){
  await sb.from("documentos")
          .update({ pasta_id: destinoID })
          .eq("id", arquivoAtualID);

  fecharMover();
  fecharModal();
  carregarTudo();
}


/* ===========================================================
   BUSCA GLOBAL
=========================================================== */
function pesquisar(){
  let q = busca.value.toLowerCase().trim();

  if(!q){
    mostrarPasta(pastaAtual);
    return;
  }

  let resultados = [
    ...dadosPastas.filter(p=>p.nome.toLowerCase().includes(q)),
    ...dadosDocs.filter(d=>d.nome.toLowerCase().includes(q))
  ];

  let html = "";

  resultados.forEach(item=>{
    if(item.capa){
      html += `
        <div class="item" onclick="entrarPasta('${item.id}')">
          <div class="folder-preview">
            <img src="https://img.icons8.com/fluency/96/folder-invoices.png" class="icon-folder">
          </div>
          <div class="itemNome">${item.nome}</div>
        </div>`;
    } else {
      html += `
        <div class="item" onclick="abrirArquivo('${item.nome}','${item.url}','${item.id}')">
          ${thumbDoc(item)}
          <div class="itemNome">${item.nome}</div>
        </div>`;
    }
  });

  lista.innerHTML = html || "<p>Nenhum resultado.</p>";
  breadcrumbs.innerHTML = "üîç Resultados da busca";
}
document.addEventListener("keydown", function(e){

  if (e.key !== "Escape") return;

  // 1) Se modal estiver aberto ‚Üí fecha modal
  if (modal.style.display === "flex") {
    fecharModal();
    return;
  }

  // 2) Se popup de criar pasta estiver aberto
  if (popupCriar.style.display === "flex") {
    fecharPopupCriar();
    return;
  }

  // 3) Se popup editar estiver aberto
  if (popupEditar.style.display === "flex") {
    fecharEditar();
    return;
  }

  // 4) Popup excluir pasta
  if (popupExcluirPasta.style.display === "flex") {
    fecharExcluirPasta();
    return;
  }

  // 5) Popup upload
  if (popupUpload.style.display === "flex") {
    fecharUpload();
    return;
  }

  // 6) Menu mover
  if (moveMenu.classList.contains("open")) {
    fecharMover();
    return;
  }

  // 7) Caso nada disso esteja aberto ‚Üí voltar pasta
  voltarPasta();
});



</script>

</body>
</html>
